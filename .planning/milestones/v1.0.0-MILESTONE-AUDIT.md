# Milestone Audit: v1.0.0 â€” Dotfiles Stack Migration

**Date:** 2026-02-08
**Auditor:** Claude (gsd-verifier)
**Status:** passed (with documentation discrepancy noted)

## Executive Summary

All 15 v1 requirements have been addressed by completed phases. 25 plans across 6 phases were executed in 3.10 hours. The migration from Nix/Dotbot/asdf to chezmoi/mise/Homebrew is functionally complete with artifacts verified in the codebase. One documentation discrepancy found: REQUIREMENTS.md checkboxes for SECU-01 through SECU-04 were not ticked despite work being complete (traceability table also still shows "Pending"). MISE-03 was correctly deferred to v2.

## Requirements Coverage

| Requirement | Phase | Status | Evidence |
|-------------|-------|--------|----------|
| PREP-01: Backup current dotfiles | 1 | PASS | `scripts/backup-dotfiles.sh` (434 lines) exists with rsync, exclusions, pre-flight checks. User verified on external drive. Phase 1 VERIFICATION.md: passed (4/4). |
| PREP-02: Emergency recovery scripts | 1 | PASS | `scripts/restore-dotfiles.sh` (287 lines) exists with interactive category-based restore. User verified prompts work. Phase 1 VERIFICATION.md: passed. |
| PREP-03: Linux test environment | 1 | PASS | `scripts/test-linux.sh` (244 lines) + `.docker/Dockerfile.dotfiles-test` (52 lines, Ubuntu 24.04) exist. User verified container builds/starts. |
| CHEM-01: chezmoi init + migrate symlinks | 2 | PASS | chezmoi source at `~/.local/share/chezmoi/` contains 28+ files: `dot_zshrc`, `dot_zshenv`, `dot_zprofile`, `dot_zsh.d/` (15 files), `dot_gitconfig`, etc. User verified shell works in new terminal (273 aliases loaded). 02-04-SUMMARY confirms `chezmoi verify` exit code 0. |
| CHEM-02: OS detection templating | 3 | PASS | `dot_zsh.d/path.zsh.tmpl` uses `{{ if eq .chezmoi.os "darwin" }}` for macOS-specific Homebrew paths. `.chezmoi.yaml.tmpl` computes `osid` from `.chezmoi.os` and `.chezmoi.osRelease.id`. Verified on Linux (03-04-SUMMARY: 0 macOS paths in Linux output). |
| CHEM-03: Machine-specific templating | 3 | PASS | `.chezmoi.yaml.tmpl` prompts for `machine_type` (client/personal/server). `private_dot_gitconfig_local.tmpl` uses `{{ if eq .machine_type "client" }}` for email selection. Phase 3 VERIFICATION.md: 4/5 passed (1 human_needed for Linux repeat testing, which was subsequently confirmed in Phase 3 checkpoint). |
| CHEM-04: Template tool configurations | 3 | PASS | Git config templated (`private_dot_gitconfig_local.tmpl` with Bitwarden integration), mise config templated (`private_dot_config/mise/config.toml.tmpl`), Brewfile templated (`dot_Brewfile.tmpl`), path config templated (`dot_zsh.d/path.zsh.tmpl`). |
| PKGM-01: Automated Homebrew via run_onchange | 4 | PASS | `run_once_before_install-homebrew.sh.tmpl` (Homebrew bootstrap), `run_onchange_after_01-install-packages.sh.tmpl` (uses SHA256 hash of .chezmoidata.yaml for change detection), `run_onchange_after_02-cleanup-packages.sh.tmpl`, `dot_Brewfile.tmpl` (generates ~/.Brewfile from .chezmoidata.yaml). 04-04-SUMMARY confirms `brew bundle check --global` passes. |
| PKGM-02: Consolidate Brewfiles into .chezmoidata | 4 | PASS | `.chezmoidata.yaml` (298 lines) contains all packages: 13 taps, 87 common_brews, 22 common_casks, 8 client_brews, 28 client_casks, 8 fanaka_brews, 43 fanaka_casks, 7 fonts, 2+8 MAS apps. Single source of truth replacing 3 separate Brewfiles. |
| PKGM-03: Remove Nix completely | 4 | PASS | `nix-config/` directory does not exist in repository. `path.zsh.tmpl` contains zero nix references. `run_once_after_remove-nix-references.sh.tmpl` provides manual system cleanup instructions. grep for nix-config/nix-darwin/home-manager found references only in `.planning/` documentation and `steps/terminal.yml` migration notes. |
| MISE-01: Install mise, migrate .tool-versions, remove asdf | 5 | PASS | `private_dot_config/mise/config.toml.tmpl` defines 7 runtimes (node lts, python 3.12, go 1.22, rust stable, java temurin-25, ruby 3, terraform 1.9). `~/.local/share/mise/installs/` contains all 7 runtime directories. asdf reference in hooks.zsh is commented out. Phase 5 VERIFICATION.md: passed (5/5). |
| MISE-02: mise env var management | 5 | PASS | `config.toml.tmpl` contains `[env]` section for global environment variables. `hooks.zsh` line 12: `eval "$(mise activate zsh)"`. `external.zsh` line 65: `eval "$(mise activate zsh)"`. Phase 5 VERIFICATION confirmed mise doctor reports "activated: yes". |
| MISE-03: mise task runner | v2 | DEFERRED | Correctly moved to v2 requirements in REQUIREMENTS.md. Not in Phase 5 scope. |
| SECU-01: Bitwarden secret templating | 6 | PASS | `.chezmoi.yaml.tmpl` contains `bitwarden: command: "bw"`. `private_dot_gitconfig_local.tmpl` uses `bitwarden "item"` and `bitwardenFields "item"` template functions for name/email. `.chezmoidata.yaml` documents naming convention (dotfiles/shared, dotfiles/client, dotfiles/personal). 06-04-SUMMARY confirms template syntax validated. |
| SECU-02: age encryption for sensitive files | 6 | PASS | `.chezmoi.yaml.tmpl` configures `encryption: "age"` with per-machine identity path. `private_dot_ssh/` contains 4 encrypted files (`encrypted_private_*.age`). `~/.config/age/key-personal.txt` exists with 600 permissions. 06-03-SUMMARY confirms all decryption round-trips pass. |
| SECU-03: Pre-commit hooks with gitleaks | 6 | PASS | `.gitleaks.toml` (41 lines) with chezmoi template allowlists. `.pre-commit-config.yaml` exists. `private_dot_config/git/hooks/executable_pre-commit` (warn-only, exit 0) and `executable_pre-push` (blocking, exit 1) deployed. `~/.config/git/hooks/pre-commit` and `pre-push` are executable. `dot_gitconfig` line 100: `hooksPath = ~/.config/git/hooks`. 06-01-SUMMARY: 0 secrets found in 32-commit scan. |
| SECU-04: File permission hardening | 6 | PASS | `run_after_10-verify-permissions.sh.tmpl` (85 lines) runs on every `chezmoi apply`, checks 13 sensitive file patterns (SSH keys 600, GPG 700, cloud creds 600, age keys 600, etc.), cross-platform stat command detection, audit logging to `~/.local/state/chezmoi/permission-fixes.log`. 06-02-SUMMARY confirms all current files already at correct permissions. |

**Coverage Summary:**
- v1 requirements: 15 in scope (MISE-03 correctly deferred to v2)
- PASS: 15/15
- FAIL: 0
- PARTIAL: 0

## Cross-Phase Integration

### Phase 1 -> Phase 2: Backups before migration
**Status: PASS**
Phase 1 created backup infrastructure (scripts/backup-dotfiles.sh, scripts/restore-dotfiles.sh, scripts/verify-backup.sh) before Phase 2 began any chezmoi migration. User verified backup on external drive before proceeding. Recovery path tested.

### Phase 2 -> Phase 3: chezmoi source for templating
**Status: PASS**
Phase 2 established chezmoi source directory (`~/.local/share/chezmoi/`) with core shell files. Phase 3 added templates on top of this foundation: `.chezmoi.yaml.tmpl` (config with prompts), `private_dot_gitconfig_local.tmpl` (machine-specific email), `dot_zsh.d/path.zsh.tmpl` (OS-specific paths). All template files live within the chezmoi source directory created in Phase 2.

### Phase 3 -> Phase 4: Templates for package management
**Status: PASS**
Phase 3 created `.chezmoidata.yaml` structure. Phase 4 populated it with all package lists (171+ packages). Phase 4's `dot_Brewfile.tmpl` uses Phase 3's template variables (`.packages.darwin.common_brews`, `.machine_type`) to generate machine-specific Brewfiles. The `run_onchange_after_01-install-packages.sh.tmpl` uses SHA256 hash of `.chezmoidata.yaml` for change detection.

### Phase 4 -> Phase 5: Homebrew packages for mise
**Status: PASS**
Phase 4 included `mise` in `common_brews` (confirmed in `.chezmoidata.yaml` line 72). Phase 5 then configured mise with `private_dot_config/mise/config.toml.tmpl` and shell activation in `hooks.zsh`. Phase 5 also removed conflicting Homebrew runtimes (rbenv, rust, volta) from `.chezmoidata.yaml` with comments explaining mise manages them.

### Phase 5 -> Phase 6: mise + packages for security
**Status: PASS**
Phase 6 added security tools (age, bitwarden-cli, gitleaks, pre-commit) to `.chezmoidata.yaml` common_brews (confirmed in file). These tools were installed via the Phase 4 Homebrew automation. Phase 6 then used these tools to implement security features (age encryption, Bitwarden integration, gitleaks scanning).

### Phase 3 -> Phase 6: Templates for secrets
**Status: PASS**
Phase 6's `private_dot_gitconfig_local.tmpl` uses Phase 3's template infrastructure (`.machine_type` variable from `.chezmoi.yaml.tmpl`) combined with Bitwarden template functions. The `.chezmoi.yaml.tmpl` was extended with age encryption config and bitwarden command config.

## End-to-End Flows

### 1. Fresh Machine Setup: chezmoi init -> apply -> all tools installed
**Status: PASS (with prerequisite)**

Flow verified:
1. `run_once_before_install-homebrew.sh.tmpl` bootstraps Homebrew if missing (macOS only)
2. `.chezmoi.yaml.tmpl` prompts for machine_type, email, generates config
3. `dot_Brewfile.tmpl` generates machine-specific `~/.Brewfile` from `.chezmoidata.yaml`
4. `run_onchange_after_01-install-packages.sh.tmpl` runs `brew bundle --global --verbose`
5. `run_onchange_after_02-cleanup-packages.sh.tmpl` handles package removal
6. `run_once_after_generate-mise-completions.sh.tmpl` sets up mise completions
7. `run_after_10-verify-permissions.sh.tmpl` verifies sensitive file permissions
8. All shell files deployed: `.zshrc`, `.zshenv`, `.zprofile`, `zsh.d/*.zsh`, `.gitconfig`

**Prerequisite:** User must have age key available (from Bitwarden) to decrypt SSH keys. Without it, `chezmoi apply` will fail on encrypted files. The bootstrap chain is: Bitwarden -> age key -> SSH keys -> full access.

### 2. Secret Management: Bitwarden -> age key -> SSH keys -> git access
**Status: PASS**

Flow verified:
1. `.chezmoi.yaml.tmpl` configures `bitwarden: command: "bw"` and `encryption: "age"`
2. Age identity path uses `{{ .machine_type }}` template: `~/.config/age/key-{{ .machine_type }}.txt`
3. 4 SSH private keys encrypted with age in `private_dot_ssh/encrypted_private_*.age`
4. SSH public keys and config stored unencrypted in `private_dot_ssh/`
5. `private_dot_gitconfig_local.tmpl` sources name/email from Bitwarden vault
6. `run_after_10-verify-permissions.sh.tmpl` ensures SSH keys get 600 permissions
7. `.chezmoiignore` excludes `.config/age/**` (age key never in chezmoi source)

### 3. Package Management: edit .chezmoidata.yaml -> chezmoi apply -> packages installed
**Status: PASS**

Flow verified:
1. `.chezmoidata.yaml` is the single source of truth (298 lines, all packages)
2. `dot_Brewfile.tmpl` generates `~/.Brewfile` using chezmoi template ranges
3. `run_onchange_after_01-install-packages.sh.tmpl` hash line: `{{ include ".chezmoidata.yaml" | sha256sum }}` triggers re-run on data change
4. Script runs `brew bundle --global --verbose` to install
5. `run_onchange_after_02-cleanup-packages.sh.tmpl` logs removed packages

### 4. Tool Version Switching: mise use -> runtime available
**Status: PASS**

Flow verified:
1. `private_dot_config/mise/config.toml.tmpl` defines 7 global runtimes
2. `dot_zsh.d/hooks.zsh` line 12: `if command -v mise > /dev/null; then eval "$(mise activate zsh)"; fi`
3. `dot_zsh.d/external.zsh` line 65: `eval "$(mise activate zsh)"`
4. `~/.local/share/mise/installs/` contains all 7 runtime directories (node, python, go, rust, java, ruby, terraform)
5. Settings enable `not_found_auto_install` and `exec_auto_install` for automatic tool installation
6. Phase 5 VERIFICATION confirmed: 10 node version calls in 0.152s

### 5. Security: commit -> gitleaks scan -> warn/block
**Status: PASS**

Flow verified:
1. `dot_gitconfig` line 100: `hooksPath = ~/.config/git/hooks` directs all repos to global hooks
2. `~/.config/git/hooks/pre-commit` (executable, 823 bytes): scans with gitleaks, warns but allows commit (exit 0)
3. `~/.config/git/hooks/pre-push` (executable, 762 bytes): scans with gitleaks, blocks push on detection (exit 1)
4. Both hooks delegate to repo-local `.git/hooks/{name}` if present (pre-commit framework compatible)
5. `.gitleaks.toml` allowlists chezmoi template syntax to prevent false positives
6. `.pre-commit-config.yaml` in chezmoi source provides additional scanning for the dotfiles repo itself
7. 06-01-SUMMARY: full repository scan found 0 secrets in 32 commits

## Known Issues / Tech Debt

### Documentation Discrepancy (Low Priority)
REQUIREMENTS.md checkboxes for SECU-01 through SECU-04 are unticked ([ ]) and the traceability table shows them as "Pending", despite the work being complete. The ROADMAP.md correctly shows Phase 6 as complete. The `Last updated` line says "after Phase 5 completion" -- it was not updated after Phase 6.

### Deferred Requirements
- **MISE-03** (mise task runner): Correctly deferred to v2. Not blocking v1.

### Known Limitations (from Phase Summaries)
1. **Phantom and firebase-cli broken:** These Homebrew packages have shebangs pointing to removed Homebrew node. Workaround: error suppression in completions.zsh. Not blocking -- tools can work via mise's node when called directly.
2. **Shell startup time:** 0.87s vs aspirational <300ms. Pre-existing, not caused by migration. Dominated by plugin loading, not mise.
3. **Nix system cleanup deferred:** `/nix` synthetic firmlink on macOS requires `sudo` + reboot to remove. Instructions provided in `run_once_after_remove-nix-references.sh.tmpl`.
4. **Bitwarden session required:** `chezmoi apply` requires `BW_SESSION` environment variable for templates using Bitwarden functions. Without it, encrypted files and Bitwarden-templated files will fail.
5. **Dual mise activation:** `hooks.zsh` (line 12) and `external.zsh` (line 65) both call `eval "$(mise activate zsh)"`. This is redundant but not harmful (mise handles double-activation gracefully).
6. **Many files still in .chezmoiignore:** Editor configs (nvim), terminal emulator configs (aerospace, kitty, ghostty, wezterm), tool configs (atuin, bat, btop, lsd, lazygit, karabiner, nushell), and ZSH plugin manager (zgenom) are excluded from chezmoi management. These remain managed by Dotbot.

### Phase Verification Coverage
| Phase | Formal VERIFICATION.md | Status |
|-------|----------------------|--------|
| 1 | Yes (01-VERIFICATION.md) | passed (4/4) |
| 2 | No (checkpoint in summary only) | User approved |
| 3 | Yes (03-VERIFICATION.md) | human_needed (4/5, 1 uncertain -- subsequently user-approved in checkpoint) |
| 4 | No (04-04-VERIFICATION-STEPS.md exists but is a steps doc, not formal verification) | User approved |
| 5 | Yes (05-VERIFICATION.md) | passed (5/5) |
| 6 | No (checkpoint in 06-05-SUMMARY only) | User approved all 5 success criteria |

## Verdict

**Status: passed**

All 15 v1 requirements have been met with artifacts verified in the codebase. Cross-phase integration is solid -- each phase builds on prior phases through shared data structures (`.chezmoidata.yaml`, `.chezmoi.yaml.tmpl`) and chezmoi's template system. All 5 end-to-end user workflows are complete and functional.

The sole discrepancy is that REQUIREMENTS.md was not updated to tick SECU-01 through SECU-04 checkboxes and update the traceability table -- a documentation oversight, not a functional gap.

The migration from Nix/Dotbot/asdf to chezmoi/mise/Homebrew is complete for v1 scope.

---
*Audited: 2026-02-08*
*Auditor: Claude (gsd-verifier)*
