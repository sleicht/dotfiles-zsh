# Requirements Archive: v2.0 Performance

**Archived:** 2026-02-14
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: v2.0 Performance

**Milestone:** v2.0 Performance
**Goal:** Achieve < 300ms shell startup time (currently 870ms)
**Date:** 2026-02-14

## Requirements

### PROF: Profiling & Baseline

| ID | Requirement | Priority | Traces To |
|----|------------|----------|-----------|
| PROF-01 | Establish baseline measurement using three-stage methodology (hyperfine, EPOCHREALTIME, zsh-bench) | Must | PERF-04 |
| PROF-02 | Add startup time self-monitoring that warns if shell startup exceeds 300ms | Should | PERF-04 |
| PROF-03 | Create smoke test script validating prompt styling, tool availability, and no double-loads | Should | All |

### QUICK: Quick Wins (No Architecture Change)

| ID | Requirement | Priority | Traces To |
|----|------------|----------|-----------|
| QUICK-01 | Remove duplicate zsh-autosuggestions and zsh-syntax-highlighting loads from hooks.zsh | Must | PERF-04 |
| QUICK-02 | Replace Ruby SSH config parsing in completions.zsh with pure-zsh implementation | Should | PERF-04 |
| QUICK-03 | Replace `command -v` guards with `(( $+commands[tool] ))` across all zsh.d files | Should | PERF-04 |
| QUICK-04 | Add `typeset -U PATH path FPATH fpath` for PATH deduplication | Should | PERF-04 |

### CACHE: Eval Caching Layer

| ID | Requirement | Priority | Traces To |
|----|------------|----------|-----------|
| CACHE-01 | Add evalcache (mroth/evalcache) as a Sheldon plugin, loaded before zsh-defer | Must | PERF-04 |
| CACHE-02 | Cache oh-my-posh init output via evalcache (must remain synchronous for prompt) | Must | PERF-04 |
| CACHE-03 | Cache zoxide, atuin, carapace, and intelli-shell init output via evalcache | Must | PERF-04 |
| CACHE-04 | Cache sheldon source output to file with timestamp-based invalidation | Should | PERF-04 |
| CACHE-05 | zcompile .zcompdump in background via .zlogin | Should | PERF-04 |
| CACHE-06 | Simplify compinit to always use `-C` (skip security check on cached dump) | Should | PERF-04 |

### LAZY: Sync/Defer Architecture Split

| ID | Requirement | Priority | Traces To |
|----|------------|----------|-----------|
| LAZY-01 | Split hooks.zsh into prompt.zsh (sync: oh-my-posh cached) and remove redundant sources | Must | PERF-04 |
| LAZY-02 | Split external.zsh into external-sync.zsh (FZF exports) and external-defer.zsh (zoxide, mise) | Must | PERF-04 |
| LAZY-03 | Update plugins.toml with dotfiles-sync and dotfiles-defer groups | Must | PERF-04 |
| LAZY-04 | Add `mise activate --shims` to .zprofile as immediate PATH fallback | Must | PERF-04 |
| LAZY-05 | Defer non-critical tools: ssh-add, intelli-shell, completion definitions (lens, wt, xlaude) | Should | PERF-04 |
| LAZY-06 | Split completions.zsh sync (zstyles) from defer (SSH hosts, autoloads) | Should | PERF-04 |

### PERF: Performance Target

| ID | Requirement | Priority | Traces To |
|----|------------|----------|-----------|
| PERF-01 | Achieve < 300ms wall-clock shell startup (hyperfine warm cache) | Must | Milestone goal |
| PERF-02 | Achieve < 50ms first-prompt lag (zsh-bench) | Should | Milestone goal |
| PERF-03 | Add chezmoi run_onchange_ hook to clear eval caches on tool version change | Should | CACHE-01 |
| PERF-04 | All existing shell functionality preserved (completions, keybindings, tool availability) | Must | All |

## Requirement Summary

| Category | Must | Should | Total |
|----------|------|--------|-------|
| PROF | 1 | 2 | 3 |
| QUICK | 1 | 3 | 4 |
| CACHE | 3 | 3 | 6 |
| LAZY | 3 | 3 | 6 |
| PERF | 2 | 2 | 4 |
| **Total** | **10** | **13** | **23** |

## Deferred (Not in v2.0 Scope)

| ID | Requirement | Rationale |
|----|------------|-----------|
| MISE-03 | Set up mise task runner for common development tasks | Separate concern from startup performance |

## Traceability

All requirements trace to the milestone goal of < 300ms shell startup time. Research backing:
- PROF requirements: [STACK-perf.md](research/STACK-perf.md) sec 4
- QUICK requirements: [PITFALLS-lazy-loading.md](research/PITFALLS-lazy-loading.md) sec 1, 13
- CACHE requirements: [STACK-perf.md](research/STACK-perf.md) sec 2, [FEATURES-perf.md](research/FEATURES-perf.md) sec 1
- LAZY requirements: [architecture-sheldon-defer.md](research/architecture-sheldon-defer.md) sec 4, 8
- PERF requirements: [SUMMARY-perf.md](research/SUMMARY-perf.md)

---
*Created: 2026-02-14*
