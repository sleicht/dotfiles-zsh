---
phase: 04-package-management-migration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - run_once_before_install-homebrew.sh.tmpl
  - run_onchange_after_01-install-packages.sh.tmpl
  - run_onchange_after_02-cleanup-packages.sh.tmpl
  - dot_Brewfile.tmpl
autonomous: true

must_haves:
  truths:
    - "Running chezmoi apply on a fresh macOS installs Homebrew automatically"
    - "Running chezmoi apply installs all packages from chezmoidata without manual intervention"
    - "Packages removed from chezmoidata are cleaned up from the system with audit log"
    - "A persistent ~/.Brewfile exists for manual brew bundle operations"
    - "Package scripts only re-run when chezmoidata package lists change"
  artifacts:
    - path: "run_once_before_install-homebrew.sh.tmpl"
      provides: "Homebrew bootstrap on fresh systems"
      contains: "curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh"
    - path: "run_onchange_before_install-packages.sh.tmpl"
      provides: "Automated package installation"
      contains: "brew bundle"
    - path: "run_onchange_after_cleanup-packages.sh.tmpl"
      provides: "Package cleanup with audit trail"
      contains: "brew bundle cleanup"
    - path: "dot_Brewfile.tmpl"
      provides: "Generated ~/.Brewfile for brew bundle --global"
      contains: "tap"
  key_links:
    - from: "run_onchange_before_install-packages.sh.tmpl"
      to: ".chezmoidata.yaml"
      via: "template ranges over .packages.darwin sections"
      pattern: "packages\\.darwin"
    - from: "dot_Brewfile.tmpl"
      to: ".chezmoidata.yaml"
      via: "template ranges over .packages.darwin sections"
      pattern: "packages\\.darwin"
    - from: "run_onchange_after_cleanup-packages.sh.tmpl"
      to: "dot_Brewfile.tmpl"
      via: "brew bundle cleanup --global reads ~/.Brewfile"
      pattern: "brew bundle cleanup --global"
---

<objective>
Create chezmoi run scripts and Brewfile template that automate Homebrew package installation, cleanup, and bootstrap on fresh systems.

Purpose: Transform the static Brewfiles into a dynamic, template-driven package management system that runs automatically during `chezmoi apply`. This is the core automation that makes "one-command bootstrap" possible.
Output: Four template files in chezmoi source directory — Homebrew bootstrap, package installer, package cleanup, and Brewfile template.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-package-management-migration/04-CONTEXT.md
@.planning/phases/04-package-management-migration/04-RESEARCH.md
@.planning/phases/04-package-management-migration/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Homebrew bootstrap and Brewfile template</name>
  <files>
    ~/.local/share/chezmoi/run_once_before_install-homebrew.sh.tmpl
    ~/.local/share/chezmoi/dot_Brewfile.tmpl
  </files>
  <action>
**1. Create `run_once_before_install-homebrew.sh.tmpl`**

Bootstrap Homebrew on fresh macOS systems. This runs ONCE (before other scripts).

```bash
{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -eufo pipefail

if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Configure Homebrew PATH for current session (Apple Silicon)
    if [[ $(uname -m) == "arm64" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    else
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi
{{ end -}}
```

Key details:
- Use `run_once_before_` prefix so it runs before package install scripts
- Wrap entire content in `{{ if eq .chezmoi.os "darwin" -}}` — Linux skips it
- Check `command -v brew` first — idempotent even as run_once_
- Handle both Apple Silicon (`/opt/homebrew`) and Intel (`/usr/local`) paths
- Use `set -eufo pipefail` for strict error handling

**2. Create `dot_Brewfile.tmpl`**

Generate `~/.Brewfile` from `.chezmoidata.yaml`. This file serves two purposes:
- Used by `brew bundle --global` for installation
- Provides a human-readable reference of all installed packages

Template structure:
```
{{ if eq .chezmoi.os "darwin" -}}
# Generated by chezmoi — do not edit manually
# Edit .chezmoidata.yaml in chezmoi source directory instead

# Taps
{{ range .packages.darwin.taps -}}
tap {{ . | quote }}
{{ end }}

# Formulae (common)
{{ range .packages.darwin.common_brews -}}
brew {{ . | quote }}
{{ end }}

# Formulae (machine-specific)
{{ if eq .machine_type "client" -}}
{{ range .packages.darwin.client_brews -}}
brew {{ . | quote }}
{{ end -}}
{{ else if eq .machine_type "fanaka" -}}
{{ range .packages.darwin.fanaka_brews -}}
brew {{ . | quote }}
{{ end -}}
{{ end }}

# Casks (common)
{{ range .packages.darwin.common_casks -}}
cask {{ . | quote }}
{{ end }}

# Casks (machine-specific)
{{ if eq .machine_type "client" -}}
{{ range .packages.darwin.client_casks -}}
cask {{ . | quote }}
{{ end -}}
{{ else if eq .machine_type "fanaka" -}}
{{ range .packages.darwin.fanaka_casks -}}
cask {{ . | quote }}
{{ end -}}
{{ end }}

# Fonts
{{ range .packages.darwin.fonts -}}
cask {{ . | quote }}
{{ end }}

# Mac App Store (common)
{{ range $name, $id := .packages.darwin.common_mas -}}
mas {{ $name | quote }}, id: {{ $id }}
{{ end }}

# Mac App Store (machine-specific)
{{ if eq .machine_type "fanaka" -}}
{{ range $name, $id := .packages.darwin.fanaka_mas -}}
mas {{ $name | quote }}, id: {{ $id }}
{{ end -}}
{{ end -}}
{{ end -}}
```

Key details:
- Use `dot_Brewfile.tmpl` — chezmoi renders this to `~/.Brewfile`
- Include header comment warning not to edit manually
- Use `{{ . | quote }}` for all package names (handles hyphens and special chars)
- Use `.machine_type` (from .chezmoi.yaml.tmpl data) to select machine-specific sections
- Include all sections: taps, common brews, machine brews, common casks, machine casks, fonts, common MAS, machine MAS
- On Linux (non-darwin), template outputs empty file
  </action>
  <verify>
Run `chezmoi diff` to see what files would be created. Run `chezmoi execute-template < ~/.local/share/chezmoi/dot_Brewfile.tmpl` and verify output is valid Brewfile syntax with correct package names. Verify the output contains taps, brews, casks, fonts, and MAS entries.
  </verify>
  <done>
Homebrew bootstrap script exists and will install Homebrew on fresh macOS. Brewfile template generates valid Brewfile with all packages from chezmoidata, correctly filtered by machine type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create package install and cleanup scripts</name>
  <files>
    ~/.local/share/chezmoi/run_onchange_before_install-packages.sh.tmpl
    ~/.local/share/chezmoi/run_onchange_after_cleanup-packages.sh.tmpl
  </files>
  <action>
**1. Create `run_onchange_before_install-packages.sh.tmpl`**

Installs all packages using `brew bundle --global` (reads `~/.Brewfile`). Uses `run_onchange_` so it only runs when package lists change.

```bash
{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# .chezmoidata.yaml packages hash: {{ include ".chezmoidata.yaml" | sha256sum }}
set -eufo pipefail

echo "==> Installing Homebrew packages..."
brew bundle --global --no-lock --verbose
echo "==> Homebrew package installation complete."
{{ end -}}
```

Key details:
- Use `run_onchange_before_` prefix — runs BEFORE file templates are applied, but only when content changes
- Include SHA256 hash of `.chezmoidata.yaml` as a comment — this makes the script content change whenever package lists change, triggering re-execution
- Use `brew bundle --global` which reads `~/.Brewfile` (generated by dot_Brewfile.tmpl)
- Use `--no-lock` to avoid creating Brewfile.lock
- Use `--verbose` for full output (per context decision: "Full Homebrew output shown during installation")
- The `before_` prefix ensures this runs BEFORE the cleanup script (which uses `after_`)
- Important: chezmoi processes `dot_Brewfile.tmpl` (creating `~/.Brewfile`) before running `run_onchange_before_` scripts because file templates are processed before scripts. Actually — chezmoi processes files alphabetically within each phase. Since `dot_Brewfile.tmpl` is a regular managed file, it will be applied as part of normal file processing, and `run_onchange_before_` scripts run before other scripts but AFTER file processing. This ordering ensures `~/.Brewfile` exists when `brew bundle --global` runs.

Wait — correction on chezmoi ordering: chezmoi applies files and runs scripts in a specific order. `run_before_` scripts run BEFORE any managed files are applied. This means `~/.Brewfile` would NOT exist yet. Solution: Use `run_onchange_after_` prefix instead for the install script, OR use the inline Brewfile pattern (pipe to stdin).

**Revised approach:** Use `run_onchange_after_install-packages.sh.tmpl` instead. The `after_` prefix ensures managed files (including `~/.Brewfile`) are applied first, THEN scripts run.

Alternatively, use the embedded Brewfile approach (Pattern 1 from research) — pipe inline Brewfile to brew bundle via stdin. This avoids the ordering issue entirely.

**Final decision:** Use `run_onchange_after_` prefix for the install script since we have `dot_Brewfile.tmpl` creating `~/.Brewfile`. This is cleaner than duplicating the Brewfile in the script.

```bash
{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# .chezmoidata.yaml packages hash: {{ include ".chezmoidata.yaml" | sha256sum }}
set -eufo pipefail

echo "==> Installing Homebrew packages..."
brew bundle --global --no-lock --verbose
echo "==> Homebrew package installation complete."
{{ end -}}
```

File name: `run_onchange_after_install-packages.sh.tmpl`

**2. Create `run_onchange_after_cleanup-packages.sh.tmpl`**

Cleans up packages not in the Brewfile and logs what was removed.

```bash
{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
# .chezmoidata.yaml packages hash: {{ include ".chezmoidata.yaml" | sha256sum }}
set -eufo pipefail

CLEANUP_LOG="${HOME}/.local/state/homebrew-cleanup.log"
mkdir -p "$(dirname "$CLEANUP_LOG")"

echo "==> Checking for packages to clean up..."

# Capture what would be removed
REMOVABLE=$(brew bundle cleanup --global 2>&1 || true)

if [ -z "$REMOVABLE" ]; then
    echo "==> No packages to clean up."
else
    echo "=== Homebrew Cleanup: $(date -u +"%Y-%m-%dT%H:%M:%SZ") ===" >> "$CLEANUP_LOG"
    echo "$REMOVABLE" >> "$CLEANUP_LOG"
    echo "" >> "$CLEANUP_LOG"

    echo "==> Removing packages not in Brewfile:"
    echo "$REMOVABLE"
    brew bundle cleanup --global --force
    echo "==> Cleanup complete. Removed packages logged to ${CLEANUP_LOG}"
fi
{{ end -}}
```

Key details:
- Use `run_onchange_after_` prefix — runs after managed files applied, and after install script (alphabetical: cleanup > install... wait, "c" comes before "i" alphabetically)
- Actually chezmoi runs `after_` scripts in alphabetical order by filename. "cleanup" (c) comes before "install" (i). We need install to run FIRST.
- **Fix:** Name them so install sorts before cleanup:
  - `run_onchange_after_01-install-packages.sh.tmpl` (install first)
  - `run_onchange_after_02-cleanup-packages.sh.tmpl` (cleanup second)
- Include SHA256 hash of `.chezmoidata.yaml` so it re-runs when packages change
- Preview what will be removed first, then force-remove
- Log removed packages to `~/.local/state/homebrew-cleanup.log` with timestamp
- Use `|| true` on preview to prevent script failure if brew bundle cleanup has non-zero exit
- Automated (no interactive prompt) — per context: `brew bundle cleanup` removes packages not in Brewfile

**Final file names:**
- `run_onchange_after_01-install-packages.sh.tmpl`
- `run_onchange_after_02-cleanup-packages.sh.tmpl`
  </action>
  <verify>
Run `chezmoi diff` to see the new scripts. Run `chezmoi execute-template < ~/.local/share/chezmoi/run_onchange_after_01-install-packages.sh.tmpl` to verify the script renders correctly with a valid SHA256 hash. Same for the cleanup script. Verify alphabetical ordering ensures install runs before cleanup.
  </verify>
  <done>
Package install script runs brew bundle --global after ~/.Brewfile is generated. Cleanup script removes unlisted packages and logs them. Both scripts only re-run when .chezmoidata.yaml changes. Ordering ensures install happens before cleanup.
  </done>
</task>

</tasks>

<verification>
- `chezmoi managed --include=scripts` shows all three run scripts
- `chezmoi diff` shows ~/.Brewfile would be created
- `chezmoi execute-template` renders valid Brewfile and valid bash scripts
- Hash comment in scripts changes when .chezmoidata.yaml is modified
- Script filenames ensure correct execution order: homebrew bootstrap (once, before) -> Brewfile template (managed file) -> install (onchange, after 01) -> cleanup (onchange, after 02)
</verification>

<success_criteria>
- Homebrew bootstrap script installs brew on fresh macOS
- Brewfile template generates correct ~/.Brewfile from chezmoidata
- Install script runs brew bundle --global with full output
- Cleanup script removes unlisted packages with audit log
- All scripts only run when package data changes (run_onchange_ with hash)
- Scripts are darwin-only (wrapped in OS conditional)
- Execution order is correct: bootstrap -> file templates -> install -> cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/04-package-management-migration/04-02-SUMMARY.md`
</output>
