---
phase: 04-package-management-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .chezmoidata.yaml
autonomous: true

must_haves:
  truths:
    - "All packages from Brewfile, Brewfile_Client, Brewfile_Fanaka, and nix-config/modules/apps.nix are captured in .chezmoidata.yaml"
    - "Packages are structured as common (all machines) vs client-specific vs fanaka-specific"
    - "All package types represented: taps, brews, casks, and MAS apps"
  artifacts:
    - path: ".chezmoidata.yaml"
      provides: "Complete package lists for all machines"
      contains: "packages"
  key_links:
    - from: ".chezmoidata.yaml"
      to: ".chezmoi.yaml.tmpl"
      via: "machine_type data variable used in templates"
      pattern: "machine_type"
---

<objective>
Consolidate all package lists from existing Brewfiles and Nix configuration into a structured `.chezmoidata.yaml` file with common and machine-specific sections.

Purpose: Create the single source of truth for all Homebrew packages, replacing three separate Brewfiles and the Nix apps configuration. This data file drives all subsequent package automation.
Output: Complete `.chezmoidata.yaml` with all taps, brews, casks, and MAS apps organised by machine type.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-package-management-migration/04-CONTEXT.md
@.planning/phases/04-package-management-migration/04-RESEARCH.md

Source files to merge:
@Brewfile
@Brewfile_Client
@Brewfile_Fanaka
@nix-config/modules/apps.nix
@nix-config/modules/apps-fanaka.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge and deduplicate all package lists into .chezmoidata.yaml</name>
  <files>~/.local/share/chezmoi/.chezmoidata.yaml</files>
  <action>
Read all four package sources and merge into a single structured `.chezmoidata.yaml`. The file already exists with placeholder structure — replace the placeholder `packages` section with real data.

**Data sources to merge:**
1. `Brewfile` (global) — taps, brews, casks, fonts, MAS apps
2. `Brewfile_Client` — client-specific taps, brews, casks
3. `Brewfile_Fanaka` — fanaka-specific brews, casks, MAS apps
4. `nix-config/modules/apps.nix` — Nix system packages (many overlap with Brewfile), Homebrew brews/casks/taps/MAS managed by nix-darwin
5. `nix-config/modules/apps-fanaka.nix` — Fanaka-specific Homebrew casks and MAS apps managed by nix-darwin

**Structure to use (based on research Pattern 3):**

```yaml
packages:
  darwin:
    # Taps — merged from all sources, deduplicated
    taps:
      - "homebrew/bundle"
      - "koekeishiya/formulae"
      # ... all taps

    # Common brews — packages in Brewfile (global) that all machines need
    common_brews:
      - "ack"
      - "archey4"
      # ... alphabetically sorted

    # Common casks — casks in Brewfile (global) that all machines need
    common_casks:
      - "aerospace"
      - "arc"
      # ... alphabetically sorted

    # Client-specific brews — from Brewfile_Client
    client_brews:
      - "autoconf"
      - "btop"
      # ... alphabetically sorted

    # Client-specific casks — from Brewfile_Client
    client_casks:
      - "apache-directory-studio"
      - "atuin-desktop"
      # ... alphabetically sorted

    # Fanaka-specific brews — from Brewfile_Fanaka
    fanaka_brews:
      - "bats-core"
      - "exercism"
      # ... alphabetically sorted

    # Fanaka-specific casks — from Brewfile_Fanaka
    fanaka_casks:
      - "affinity-designer"
      - "affinity-photo"
      # ... alphabetically sorted

    # Fonts — from Brewfile (common to all machines)
    fonts:
      - "font-fira-code"
      - "font-fira-code-nerd-font"
      # ... alphabetically sorted

    # Common MAS apps — from Brewfile (global)
    common_mas:
      Racompass: 1538380685
      Xcode: 497799835

    # Fanaka MAS apps — from Brewfile_Fanaka + nix-config apps-fanaka.nix
    fanaka_mas:
      "Ampado PRO": 1423295407
      "iFinance 5": 1500241909
      # ... all fanaka MAS apps
```

**Merge rules:**
- Deduplicate across all sources (e.g., `mas` appears in both Brewfile and Brewfile_Fanaka — include once in the right section)
- Packages that appear in BOTH the global Brewfile AND a machine-specific file go in the common section (they're needed everywhere)
- Packages ONLY in Brewfile_Client go in client sections
- Packages ONLY in Brewfile_Fanaka go in fanaka sections
- Nix `environment.systemPackages` that have Homebrew equivalents go into common_brews (most are already in Brewfile)
- Nix-managed Homebrew entries (`homebrew.brews`, `homebrew.casks`) from apps.nix and apps-fanaka.nix should be merged — they represent the most up-to-date nix-darwin package list
- Strip Ruby-style conditionals (`if OS.mac?`) — not needed in chezmoidata since the template handles OS detection
- Strip comments from package names but preserve as YAML comments where helpful
- Keep all lists alphabetically sorted within each section
- Preserve the existing `tools` section at the bottom of the file unchanged

**Packages to EXCLUDE:**
- `asdf` — being replaced by mise in Phase 5
- Any package that's clearly Nix-only with no Homebrew equivalent (check Homebrew availability)
- VS Code extensions — managed by Settings Sync

**Packages from nix-config/apps.nix to include:**
- Cross-reference `environment.systemPackages` with Homebrew availability
- Nix-specific packages (zsh-fzf-tab, zsh-forgit, zsh-fzf-history-search, fzf-git-sh, nanorc, qemu, zulu, nodejs_22) — check if they have Homebrew formulae. If not, skip them (they're ZSH plugins managed by Sheldon or not needed)
- Include brew/cask/MAS entries from `homebrew` section in apps.nix — these are already Homebrew packages
- Include cask entries from apps-fanaka.nix

**Important:** The Nix apps.nix `homebrew` section contains the most comprehensive and up-to-date list of casks. Merge those WITH the existing Brewfile casks, deduplicating.
  </action>
  <verify>
Run `chezmoi cat-config` to verify chezmoidata is loadable. Run `chezmoi execute-template '{{ len .packages.darwin.common_brews }}'` to verify package data is accessible. Spot-check: verify `git`, `bat`, `ripgrep` are in common_brews; `k9s` or `dive` in client_brews; `exercism` in fanaka_brews.
  </verify>
  <done>
All packages from the four source files are captured in .chezmoidata.yaml. No duplicates across sections. All lists alphabetically sorted. Package types (taps, brews, casks, fonts, MAS) properly separated. Machine-specific packages correctly assigned to client/fanaka sections.
  </done>
</task>

</tasks>

<verification>
- `chezmoi data` shows the packages structure with all sections populated
- Count of packages roughly matches source files (~60+ common brews, ~30+ common casks, ~15+ client items, ~20+ fanaka items)
- No YAML syntax errors (chezmoi data parses cleanly)
</verification>

<success_criteria>
- .chezmoidata.yaml contains complete package lists from all four source files
- Structure uses common + machine-specific pattern
- All package types represented (taps, brews, casks, fonts, MAS)
- No duplicates across sections
- chezmoi can read and template the data
</success_criteria>

<output>
After completion, create `.planning/phases/04-package-management-migration/04-01-SUMMARY.md`
</output>
