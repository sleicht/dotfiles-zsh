---
phase: 04-package-management-migration
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - nix-config/
  - zsh.d/path.zsh.tmpl
autonomous: true

must_haves:
  truths:
    - "nix-config/ directory is deleted from the repository"
    - "No Nix references remain in chezmoi-managed shell configuration files"
    - "Nix removal instructions are documented for manual execution"
  artifacts:
    - path: "~/.local/share/chezmoi/run_once_after_remove-nix-references.sh.tmpl"
      provides: "Automated removal of Nix shell references from /etc files"
      contains: "nix"
  key_links:
    - from: "zsh.d/path.zsh template"
      to: "Nix paths removed"
      via: "Nix PATH entries removed from path configuration"
      pattern: "nix"
---

<objective>
Remove Nix completely from the repository and prepare system-level Nix removal. Delete nix-config/ directory, clean Nix references from shell configs, and create a run_once script that removes Nix shell hooks from system files.

Purpose: Complete the migration away from Nix by removing all Nix-related configuration from the repository and system. This fulfils requirement PKGM-03 (Remove Nix completely).
Output: nix-config/ deleted, shell configs cleaned, Nix removal script for system-level cleanup.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-package-management-migration/04-CONTEXT.md
@.planning/phases/04-package-management-migration/04-RESEARCH.md

Nix files to investigate:
@nix-config/flake.nix
@nix-config/modules/apps.nix
@nix-config/modules/apps-fanaka.nix
@nix-config/modules/home.nix
@nix-config/modules/system.nix
@nix-config/modules/nix-core.nix
@nix-config/modules/host-users.nix
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate Nix state and clean repository</name>
  <files>
    nix-config/ (deleted)
  </files>
  <action>
**1. Investigate current Nix system state**

Before removing anything, document what Nix currently manages by running:
- `which nix` — check if Nix binary exists
- `nix-channel --list 2>/dev/null || echo "no channels"` — check for channels
- `launchctl list | grep nix 2>/dev/null || echo "no nix daemons"` — check for running daemons
- `ls /nix 2>/dev/null || echo "no /nix directory"` — check for Nix store
- `diskutil list | grep -i nix 2>/dev/null || echo "no nix volume"` — check for Nix volume
- `grep -r "nix" /etc/zshrc /etc/bashrc /etc/zprofile 2>/dev/null || echo "no nix in /etc"` — check for shell hooks
- `cat /etc/synthetic.conf 2>/dev/null || echo "no synthetic.conf"` — check for Nix mount point

Log findings in the summary — this helps the user understand what manual cleanup may be needed.

**2. Delete nix-config/ directory from git**

Run `git rm -r nix-config/` to remove the entire directory from version control. Git history preserves it for reference.

**3. Clean Nix references from chezmoi-managed shell files**

Search all chezmoi source templates for Nix references:
```bash
grep -r "nix" ~/.local/share/chezmoi/ --include="*.tmpl" --include="*.zsh" -l
```

For each file found:
- If it's the path.zsh template: Remove any Nix-specific PATH entries (e.g., `/nix/var/nix/profiles/default/bin`, `$HOME/.nix-profile/bin`). These were likely already wrapped in conditionals from Phase 3, but verify they're gone or remove them.
- If it's .zshrc or similar: Remove any `source nix-daemon.sh` lines or Nix environment setup blocks.
- Do NOT remove comments that reference Nix (documentation is fine to keep if it explains the migration).

Also check the existing dotfiles repo for Nix references:
```bash
grep -r "nix" ~/.dotfiles/zsh.d/ --include="*.zsh" -l 2>/dev/null
grep -r "nix" ~/.dotfiles/.config/ -l 2>/dev/null
```

Clean any Nix references found in source files that chezmoi manages.
  </action>
  <verify>
Verify `nix-config/` no longer exists in working tree: `ls nix-config/ 2>/dev/null || echo "deleted"`. Verify no Nix PATH references in chezmoi templates: `grep -r "/nix/" ~/.local/share/chezmoi/ --include="*.tmpl" | grep -v "remove-nix"` should return nothing. Git status shows nix-config/ staged for deletion.
  </verify>
  <done>
nix-config/ deleted from repository. All Nix PATH references removed from chezmoi-managed shell configuration. Nix system state documented in summary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Nix system removal script</name>
  <files>
    ~/.local/share/chezmoi/run_once_after_remove-nix-references.sh.tmpl
  </files>
  <action>
Create a `run_once_after_` script that cleans up system-level Nix references. This handles the parts that can be automated — specifically removing Nix hooks from /etc shell configuration files.

**Important:** Full Nix uninstallation (stopping daemon, removing /nix volume, deleting users) requires root privileges and careful ordering. The chezmoi script handles what it safely can. The full removal process will be documented for manual execution during the verification checkpoint.

```bash
{{ if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -euo pipefail

echo "==> Checking for Nix references to clean up..."

# Check if Nix is installed
if [ ! -d "/nix" ]; then
    echo "==> Nix is not installed. Nothing to clean up."
    exit 0
fi

echo "==> Nix installation detected. System-level removal requires manual steps."
echo ""
echo "Please run the following commands to completely remove Nix:"
echo ""
echo "# 1. Stop and remove Nix daemon"
echo "sudo launchctl bootout system/org.nixos.nix-daemon 2>/dev/null || true"
echo "sudo rm -f /Library/LaunchDaemons/org.nixos.nix-daemon.plist"
echo "sudo rm -f /Library/LaunchDaemons/org.nixos.darwin-store.plist"
echo ""
echo "# 2. Remove Nix shell hooks from /etc files"
echo "# (Back up first, then edit)"
echo "sudo cp /etc/zshrc /etc/zshrc.backup-pre-nix-removal 2>/dev/null || true"
echo "sudo cp /etc/bashrc /etc/bashrc.backup-pre-nix-removal 2>/dev/null || true"
echo "sudo cp /etc/bash.bashrc /etc/bash.bashrc.backup-pre-nix-removal 2>/dev/null || true"
echo "# Remove the Nix block (between '# Nix' and '# End Nix') from:"
echo "#   /etc/zshrc"
echo "#   /etc/bashrc"
echo "#   /etc/bash.bashrc (if it exists)"
echo ""
echo "# 3. Remove Nix users and group"
echo "for i in \$(seq 1 32); do"
echo "  sudo dscl . -delete /Users/_nixbld\$i 2>/dev/null || true"
echo "done"
echo "sudo dscl . -delete /Groups/nixbld 2>/dev/null || true"
echo ""
echo "# 4. Remove Nix from synthetic.conf and fstab"
echo "sudo sed -i '' '/^nix$/d' /etc/synthetic.conf 2>/dev/null || true"
echo "sudo sed -i '' '/nix/d' /etc/fstab 2>/dev/null || true"
echo ""
echo "# 5. Remove Nix store volume"
echo "sudo diskutil apfs deleteVolume /nix 2>/dev/null || true"
echo ""
echo "# 6. Remove Nix directories"
echo "sudo rm -rf /nix"
echo "sudo rm -rf /etc/nix"
echo "rm -rf ~/.nix-profile"
echo "rm -rf ~/.nix-defexpr"
echo "rm -rf ~/.nix-channels"
echo "rm -rf ~/.local/state/nix"
echo "rm -rf ~/.cache/nix"
echo ""
echo "# 7. Reboot to complete volume removal"
echo "echo 'Reboot required to finalise Nix removal.'"
echo ""
echo "==> Copy and run these commands manually (they require sudo)."
echo "==> After reboot, verify with: ls /nix 2>/dev/null || echo 'Nix removed successfully'"
{{ end -}}
```

Key details:
- Use `run_once_after_` prefix — runs once, after managed files applied
- Does NOT execute destructive commands automatically — prints instructions instead
- Nix removal requires sudo and careful ordering (daemon stop -> user removal -> volume deletion -> reboot)
- This is safer than automating root-level operations in a dotfile manager
- The script detects if Nix is installed first; if not, exits cleanly
- Based on official Nix 2.31.3 uninstallation guide from research
  </action>
  <verify>
Run `chezmoi execute-template < ~/.local/share/chezmoi/run_once_after_remove-nix-references.sh.tmpl` to verify the script renders correctly. Verify it contains all 7 removal steps from the official guide.
  </verify>
  <done>
Nix removal script exists in chezmoi source. It safely detects Nix and prints manual removal instructions (does not auto-execute root operations). All official removal steps documented.
  </done>
</task>

</tasks>

<verification>
- `nix-config/` is removed from git working tree
- `grep -r "/nix/" ~/.local/share/chezmoi/ --include="*.tmpl" | grep -v "remove-nix"` returns nothing
- Nix removal script renders valid bash and contains all removal steps
- Nix system state has been documented
</verification>

<success_criteria>
- nix-config/ directory deleted from repository (git rm)
- No Nix PATH references in chezmoi-managed templates
- Nix removal run_once script created with complete removal instructions
- Script is safe (prints instructions, doesn't auto-execute root commands)
</success_criteria>

<output>
After completion, create `.planning/phases/04-package-management-migration/04-03-SUMMARY.md`
</output>
