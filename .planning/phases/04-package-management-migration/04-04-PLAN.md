---
phase: 04-package-management-migration
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "chezmoi apply generates a valid ~/.Brewfile with correct packages for the user's machine type"
    - "brew bundle --global successfully installs packages from generated Brewfile"
    - "Nix references are gone from shell configuration"
    - "Old Brewfile_Client and Brewfile_Fanaka can be safely retired"
  artifacts: []
  key_links:
    - from: "chezmoi apply"
      to: "~/.Brewfile"
      via: "dot_Brewfile.tmpl generates Brewfile, run scripts install packages"
      pattern: "brew bundle"
---

<objective>
Verify the complete package management migration works end-to-end. User validates that chezmoi apply generates correct Brewfile, installs packages, and Nix is properly removed.

Purpose: Final validation checkpoint ensuring all three requirements (PKGM-01 automated installation, PKGM-02 consolidated data, PKGM-03 Nix removal) are met before marking the phase complete.
Output: Verified working package management system, old Brewfiles retired.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-package-management-migration/04-CONTEXT.md
@.planning/phases/04-package-management-migration/04-01-SUMMARY.md
@.planning/phases/04-package-management-migration/04-02-SUMMARY.md
@.planning/phases/04-package-management-migration/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate generated Brewfile and run chezmoi apply</name>
  <files></files>
  <action>
**1. Preview the generated Brewfile**

Run `chezmoi diff` to see all pending changes. Then specifically check:
- `chezmoi cat ~/.Brewfile` — view what the generated Brewfile will contain
- Verify it has taps, brews, casks, fonts, and MAS sections
- Verify machine-specific packages match the user's machine_type
- Count packages and compare to source Brewfiles

**2. Run chezmoi apply (dry-run first)**

Run `chezmoi apply --dry-run --verbose` to preview all changes including script execution.

Then run `chezmoi apply --verbose` for real. This will:
- Create `~/.Brewfile` from template
- Run the install-packages script (brew bundle --global)
- Run the cleanup-packages script
- Run the Nix removal instruction script

Monitor output for errors. Expected: full Homebrew output showing package installation.

**3. Verify Brewfile is correct**

After apply:
- `cat ~/.Brewfile | head -20` — verify generated content
- `brew bundle check --global` — verify all packages in Brewfile are installed
- `brew bundle list --global` — list what's managed

**4. Verify no old Brewfiles are needed**

Compare the generated `~/.Brewfile` against the old files:
- Check that all packages from `Brewfile` are present
- Check that machine-specific packages from `Brewfile_Client` or `Brewfile_Fanaka` (based on machine type) are present
  </action>
  <verify>
`brew bundle check --global` exits 0 (all packages installed). `cat ~/.Brewfile` shows valid Brewfile content. `chezmoi verify` passes.
  </verify>
  <done>
chezmoi apply generates valid Brewfile and installs all packages successfully. Generated Brewfile covers all packages from original Brewfiles.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete package management migration:
1. All packages consolidated into .chezmoidata.yaml (single source of truth)
2. chezmoi apply generates ~/.Brewfile and installs packages automatically
3. Package cleanup with audit trail enabled
4. Homebrew bootstrap for fresh systems
5. Nix removed from repository (nix-config/ deleted)
6. Nix removal instructions provided for system-level cleanup
  </what-built>
  <how-to-verify>
1. Open a new terminal — verify shell works correctly
2. Run `cat ~/.Brewfile` — verify it contains expected packages for your machine
3. Run `brew bundle check --global` — should report all packages satisfied
4. Run `chezmoi data | grep -A 5 packages` — verify package data structure is populated
5. Verify `nix-config/` is gone: `ls nix-config/ 2>/dev/null || echo "deleted"`
6. Check cleanup log exists: `cat ~/.local/state/homebrew-cleanup.log 2>/dev/null`
7. (Optional) Follow the Nix removal instructions printed during apply to remove Nix from the system
8. (Optional) After Nix removal + reboot: `ls /nix 2>/dev/null || echo "Nix removed"`

Once verified:
- Old Brewfile, Brewfile_Client, Brewfile_Fanaka can be archived or deleted
- The dotbot-brew/ and dotbot-brewfile/ submodules related to Brew can be cleaned up if no longer needed
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Phase 4 success criteria check:
1. [x] User can run `chezmoi apply` and all Homebrew packages install/update automatically
2. [x] User has consolidated machine-specific package lists in `.chezmoidata` format
3. [x] User can verify Nix is removed from repository (nix-config/ deleted, removal instructions provided)
4. [x] User can install dotfiles on fresh system (Homebrew bootstrap + package install scripts)
5. [x] OS-specific package installation working (darwin-only templates)
</verification>

<success_criteria>
- chezmoi apply completes without errors
- ~/.Brewfile contains all expected packages
- brew bundle check --global reports all satisfied
- nix-config/ deleted from repository
- Shell works correctly in new terminal
- User approves the migration
</success_criteria>

<output>
After completion, create `.planning/phases/04-package-management-migration/04-04-SUMMARY.md`
</output>
