---
phase: 02-chezmoi-foundation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - ~/.local/share/chezmoi/dot_zshrc
  - ~/.local/share/chezmoi/dot_zshenv
  - ~/.local/share/chezmoi/dot_zprofile
  - ~/.local/share/chezmoi/dot_zsh.d/aliases.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/atuin.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/carapace.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/completions.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/external.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/functions.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/hooks.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/intelli-shell.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/keybinds.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/lens-completion.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/path.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/ssh.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/variables.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/wt.zsh
  - ~/.local/share/chezmoi/dot_zsh.d/xlaude.zsh
autonomous: true

must_haves:
  truths:
    - "User can open new terminal and shell loads correctly"
    - "All aliases from aliases.zsh are available"
    - "All functions from functions.zsh are available"
    - "PATH includes expected directories"
  artifacts:
    - path: "~/.local/share/chezmoi/dot_zshrc"
      provides: "Main zsh configuration"
      min_lines: 10
    - path: "~/.local/share/chezmoi/dot_zsh.d"
      provides: "Modular zsh configuration directory"
    - path: "~/.zshrc"
      provides: "Applied zshrc (real file, not symlink)"
  key_links:
    - from: "~/.local/share/chezmoi/dot_zshrc"
      to: "~/.zshrc"
      via: "chezmoi apply"
      pattern: "chezmoi managed"
    - from: "~/.zshrc"
      to: "~/.zsh.d/*.zsh"
      via: "source or zgenom"
      pattern: "zsh.d"
---

<objective>
Migrate core shell configuration files from Dotbot/Nix to chezmoi management.

Purpose: Move .zshrc, .zshenv, .zprofile, and zsh.d/*.zsh to chezmoi so shell config is managed by chezmoi.
Output: All shell files in chezmoi source, applied to home directory as real files (not symlinks).
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chezmoi-foundation/02-RESEARCH.md
@.planning/phases/02-chezmoi-foundation/02-CONTEXT.md
@.planning/phases/02-chezmoi-foundation/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add core shell files to chezmoi</name>
  <files>~/.local/share/chezmoi/dot_zshrc, dot_zshenv, dot_zprofile</files>
  <action>
    **Important context:** The current shell files are complex:
    - ~/.zshrc, ~/.zshenv, ~/.zprofile are Nix Home Manager symlinks to nix-store
    - The actual source files are at ~/.dotfiles/.config/zshrc, zshenv, zprofile
    - Nix wrapper sources ~/.dotfiles/.config/zshrc

    Migration approach: Copy the actual source files to chezmoi, then create standalone versions that don't depend on Nix.

    1. Create standalone .zshrc that combines Nix wrapper essentials + actual config:

    Write to `~/.local/share/chezmoi/dot_zshrc`:
    ```zsh
    # .zshrc - managed by chezmoi
    # To edit: chezmoi edit ~/.zshrc
    # To apply: chezmoi apply

    # === ZSH Configuration ===
    typeset -U path cdpath fpath manpath

    # History configuration
    HISTSIZE="10000"
    SAVEHIST="10000"
    HISTFILE="$HOME/.zsh_history"
    mkdir -p "$(dirname "$HISTFILE")"

    setopt HIST_FCNTL_LOCK
    setopt HIST_IGNORE_DUPS
    setopt HIST_IGNORE_SPACE
    setopt SHARE_HISTORY

    # XDG directories
    : "${XDG_CONFIG_HOME:=$HOME/.config}"
    : "${XDG_DATA_HOME:=$HOME/.local/share}"

    # === Nix (if available) ===
    if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
      . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
    fi

    # === Plugin management (zgenom) ===
    source "${HOME}/.zgenom/zgenom.zsh"
    export ZGENOM_CONFIG_DIR="$XDG_CONFIG_HOME/zgenom"
    source "${ZGENOM_CONFIG_DIR}/zgenomrc.zsh"

    # === Load modular configuration ===
    # zsh.d files are loaded by zgenom via zgenomrc.zsh
    # Atuin is initialized in zsh.d/atuin.zsh
    ```

    2. Create .zshenv (environment variables, loaded for all shells):

    Copy from `~/.dotfiles/.config/zshenv` to `~/.local/share/chezmoi/dot_zshenv`
    Add chezmoi header comment.

    3. Create .zprofile (login shell):

    Copy from `~/.dotfiles/.config/zprofile` to `~/.local/share/chezmoi/dot_zprofile`
    Add chezmoi header comment.

    4. Verify files added:
    ```bash
    ls -la ~/.local/share/chezmoi/dot_zsh*
    ```
  </action>
  <verify>Run `ls ~/.local/share/chezmoi/dot_zsh*` - should show dot_zshrc, dot_zshenv, dot_zprofile</verify>
  <done>Core shell files (zshrc, zshenv, zprofile) exist in chezmoi source with chezmoi header comments</done>
</task>

<task type="auto">
  <name>Task 2: Add zsh.d directory to chezmoi</name>
  <files>~/.local/share/chezmoi/dot_zsh.d/*</files>
  <action>
    The zsh.d directory contains 15 modular ZSH configuration files currently symlinked via Dotbot.

    1. Create the dot_zsh.d directory in chezmoi source:
    ```bash
    mkdir -p ~/.local/share/chezmoi/dot_zsh.d
    ```

    2. Copy all zsh.d files from dotfiles repo to chezmoi source:
    ```bash
    cp ~/.dotfiles/zsh.d/*.zsh ~/.local/share/chezmoi/dot_zsh.d/
    ```

    Files to migrate (15 total):
    - aliases.zsh - Shell aliases and shortcuts
    - atuin.zsh - Atuin history configuration
    - carapace.zsh - Carapace completion configuration
    - completions.zsh - ZSH completion settings
    - external.zsh - External tool integration
    - functions.zsh - Custom shell functions
    - hooks.zsh - ZSH hooks (chpwd, preexec, etc.)
    - intelli-shell.zsh - Intelli-shell configuration
    - keybinds.zsh - Key bindings
    - lens-completion.zsh - Kubernetes Lens completion
    - path.zsh - PATH configuration
    - ssh.zsh - SSH agent configuration
    - variables.zsh - Environment variables
    - wt.zsh - Warp terminal integration
    - xlaude.zsh - Claude CLI integration

    3. Add chezmoi header comment to each file (first line):
    ```zsh
    # Managed by chezmoi - edit in ~/.local/share/chezmoi/dot_zsh.d/
    ```

    4. Verify all files copied:
    ```bash
    ls ~/.local/share/chezmoi/dot_zsh.d/ | wc -l
    # Should be 15
    ```
  </action>
  <verify>Run `ls ~/.local/share/chezmoi/dot_zsh.d/ | wc -l` - should return 15</verify>
  <done>All 15 zsh.d files exist in chezmoi source directory with header comments</done>
</task>

<task type="auto">
  <name>Task 3: Apply shell configuration and verify</name>
  <files>~/.zshrc, ~/.zshenv, ~/.zprofile, ~/.zsh.d/*</files>
  <action>
    **CRITICAL:** Before applying, the Nix symlinks must be removed or chezmoi will error. The user's Nix Home Manager manages these files - we need to handle this carefully.

    1. First, check what chezmoi would do (dry run):
    ```bash
    chezmoi diff
    ```

    Review the diff carefully - should show:
    - ~/.zshrc: symlink -> real file (new content)
    - ~/.zshenv: symlink -> real file
    - ~/.zprofile: symlink -> real file
    - ~/.zsh.d/*: symlink -> real directory with files

    2. Back up current symlinks (safety):
    ```bash
    # These are symlinks to nix-store, back up targets
    cp -L ~/.zshrc ~/.zshrc.nix-backup 2>/dev/null || true
    cp -L ~/.zshenv ~/.zshenv.nix-backup 2>/dev/null || true
    cp -L ~/.zprofile ~/.zprofile.nix-backup 2>/dev/null || true
    ```

    3. Remove Nix symlinks to allow chezmoi to manage:
    ```bash
    rm -f ~/.zshrc ~/.zshenv ~/.zprofile
    ```

    4. Remove Dotbot symlink for zsh.d:
    ```bash
    rm -f ~/.zsh.d
    ```

    5. Apply chezmoi configuration:
    ```bash
    chezmoi apply --verbose
    ```

    6. Verify files are now real files (not symlinks):
    ```bash
    ls -la ~/.zshrc ~/.zshenv ~/.zprofile ~/.zsh.d/
    # Should show regular files, not symlinks
    ```

    7. Test shell in subshell:
    ```bash
    zsh -l -c 'echo "Shell loaded OK"; alias | head -5'
    ```

    Expected: Shell loads without errors, aliases are available.

    8. Commit to chezmoi source (autoCommit should handle, but verify):
    ```bash
    cd ~/.local/share/chezmoi && git status
    ```
  </action>
  <verify>Run `zsh -l -c 'alias | wc -l'` - should return count > 0 (aliases loaded)</verify>
  <done>chezmoi apply succeeds, shell loads in subshell, aliases and functions available</done>
</task>

</tasks>

<verification>
1. `ls ~/.local/share/chezmoi/dot_zsh*` shows dot_zshrc, dot_zshenv, dot_zprofile, dot_zsh.d/
2. `ls ~/.local/share/chezmoi/dot_zsh.d/ | wc -l` returns 15
3. `chezmoi verify` exits with code 0 (no drift)
4. `ls -la ~/.zshrc` shows regular file (not symlink)
5. `zsh -l -c 'alias | head -5'` shows aliases loaded
6. `zsh -l -c 'type llm'` shows function defined (from functions.zsh)
</verification>

<success_criteria>
- All shell files migrated to chezmoi source (dot_zshrc, dot_zshenv, dot_zprofile, dot_zsh.d/*)
- chezmoi apply creates real files in home directory (not symlinks)
- New shell loads correctly with aliases, functions, and completions
- chezmoi verify confirms no drift between source and target
</success_criteria>

<output>
After completion, create `.planning/phases/02-chezmoi-foundation/02-02-SUMMARY.md`
</output>
