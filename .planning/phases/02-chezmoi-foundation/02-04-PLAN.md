---
phase: 02-chezmoi-foundation
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - ~/.dotfiles/steps/terminal.yml
  - ~/.local/share/chezmoi/.git/config
  - ~/.local/share/chezmoi/README.md
autonomous: false

must_haves:
  truths:
    - "New terminal session has working shell with aliases and functions"
    - "chezmoi source directory is under git version control"
    - "Dotbot install no longer manages migrated files"
    - "User understands chezmoi edit/apply workflow"
  artifacts:
    - path: "~/.local/share/chezmoi/.git"
      provides: "Git version control for chezmoi source"
    - path: "~/.local/share/chezmoi/README.md"
      provides: "Quick reference for chezmoi workflow"
      contains: "chezmoi edit"
    - path: "~/.dotfiles/steps/terminal.yml"
      provides: "Updated Dotbot config with migrated entries commented"
      contains: "Migrated to chezmoi"
  key_links:
    - from: "~/.local/share/chezmoi"
      to: "git remote"
      via: "git remote add origin"
      pattern: "remote.*origin"
---

<objective>
Verify complete shell functionality, set up git version control for chezmoi source, update Dotbot configuration, and confirm user understands new workflow.

Purpose: Complete the migration by ensuring everything works, setting up version control, and documenting the new workflow.
Output: Working shell, git-controlled chezmoi source with remote, updated Dotbot config, workflow documentation.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chezmoi-foundation/02-RESEARCH.md
@.planning/phases/02-chezmoi-foundation/02-CONTEXT.md
@.planning/phases/02-chezmoi-foundation/02-01-SUMMARY.md
@.planning/phases/02-chezmoi-foundation/02-02-SUMMARY.md
@.planning/phases/02-chezmoi-foundation/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up git version control for chezmoi source</name>
  <files>~/.local/share/chezmoi/.git</files>
  <action>
    1. Navigate to chezmoi source directory and check git status:
    ```bash
    cd ~/.local/share/chezmoi
    git status 2>/dev/null || echo "Not a git repo yet"
    ```

    2. If not already a git repo, initialise:
    ```bash
    cd ~/.local/share/chezmoi
    git init
    ```

    3. Add all files and create initial commit:
    ```bash
    cd ~/.local/share/chezmoi
    git add .
    git commit -m "feat: initial chezmoi migration from dotbot

    Migrated core shell configuration:
    - .zshrc, .zshenv, .zprofile (from Nix Home Manager)
    - zsh.d/*.zsh (15 files from Dotbot)
    - .gitconfig, .gitignore_global, .gitattributes_global (from Dotbot)

    chezmoi now manages these files with manual-apply workflow."
    ```

    4. Set up remote (can use same GitHub account, new repo or fork):
    ```bash
    # Check if remote exists
    cd ~/.local/share/chezmoi
    git remote -v

    # If no remote, add one (user will need to create repo on GitHub)
    # git remote add origin git@github.com:sleicht/dotfiles-chezmoi.git
    ```

    Note: Remote setup may require user to create GitHub repository first.
  </action>
  <verify>Run `cd ~/.local/share/chezmoi && git log --oneline -1` - should show initial commit</verify>
  <done>chezmoi source is a git repository with initial commit containing all migrated files</done>
</task>

<task type="auto">
  <name>Task 2: Update Dotbot configuration</name>
  <files>~/.dotfiles/steps/terminal.yml</files>
  <action>
    Update `~/.dotfiles/steps/terminal.yml` to comment out migrated entries and add notes.

    Find and comment out these sections with migration notes:

    1. Shell files section - add comment noting migration:
    ```yaml
    # Terminal:
    # === MIGRATED TO CHEZMOI ===
    # .zshrc, .zshenv, .zprofile - now managed by chezmoi
    # See: ~/.local/share/chezmoi/dot_zsh*
    # Nix Home Manager wrapper no longer needed

        ~/.zsh.d:
    #     path: zsh.d
    #     create: true
    #     stdout: true
    #     stderr: true
    # === END MIGRATED ===
    ```

    2. Git section - add comment noting migration:
    ```yaml
      # Git:
    # === MIGRATED TO CHEZMOI ===
    # .gitconfig, .gitignore_global, .gitattributes_global
    # See: ~/.local/share/chezmoi/dot_git*
    #    ~/.gitconfig:
    #      force: true
    #      path: .config/git/gitconfig
    #    ~/.gitignore_global: .config/git/gitignore
    #    ~/.gitattributes_global: .config/git/gitattributes
    # === END MIGRATED ===
    ```

    3. Test Dotbot still works for unmigrated files:
    ```bash
    cd ~/.dotfiles && ./install
    ```

    Expected: Dotbot runs without errors, only manages unmigrated files.
  </action>
  <verify>Run `cd ~/.dotfiles && ./install` - should complete without errors</verify>
  <done>Dotbot configuration updated with migrated entries commented out, install still works for remaining files</done>
</task>

<task type="auto">
  <name>Task 3: Create workflow quick reference</name>
  <files>~/.local/share/chezmoi/README.md</files>
  <action>
    Create a README.md in chezmoi source as quick reference for the new workflow.

    Write to `~/.local/share/chezmoi/README.md`:
    ```markdown
    # Dotfiles (chezmoi)

    This directory contains dotfiles managed by [chezmoi](https://www.chezmoi.io/).

    ## Quick Reference

    ### Daily Workflow

    ```bash
    # Edit a file (opens source file in editor)
    chezmoi edit ~/.zshrc

    # Or open this directory as IDE project
    code ~/.local/share/chezmoi

    # Preview what would change
    chezmoi diff

    # Apply changes to home directory
    chezmoi apply
    ```

    ### Important

    **Never edit files directly in home directory** (e.g., `~/.zshrc`).
    Always edit the source files here, then run `chezmoi apply`.

    ### Managed Files

    **Shell Configuration:**
    - `dot_zshrc` -> `~/.zshrc`
    - `dot_zshenv` -> `~/.zshenv`
    - `dot_zprofile` -> `~/.zprofile`
    - `dot_zsh.d/*` -> `~/.zsh.d/*`

    **Git Configuration:**
    - `dot_gitconfig` -> `~/.gitconfig`
    - `dot_gitignore_global` -> `~/.gitignore_global`
    - `dot_gitattributes_global` -> `~/.gitattributes_global`

    ### Common Commands

    | Command | Description |
    |---------|-------------|
    | `chezmoi diff` | Show pending changes |
    | `chezmoi apply` | Apply changes to home |
    | `chezmoi edit FILE` | Edit source file |
    | `chezmoi verify` | Check for drift |
    | `chezmoi doctor` | Diagnose problems |
    | `chezmoi cd` | Change to source dir |

    ### Configuration

    Config file: `~/.config/chezmoi/chezmoi.toml`
    - `autoCommit = true` - Auto-commits source changes
    - `autoPush = false` - Manual push (safety)

    ## Migration Status

    - [x] Shell files (.zshrc, .zshenv, .zprofile, zsh.d/)
    - [x] Git config (.gitconfig, .gitignore_global, .gitattributes_global)
    - [ ] Templating (Phase 3)
    - [ ] Package management (Phase 4)
    - [ ] Tool versions (Phase 5)
    - [ ] Secrets (Phase 6)
    ```

    Commit the README:
    ```bash
    cd ~/.local/share/chezmoi
    git add README.md
    git commit -m "docs: add workflow quick reference"
    ```
  </action>
  <verify>Run `cat ~/.local/share/chezmoi/README.md | head -10` - should show documentation header</verify>
  <done>README.md exists in chezmoi source with workflow documentation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete chezmoi migration of shell and git configuration:
    - Shell files (.zshrc, .zshenv, .zprofile, zsh.d/*) migrated from Nix/Dotbot
    - Git config files migrated from Dotbot symlinks
    - chezmoi source under git version control
    - Dotbot config updated (migrated entries commented)
    - Workflow documentation created
  </what-built>
  <how-to-verify>
    1. **Open a new terminal** (Cmd+N or new tab) - NOT just sourcing .zshrc

    2. **Verify shell loads correctly:**
       ```bash
       # Check aliases work
       alias | grep -E '^ll|^la|^grep'

       # Check functions work
       type llm  # Should show function definition

       # Check PATH
       echo $PATH | tr ':' '\n' | head -5
       ```

    3. **Verify git config works:**
       ```bash
       git config user.email
       git config alias.s
       ```

    4. **Verify chezmoi workflow:**
       ```bash
       # Check chezmoi sees no drift
       chezmoi verify
       echo $?  # Should be 0

       # Check source is version controlled
       cd ~/.local/share/chezmoi && git log --oneline -3
       ```

    5. **Verify Dotbot still works for other files:**
       ```bash
       cd ~/.dotfiles && ./install
       # Should complete without touching migrated files
       ```

    **Expected results:**
    - New terminal opens without errors
    - Aliases like `ll`, `la` work
    - Functions like `llm` are defined
    - git config shows your settings
    - chezmoi verify exits 0
    - Dotbot install succeeds
  </how-to-verify>
  <resume-signal>
    Type "approved" if shell works correctly and chezmoi workflow is understood.
    If issues found, describe the specific problem (e.g., "aliases not loading", "shell errors on startup").
  </resume-signal>
</task>

</tasks>

<verification>
1. New terminal session loads without errors
2. `alias | wc -l` returns count > 0
3. `type llm` shows function defined
4. `git config user.email` returns configured email
5. `chezmoi verify` exits 0
6. `cd ~/.local/share/chezmoi && git log` shows commits
7. `cd ~/.dotfiles && ./install` succeeds
</verification>

<success_criteria>
- User confirms new terminal works correctly (aliases, functions, completions)
- chezmoi source directory has git history with initial commit
- Dotbot configuration updated to not manage migrated files
- User understands chezmoi edit/apply workflow
- chezmoi verify shows no drift
</success_criteria>

<output>
After completion, create `.planning/phases/02-chezmoi-foundation/02-04-SUMMARY.md`
</output>
