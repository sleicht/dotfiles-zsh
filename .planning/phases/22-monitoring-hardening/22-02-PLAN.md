---
phase: 22-monitoring-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/zsh-smoke-test
autonomous: true

must_haves:
  truths:
    - "Smoke test validates prompt, PATH, completions, keybindings, and critical tools"
    - "Smoke test exits 0 when all checks pass, exits 1 on any failure"
    - "Final three-stage measurement confirms < 300ms total startup"
    - "All existing shell functionality preserved after monitoring additions"
  artifacts:
    - path: "scripts/zsh-smoke-test"
      provides: "Executable smoke test script for shell configuration validation"
      contains: "oh-my-posh"
  key_links:
    - from: "scripts/zsh-smoke-test"
      to: "shell configuration"
      via: "checks tool availability, PATH, completions, keybindings"
      pattern: "commands\\[.*\\]"
---

<objective>
Create smoke test script and run final three-stage performance measurement to confirm targets met.

Purpose: Provide ongoing validation of shell functionality and establish final performance baseline confirming < 300ms target with all monitoring in place.
Output: Executable smoke test script, final performance measurements documented in summary.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-monitoring-hardening/22-RESEARCH.md
@.planning/phases/22-monitoring-hardening/22-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smoke test script</name>
  <files>scripts/zsh-smoke-test</files>
  <action>
Create `scripts/zsh-smoke-test` (in the dotfiles-zsh repo, NOT in chezmoi source) as an executable ZSH script that validates critical shell functionality. The script must be run from within an interactive ZSH session (or source the shell config).

Checks to implement (keep it lean — research warns against > 2s runtime):

1. **oh-my-posh available**: `(( $+commands[oh-my-posh] ))`
2. **Prompt configured**: `[[ -n "$PROMPT" ]]`
3. **mise shims on PATH**: `[[ "$PATH" == *mise/shims* ]]`
4. **Completion system initialised**: `(( $+_comps ))` (checks the _comps associative array exists)
5. **Atuin keybinding**: `bindkey | grep -q atuin`
6. **Critical tools available**: check `git`, `zoxide`, `fzf`, `bat`, `lsd` via `$+commands`
7. **No double plugin loads**: verify zsh-autosuggestions and zsh-syntax-highlighting are not sourced from both sync and defer paths (check that source count is exactly 1 per plugin, not 2+)
8. **LAST_SHELL_STARTUP_MS set**: `[[ -n "$LAST_SHELL_STARTUP_MS" ]]` (confirms self-monitoring from plan 01 is active)

Output format:
- Each check prints `[PASS]` or `[FAIL]` with description
- Summary line at end with pass/fail counts
- Exit 0 if all pass, exit 1 if any fail

Make the script executable (`chmod +x`). Add a shebang of `#!/usr/bin/env zsh`.

Do NOT place this in chezmoi source — it's a development/maintenance script that lives in the dotfiles-zsh repo under `scripts/`.
  </action>
  <verify>
Run the smoke test from an interactive shell: `zsh scripts/zsh-smoke-test`
All checks should pass. Exit code should be 0.
  </verify>
  <done>
Smoke test script exists at scripts/zsh-smoke-test, is executable, validates all critical shell functionality, exits 0 when healthy.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run final three-stage performance measurement</name>
  <files></files>
  <action>
Run three measurement tools to establish final baseline with all monitoring in place:

1. **hyperfine** (warm cache, total time):
   ```bash
   hyperfine --warmup 3 --runs 10 'zsh -i -c exit'
   ```

2. **EPOCHREALTIME** (self-reported from monitoring):
   ```bash
   zsh -i -c 'echo "Self-reported: ${LAST_SHELL_STARTUP_MS}ms"'
   ```

3. **zsh-bench** (perceived time / first prompt lag):
   ```bash
   ~/zsh-bench/zsh-bench
   ```
   If zsh-bench is not at ~/zsh-bench, check common locations or skip with a note.

Record all three measurements. Compare against:
- Phase 19-01 baseline: 314.6ms (hyperfine)
- Phase 21-02 result: 128.7ms (hyperfine), ~70ms perceived
- Target: < 300ms total (PERF-01)

Confirm monitoring overhead is negligible (< 5ms increase vs Phase 21 result).

Include all measurements in the SUMMARY.md output.
  </action>
  <verify>
hyperfine result < 300ms (PERF-01 satisfied).
LAST_SHELL_STARTUP_MS is populated (PROF-02 active).
Smoke test passes (PERF-04 satisfied — functionality preserved).
  </verify>
  <done>
Three-stage measurement complete. All results documented. PERF-01 confirmed (< 300ms). Monitoring overhead negligible.
  </done>
</task>

</tasks>

<verification>
1. `scripts/zsh-smoke-test` exists, is executable, exits 0
2. hyperfine shows < 300ms mean startup
3. LAST_SHELL_STARTUP_MS is set in new shells
4. All existing functionality works (completions, keybindings, tools)
</verification>

<success_criteria>
- PROF-03 satisfied: smoke test script validates prompt, tools, completions, keybindings, no double-loads
- PERF-01 satisfied: hyperfine confirms < 300ms total startup
- PERF-02 satisfied: zsh-bench confirms < 50ms first-prompt lag (or documents actual value)
- PERF-04 satisfied: smoke test confirms all existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/22-monitoring-hardening/22-02-SUMMARY.md`
</output>
