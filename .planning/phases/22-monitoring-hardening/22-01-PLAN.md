---
phase: 22-monitoring-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dot_zshenv
  - dot_zshrc.tmpl
  - run_onchange_after_03-clear-evalcache.sh.tmpl
autonomous: true

must_haves:
  truths:
    - "Shell warns user if startup exceeds 300ms threshold"
    - "User can trigger detailed zprof profiling via ZSH_PROFILE_STARTUP=1"
    - "evalcache is automatically cleared when tracked tool versions change"
    - "LAST_SHELL_STARTUP_MS is available for inspection after each shell start"
  artifacts:
    - path: "dot_zshenv"
      provides: "EPOCHREALTIME start timestamp and conditional zprof loading"
      contains: "ZSHRC_START_TIME"
    - path: "dot_zshrc.tmpl"
      provides: "Startup time calculation, 300ms warning, and zprof output"
      contains: "ZSHRC_ELAPSED"
    - path: "run_onchange_after_03-clear-evalcache.sh.tmpl"
      provides: "chezmoi hook clearing evalcache on tool version change"
      contains: "evalcache"
  key_links:
    - from: "dot_zshenv"
      to: "dot_zshrc.tmpl"
      via: "ZSHRC_START_TIME variable set early, read late"
      pattern: "ZSHRC_START_TIME.*EPOCHREALTIME"
    - from: "run_onchange_after_03-clear-evalcache.sh.tmpl"
      to: "~/.zsh-evalcache"
      via: "rm -rf cache directory when tool versions change"
      pattern: "zsh-evalcache"
---

<objective>
Add startup time self-monitoring, conditional zprof profiling, and chezmoi-driven evalcache invalidation.

Purpose: Prevent performance regressions by alerting when startup exceeds 300ms, provide diagnostic tools for investigation, and automatically clear stale eval caches when tool versions change.
Output: Modified .zshenv and .zshrc with monitoring, new chezmoi run_onchange_ hook for cache invalidation.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-monitoring-hardening/22-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EPOCHREALTIME self-monitoring and conditional zprof</name>
  <files>dot_zshenv, dot_zshrc.tmpl</files>
  <action>
In `~/.local/share/chezmoi/dot_zshenv`, add at the VERY TOP (before existing content, after the chezmoi header comment):

```zsh
# Startup time monitoring
zmodload zsh/datetime
ZSHRC_START_TIME=$EPOCHREALTIME

# Conditional profiling (run: ZSH_PROFILE_STARTUP=1 zsh -i -c exit)
if [[ -n "$ZSH_PROFILE_STARTUP" ]]; then
  zmodload zsh/zprof
fi
```

In `~/.local/share/chezmoi/dot_zshrc.tmpl`, add at the VERY END (after the sheldon source block):

```zsh
# === Startup monitoring ===
if [[ -n "$ZSHRC_START_TIME" ]]; then
  typeset -F _zshrc_elapsed
  _zshrc_elapsed=$(( (EPOCHREALTIME - ZSHRC_START_TIME) * 1000 ))
  export LAST_SHELL_STARTUP_MS=${_zshrc_elapsed%.*}

  if (( LAST_SHELL_STARTUP_MS > 300 )); then
    print -P "%F{yellow}Warning: shell startup ${LAST_SHELL_STARTUP_MS}ms (exceeds 300ms target)%f"
    print -P "%F{yellow}  Run: ZSH_PROFILE_STARTUP=1 zsh -i -c exit%f"
  fi

  unset ZSHRC_START_TIME _zshrc_elapsed
fi

# Conditional profiling output
if [[ -n "$ZSH_PROFILE_STARTUP" ]]; then
  zprof | head -20
fi
```

Important: Use integer comparison for the threshold (truncate to integer with `${_zshrc_elapsed%.*}`). Do NOT use `%.??` pattern — use `%.*` to strip decimal portion reliably. Do NOT unset LAST_SHELL_STARTUP_MS — it should remain exported for user inspection.
  </action>
  <verify>
Run `chezmoi apply --dry-run` to confirm no errors. Then verify with:
- `chezmoi cat ~/.zshenv | head -10` shows ZSHRC_START_TIME
- `chezmoi cat ~/.zshrc | tail -20` shows monitoring block
- Start new shell and check `echo $LAST_SHELL_STARTUP_MS` returns a number
- Run `ZSH_PROFILE_STARTUP=1 zsh -i -c exit` and confirm zprof output appears
  </verify>
  <done>
EPOCHREALTIME timing captures startup duration. LAST_SHELL_STARTUP_MS exported. Warning printed if > 300ms. zprof conditional profiling works via env var.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add chezmoi run_onchange_ hook for evalcache invalidation</name>
  <files>run_onchange_after_03-clear-evalcache.sh.tmpl</files>
  <action>
Create `~/.local/share/chezmoi/run_onchange_after_03-clear-evalcache.sh.tmpl` with:

```bash
#!/bin/bash
# Clears evalcache when tracked tool versions change.
# Only tracks tools cached via evalcache (Phase 20-02):
# oh-my-posh, zoxide, atuin, carapace, intelli-shell
# Does NOT track mise (directory-dependent, not cached).

{{- if eq .chezmoi.os "darwin" }}
# oh-my-posh: {{ output "oh-my-posh" "--version" | trim | sha256sum }}
# zoxide: {{ output "zoxide" "--version" | trim | sha256sum }}
# atuin: {{ output "atuin" "--version" | trim | sha256sum }}
# carapace: {{ output "carapace" "--version" | trim | sha256sum }}
{{- end }}

set -eufo pipefail

echo "==> Tool version changed, clearing evalcache..."
rm -rf "${HOME}/.zsh-evalcache" 2>/dev/null || true
echo "==> Evalcache cleared. Next shell startup will regenerate cache."
```

Notes:
- Use `run_onchange_after_03-` prefix so it runs after package installation (01) and cleanup (02) but in the after phase.
- Omit intelli-shell from version tracking if the `intelli-shell --version` command does not exist or fails — check first with `command -v intelli-shell` and `intelli-shell --version` before including. If it fails, leave it out and add a comment explaining why.
- Use direct `rm -rf` rather than spawning a zsh subshell with `_evalcache_clear` — simpler, more reliable from a bash script context.
- The `sha256sum` template function is a chezmoi builtin that produces a checksum. When any tool's version output changes, the script content changes, triggering chezmoi to re-run it.
  </action>
  <verify>
Run `chezmoi cat ~/run_onchange_after_03-clear-evalcache.sh.tmpl 2>/dev/null || chezmoi managed | grep evalcache` to confirm the file is tracked.
Run `chezmoi apply --dry-run` to confirm template renders without errors.
Verify the rendered script contains actual sha256 hashes (not template syntax).
  </verify>
  <done>
chezmoi run_onchange_ hook exists, tracks oh-my-posh/zoxide/atuin/carapace version checksums, clears ~/.zsh-evalcache when any version changes.
  </done>
</task>

</tasks>

<verification>
1. New shell starts without errors and LAST_SHELL_STARTUP_MS is set
2. `ZSH_PROFILE_STARTUP=1 zsh -i -c exit` shows zprof output
3. chezmoi managed includes the evalcache hook
4. chezmoi apply --dry-run shows no template errors
</verification>

<success_criteria>
- PROF-02 satisfied: startup time self-monitoring warns if > 300ms
- PERF-03 satisfied: chezmoi run_onchange_ hook clears evalcache on tool version change
- No measurable overhead added to normal shell startup (EPOCHREALTIME is native, near-zero cost)
</success_criteria>

<output>
After completion, create `.planning/phases/22-monitoring-hardening/22-01-SUMMARY.md`
</output>
