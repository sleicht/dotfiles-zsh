---
phase: 01-preparation-safety-net
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/test-linux.sh
  - .docker/Dockerfile.dotfiles-test
autonomous: true

must_haves:
  truths:
    - "User can start Ubuntu container with single command"
    - "Dotfiles are accessible inside container"
    - "Container has zsh and git installed for testing"
    - "Container can be destroyed and recreated quickly"
  artifacts:
    - path: "scripts/test-linux.sh"
      provides: "Linux test environment management"
      min_lines: 50
    - path: ".docker/Dockerfile.dotfiles-test"
      provides: "Ubuntu test container definition"
      contains: "ubuntu"
  key_links:
    - from: "scripts/test-linux.sh"
      to: ".docker/Dockerfile.dotfiles-test"
      via: "docker build"
      pattern: "docker.*build.*Dockerfile"
---

<objective>
Create Linux test environment using Docker/OrbStack for cross-platform dotfiles validation.

Purpose: Enable testing shell configuration on Linux before applying to live macOS system. Fast iteration with 2-second container startup (OrbStack) allows rapid test cycles.

Output: Script to manage Linux test container and Dockerfile defining the test environment.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-preparation-safety-net/01-CONTEXT.md
@.planning/phases/01-preparation-safety-net/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile for dotfiles testing</name>
  <files>.docker/Dockerfile.dotfiles-test</files>
  <action>
Create Dockerfile for Ubuntu-based dotfiles test environment:

**Base image:**
- Use `ubuntu:24.04` (LTS, current, matches research recommendation)

**Package installation:**
- Update package lists
- Install essential packages for dotfiles testing:
  - `zsh` (shell we're configuring)
  - `git` (for dotfiles operations)
  - `curl` (for downloading tools)
  - `wget` (backup downloader)
  - `sudo` (for testing commands that need it)
  - `locales` (for locale setup)
  - `build-essential` (for compiling tools if needed)

**Locale setup:**
- Generate `en_US.UTF-8` locale
- Set `LANG=en_US.UTF-8`

**User setup:**
- Create non-root user `tester` with sudo access
- Set home directory to `/home/tester`
- Set default shell to `/bin/zsh`

**Dotfiles mount point:**
- Create `/home/tester/.dotfiles` directory
- This will be mounted from host at runtime

**Working directory:**
- Set to `/home/tester`

**Default command:**
- `zsh` (drop into shell for interactive testing)

**Labels:**
- Add maintainer label
- Add description: "Ubuntu environment for dotfiles cross-platform testing"
  </action>
  <verify>
Dockerfile is valid:
```bash
mkdir -p .docker && \
cat .docker/Dockerfile.dotfiles-test && \
grep -q 'ubuntu:24.04\|ubuntu:22.04' .docker/Dockerfile.dotfiles-test && \
grep -q 'zsh' .docker/Dockerfile.dotfiles-test
```
  </verify>
  <done>Dockerfile defines Ubuntu environment with zsh, git, and proper user setup</done>
</task>

<task type="auto">
  <name>Task 2: Create Linux test management script</name>
  <files>scripts/test-linux.sh</files>
  <action>
Create script to manage Linux test container (supports both OrbStack and Docker):

**Structure:**
```bash
#!/usr/bin/env bash
set -euo pipefail
```

**Configuration:**
- `CONTAINER_NAME="dotfiles-test"`
- `IMAGE_NAME="dotfiles-test:latest"`
- `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`
- `DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"` (parent of scripts/)
- `DOCKERFILE_PATH="$DOTFILES_DIR/.docker/Dockerfile.dotfiles-test"`

**Runtime detection:**
Detect whether OrbStack or Docker is available:
```bash
if command -v orb &>/dev/null; then
  RUNTIME="orbstack"
elif command -v docker &>/dev/null; then
  RUNTIME="docker"
else
  echo "ERROR: Neither OrbStack nor Docker found"
  echo "Install OrbStack: brew install --cask orbstack"
  echo "Or Docker: brew install --cask docker"
  exit 1
fi
```

**Commands (subcommand pattern):**

`build` - Build the test image:
```bash
cmd_build() {
  echo "Building test image..."
  docker build -t "$IMAGE_NAME" -f "$DOCKERFILE_PATH" "$DOTFILES_DIR/.docker"
}
```

`start` - Start container with dotfiles mounted:
```bash
cmd_start() {
  echo "Starting $CONTAINER_NAME..."
  docker run -it --rm \
    --name "$CONTAINER_NAME" \
    -v "$DOTFILES_DIR:/home/tester/.dotfiles:ro" \
    -w /home/tester \
    "$IMAGE_NAME"
}
```

`shell` - Enter running container:
```bash
cmd_shell() {
  docker exec -it "$CONTAINER_NAME" zsh
}
```

`test` - Run install script in container and verify:
```bash
cmd_test() {
  echo "Testing dotfiles installation..."
  docker run --rm \
    -v "$DOTFILES_DIR:/home/tester/.dotfiles:ro" \
    "$IMAGE_NAME" \
    bash -c 'cd ~/.dotfiles && ./install && exec zsh -c "echo Shell loaded successfully"'
}
```

`clean` - Remove container and image:
```bash
cmd_clean() {
  docker rm -f "$CONTAINER_NAME" 2>/dev/null || true
  docker rmi "$IMAGE_NAME" 2>/dev/null || true
  echo "Cleaned up test environment"
}
```

**OrbStack optimisations:**
If OrbStack detected, use `orb` commands for faster operations:
- `orb create ubuntu:24.04 $CONTAINER_NAME` instead of docker run
- `orb push` for file copying
- `orb enter` for shell access

**Usage help:**
```bash
cmd_help() {
  cat <<EOF
Linux Dotfiles Test Environment

Usage: $0 <command>

Commands:
  build   Build the test Docker image
  start   Start interactive test container
  shell   Enter running container
  test    Run automated installation test
  clean   Remove container and image
  help    Show this help

Examples:
  $0 build        # Build image first
  $0 start        # Start interactive session
  $0 test         # Quick automated test
EOF
}
```

**Main dispatch:**
Parse `$1` and call appropriate `cmd_*` function.
  </action>
  <verify>
Script passes syntax check and has expected commands:
```bash
chmod +x scripts/test-linux.sh && \
bash -n scripts/test-linux.sh && \
grep -q 'cmd_build\|build)' scripts/test-linux.sh && \
grep -q 'cmd_start\|start)' scripts/test-linux.sh && \
grep -q 'docker\|orb' scripts/test-linux.sh
```
  </verify>
  <done>Test script provides build, start, shell, test, and clean commands with OrbStack/Docker support</done>
</task>

</tasks>

<verification>
Verify both files exist and are properly structured:
```bash
# Check Dockerfile
cat .docker/Dockerfile.dotfiles-test

# Check script syntax
bash -n scripts/test-linux.sh

# Verify script help works (without actually running Docker)
grep -A20 'cmd_help\|Usage:' scripts/test-linux.sh
```
</verification>

<success_criteria>
1. `.docker/Dockerfile.dotfiles-test` exists with Ubuntu 24.04 base
2. Dockerfile installs zsh, git, and creates non-root user
3. `scripts/test-linux.sh` passes syntax check
4. Test script detects OrbStack vs Docker runtime
5. Test script provides build, start, shell, test, clean commands
6. Test script mounts dotfiles directory into container
</success_criteria>

<output>
After completion, create `.planning/phases/01-preparation-safety-net/01-03-SUMMARY.md`
</output>
