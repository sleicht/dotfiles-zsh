---
phase: 01-preparation-safety-net
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/dotfiles-backup-exclusions
  - scripts/backup-dotfiles.sh
autonomous: true

must_haves:
  truths:
    - "Backup script fails gracefully if external drive not mounted"
    - "Large files (>100MB) are detected and shown before backup proceeds"
    - "Symlinks are preserved in main backup"
    - "Standard cache/temp directories are excluded from backup"
  artifacts:
    - path: "scripts/dotfiles-backup-exclusions"
      provides: "Exclusion patterns for rsync backup"
      contains: ".cache/"
    - path: "scripts/backup-dotfiles.sh"
      provides: "rsync-based backup with pre-flight checks"
      min_lines: 80
  key_links:
    - from: "scripts/backup-dotfiles.sh"
      to: "scripts/dotfiles-backup-exclusions"
      via: "--exclude-from flag"
      pattern: "exclude-from.*dotfiles-backup-exclusions"
---

<objective>
Create backup infrastructure: exclusion file defining what to skip, and backup script with pre-flight validation.

Purpose: Enable complete, browsable backup of dotfiles state before migration begins. External drive requirement ensures safety net is physically separate from source.

Output: Two executable scripts in `scripts/` directory ready for initial backup.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-preparation-safety-net/01-CONTEXT.md
@.planning/phases/01-preparation-safety-net/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backup exclusions file</name>
  <files>scripts/dotfiles-backup-exclusions</files>
  <action>
Create a comprehensive exclusion file for rsync backup. Include standard patterns from research:

**Must exclude (caches/temp):**
- `.cache/`
- `.Trash/`
- `.npm/_cacache/`
- `.node-gyp/`
- `node_modules/`
- `.DS_Store`
- `*.log`
- `*.tmp`
- `*.pyc`
- `__pycache__/`
- `.venv/`
- `*.zwc` (zsh compiled files)

**Must exclude (large binaries/IDE):**
- `.gradle/`
- `.m2/` (Maven)
- `.cargo/registry/`
- `.rustup/`
- `Library/` (macOS - too large, not dotfiles)
- `Applications/`
- `Downloads/`
- `Movies/`
- `Music/`
- `Pictures/`
- `.android/`
- `.docker/` (Docker images can be huge)
- `.orbstack/` (OrbStack VMs)

**Must exclude (private/sensitive - handled separately):**
- `.ssh/` (backed up via separate secure method)
- `.gnupg/`
- `.aws/`
- `.kube/` (may contain tokens)

Add header comment explaining the file's purpose and that it's used by backup-dotfiles.sh.
  </action>
  <verify>
File exists and contains expected patterns:
```bash
grep -q ".cache/" scripts/dotfiles-backup-exclusions && \
grep -q "node_modules/" scripts/dotfiles-backup-exclusions && \
grep -q "Library/" scripts/dotfiles-backup-exclusions
```
  </verify>
  <done>Exclusion file contains comprehensive patterns covering caches, large directories, and sensitive files</done>
</task>

<task type="auto">
  <name>Task 2: Create backup script with pre-flight checks</name>
  <files>scripts/backup-dotfiles.sh</files>
  <action>
Create bash script implementing patterns from RESEARCH.md:

**Structure:**
```bash
#!/usr/bin/env bash
set -euo pipefail
```

**Configuration section:**
- `BACKUP_DRIVE="/Volumes/Backup"` (configurable via env var)
- `BACKUP_DIR="$BACKUP_DRIVE/dotfiles-backup"`
- `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`
- `EXCLUSIONS="$SCRIPT_DIR/dotfiles-backup-exclusions"`

**Mount detection (from research Pattern 4):**
- Check `[ -d "$BACKUP_DRIVE" ]`
- If not mounted, print clear error with instructions (connect drive, list /Volumes/)
- Exit 1 if not mounted

**Pre-flight scan (from research Pattern 2):**
- Scan for files >100MB in home directory
- Use macOS-compatible find: `find "$HOME" -type f -size +100M 2>/dev/null`
- Display top 20 largest files with human-readable sizes
- Prompt user to continue: `read -p "Continue with backup? (y/n) " -n 1 -r`
- Exit if user declines

**Dry-run mode:**
- Accept `--dry-run` flag
- Default to dry-run mode for safety (set `DRY_RUN=true` initially)
- When `--execute` flag passed, set `DRY_RUN=false`

**Main backup (from research Pattern 1):**
- rsync with archive mode: `-av --progress --stats`
- Use `--exclude-from="$EXCLUSIONS"`
- Mirror from `$HOME/.` to `$BACKUP_DIR/`
- Log output to `$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).log`

**Symlink dereferencing (dual approach):**
- After main backup, run second rsync with `-avL` to `$BACKUP_DIR/_symlinks_resolved/`
- Only dereference dotfiles: `--include='.*' --exclude='*'`

**Metadata capture:**
- Write `$BACKUP_DIR/backup-metadata.txt` with:
  - Timestamp
  - Source machine hostname
  - Source user
  - Count of files backed up

**Exit handling:**
- Print summary: files transferred, total size, time elapsed
- If dry-run, remind user to run with `--execute` for real backup
  </action>
  <verify>
Script is executable and validates correctly:
```bash
chmod +x scripts/backup-dotfiles.sh && \
bash -n scripts/backup-dotfiles.sh && \
grep -q 'BACKUP_DRIVE' scripts/backup-dotfiles.sh && \
grep -q 'exclude-from' scripts/backup-dotfiles.sh && \
grep -q 'dry-run\|DRY_RUN' scripts/backup-dotfiles.sh
```
  </verify>
  <done>Backup script handles mount detection, pre-flight checks, dry-run mode, and dual symlink handling</done>
</task>

</tasks>

<verification>
Run syntax check and verify key patterns:
```bash
# Syntax validation
bash -n scripts/backup-dotfiles.sh

# Verify exclusions file has content
wc -l scripts/dotfiles-backup-exclusions

# Verify script references exclusions file
grep "dotfiles-backup-exclusions" scripts/backup-dotfiles.sh
```
</verification>

<success_criteria>
1. `scripts/dotfiles-backup-exclusions` exists with 20+ exclusion patterns
2. `scripts/backup-dotfiles.sh` passes bash syntax check
3. Backup script checks for external drive before proceeding
4. Backup script has pre-flight file size scanning
5. Backup script defaults to dry-run mode for safety
</success_criteria>

<output>
After completion, create `.planning/phases/01-preparation-safety-net/01-01-SUMMARY.md`
</output>
