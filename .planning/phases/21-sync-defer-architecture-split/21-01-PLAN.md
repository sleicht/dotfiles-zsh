---
phase: 21-sync-defer-architecture-split
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dot_zsh.d/hooks.zsh
  - dot_zsh.d/prompt.zsh
  - dot_zsh.d/external.zsh
  - dot_zsh.d/external-sync.zsh
  - dot_zsh.d/external-defer.zsh
  - dot_zsh.d/completions.zsh
  - dot_zsh.d/completions-sync.zsh
  - dot_zsh.d/completions-defer.zsh
  - dot_zsh.d/ssh.zsh
  - dot_zsh.d/ssh-defer.zsh
  - dot_zprofile
autonomous: true

must_haves:
  truths:
    - "Shell prompt renders correctly on startup (oh-my-posh sync)"
    - "FZF exports are available before deferred plugins load"
    - "Completion zstyles are set before compinit runs"
    - "mise tools available immediately via shims in .zprofile"
    - "Deferred tools (zoxide, mise, ssh-add) become available shortly after prompt without slowing first render"
  artifacts:
    - path: "dot_zsh.d/prompt.zsh"
      provides: "Sync prompt init (oh-my-posh + preexec)"
    - path: "dot_zsh.d/external-sync.zsh"
      provides: "FZF exports and compgen functions"
    - path: "dot_zsh.d/external-defer.zsh"
      provides: "Deferred zoxide and mise activation"
    - path: "dot_zsh.d/completions-sync.zsh"
      provides: "Completion foundation (zstyles, colors, word-style)"
    - path: "dot_zsh.d/completions-defer.zsh"
      provides: "Deferred SSH hosts, bun, phantom completions"
    - path: "dot_zsh.d/ssh-defer.zsh"
      provides: "Deferred ssh-add keychain loading"
    - path: "dot_zprofile"
      provides: "mise shims PATH fallback for login shells"
  key_links:
    - from: "dot_zsh.d/external-sync.zsh"
      to: "fzf-tab plugin"
      via: "FZF_DEFAULT_COMMAND export available before defer"
      pattern: "export FZF_DEFAULT_COMMAND"
    - from: "dot_zprofile"
      to: "dot_zsh.d/external-defer.zsh"
      via: "shims provide PATH fallback until full mise activate defers"
      pattern: "mise activate zsh --shims"
---

<objective>
Split existing zsh.d files into sync and defer variants, preparing for Sheldon plugin group reconfiguration in Plan 02.

Purpose: Separate prompt-critical initialisation from deferrable work so Sheldon can load them with different apply strategies.
Output: New sync/defer file pairs replacing hooks.zsh, external.zsh, completions.zsh; renamed ssh-defer.zsh; updated .zprofile with mise shims.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-sync-defer-architecture-split/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split hooks.zsh, external.zsh, and completions.zsh into sync/defer pairs</name>
  <files>
    ~/.local/share/chezmoi/dot_zsh.d/hooks.zsh
    ~/.local/share/chezmoi/dot_zsh.d/prompt.zsh
    ~/.local/share/chezmoi/dot_zsh.d/external.zsh
    ~/.local/share/chezmoi/dot_zsh.d/external-sync.zsh
    ~/.local/share/chezmoi/dot_zsh.d/external-defer.zsh
    ~/.local/share/chezmoi/dot_zsh.d/completions.zsh
    ~/.local/share/chezmoi/dot_zsh.d/completions-sync.zsh
    ~/.local/share/chezmoi/dot_zsh.d/completions-defer.zsh
  </files>
  <action>
    **Create `prompt.zsh`** (sync, prompt-critical):
    - oh-my-posh evalcache init (from hooks.zsh lines 11-13)
    - `preexec() { print '' }` (from hooks.zsh line 24)
    - That's it. No HOMEBREW_PREFIX detection, no FZF sourcing, no atuin keybindings, no REPOSITORIES_PATH vars.

    **Delete `hooks.zsh`** entirely. Its contents are redistributed:
    - oh-my-posh + preexec → prompt.zsh (above)
    - HOMEBREW_PREFIX detection (lines 4-8) → already duplicated in completions.zsh, not needed again
    - REPOSITORIES_PATH vars (lines 15-16, 26-27) → move to variables.zsh if still needed. Check if used elsewhere first. If not used, drop them.
    - FZF completion/key-bindings sourcing (lines 18-19) → keep in prompt.zsh for now (these provide Ctrl+T, Alt+C which are distinct from fzf-git). Research open question 1 says to keep if unsure.
    - atuin-keybindings.zsh sourcing (line 20) → keep in prompt.zsh for now (keybindings must be sync per research decision tree). Note: atuin init already sets up bindings when ATUIN_NOBIND is not set (it's commented out in atuin.zsh), but the separate keybindings file may provide additional bindings. Keep to be safe.

    Actually, re-reading the research more carefully: FZF key-bindings and atuin keybindings are interactive-use-immediately items that define keybindings/widgets → SYNC per the decision tree. So they belong in prompt.zsh (or a sync file). Keep them in prompt.zsh alongside oh-my-posh. Include the HOMEBREW_PREFIX detection needed for FZF paths.

    **Final prompt.zsh content:**
    ```zsh
    # Managed by chezmoi - edit in ~/.local/share/chezmoi/dot_zsh.d/
    #!/usr/bin/env zsh

    if [ "$(uname -m)" = "x86_64" ]; then
      : "${HOMEBREW_PREFIX:=/usr/local}"
    elif [ "$(uname -m)" = "arm64" ]; then
      : "${HOMEBREW_PREFIX:=/opt/homebrew}"
    fi

    # Prompt: must be sync (sets precmd hooks)
    if (( $+commands[oh-my-posh] )); then
      _evalcache oh-my-posh init zsh --config ~/.config/oh-my-posh.omp.json
    fi

    # FZF keybindings: must be sync (Ctrl+T, Alt+C widgets)
    if [ -r "$HOMEBREW_PREFIX/opt/fzf/shell/completion.zsh" ]; then source "$HOMEBREW_PREFIX/opt/fzf/shell/completion.zsh"; fi
    if [ -r "$HOMEBREW_PREFIX/opt/fzf/shell/key-bindings.zsh" ]; then source "$HOMEBREW_PREFIX/opt/fzf/shell/key-bindings.zsh"; fi

    # Atuin keybindings: must be sync (Ctrl+R widget)
    source "$XDG_CONFIG_HOME/atuin/atuin-keybindings.zsh"

    preexec() { print '' }
    ```

    **Create `external-sync.zsh`** from external.zsh lines 1-44 (FZF exports + compgen functions). Keep exact content, just the FZF section.

    **Create `external-defer.zsh`** from external.zsh lines 49-67 (zoxide + mise). Content unchanged except add `if (( $+commands[mise] ))` guard around mise activate.

    **Delete `external.zsh`** — fully replaced by the two new files.

    **Create `completions-sync.zsh`** from completions.zsh: HOMEBREW_PREFIX detection (lines 4-8), colors autoload (lines 21-22), select-word-style (lines 24-25), zle zstyles (lines 27-28), predict (lines 30-33), completion zstyles (lines 34-46). Everything except SSH hosts, bun, and phantom.

    **Create `completions-defer.zsh`** from completions.zsh: SSH host cache (lines 16-19), bun completions (lines 48-49), phantom completions (lines 51-54).

    **Delete `completions.zsh`** — fully replaced by the two new files.

    Check if REPOSITORIES_PATH variables (from hooks.zsh) are used anywhere else in zsh.d. If not referenced, drop them. If referenced, add to variables.zsh.
  </action>
  <verify>
    - `ls ~/.local/share/chezmoi/dot_zsh.d/` shows prompt.zsh, external-sync.zsh, external-defer.zsh, completions-sync.zsh, completions-defer.zsh
    - hooks.zsh, external.zsh, completions.zsh are deleted
    - `chezmoi diff` shows the file changes
    - No content lost: grep for oh-my-posh, FZF_DEFAULT_COMMAND, zoxide, mise, _cache_hosts, predict-on confirms all present in new files
    - Keybinding verification: `zsh -i -c 'bindkey "^T"'` shows fzf-file-widget (FZF Ctrl+T), `zsh -i -c 'bindkey "^R"'` shows atuin search (Ctrl+R). If either missing, check source ordering in prompt.zsh.
  </verify>
  <done>
    Three original files (hooks.zsh, external.zsh, completions.zsh) replaced by five new files (prompt.zsh, external-sync.zsh, external-defer.zsh, completions-sync.zsh, completions-defer.zsh) with no functionality loss.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rename ssh.zsh to ssh-defer.zsh and add mise shims to .zprofile</name>
  <files>
    ~/.local/share/chezmoi/dot_zsh.d/ssh.zsh
    ~/.local/share/chezmoi/dot_zsh.d/ssh-defer.zsh
    ~/.local/share/chezmoi/dot_zprofile
  </files>
  <action>
    **Rename `ssh.zsh` to `ssh-defer.zsh`**: Content unchanged (just `ssh-add --apple-load-keychain &> /dev/null`). Delete the old file via chezmoi (`chezmoi forget dot_zsh.d/ssh.zsh` or just remove from source dir and add new file).

    Actually, since these are chezmoi source files, just:
    1. `mv ~/.local/share/chezmoi/dot_zsh.d/ssh.zsh ~/.local/share/chezmoi/dot_zsh.d/ssh-defer.zsh`
    2. Run `chezmoi apply` to remove old ~/.zsh.d/ssh.zsh and create ~/.zsh.d/ssh-defer.zsh

    **Update `dot_zprofile`**: Add mise shims activation at the end:
    ```zsh
    # mise shims: immediate PATH access (full activation deferred in .zshrc)
    if (( $+commands[mise] )); then
      eval "$(mise activate zsh --shims)"
    fi
    ```

    Note: .zprofile runs for login shells. `(( $+commands[mise] ))` requires mise on PATH already (Homebrew provides it via brew shellenv above). This is correct ordering.
  </action>
  <verify>
    - `ls ~/.local/share/chezmoi/dot_zsh.d/ssh*` shows only ssh-defer.zsh
    - `grep "mise activate zsh --shims" ~/.local/share/chezmoi/dot_zprofile` returns a match
    - `chezmoi diff` shows ssh.zsh removal, ssh-defer.zsh creation, .zprofile addition
  </verify>
  <done>
    ssh.zsh renamed to ssh-defer.zsh for defer group placement. .zprofile provides mise shims as immediate PATH fallback before deferred full activation.
  </done>
</task>

</tasks>

<verification>
1. All original file content accounted for in new files (no lost configuration)
2. Sync files contain only prompt-critical and keybinding code
3. Defer files contain only non-critical initialisation
4. .zprofile has mise shims for immediate tool access
5. chezmoi source directory has correct file structure
</verification>

<success_criteria>
- Six new/renamed files exist in chezmoi source (prompt.zsh, external-sync.zsh, external-defer.zsh, completions-sync.zsh, completions-defer.zsh, ssh-defer.zsh)
- Three old files removed (hooks.zsh, external.zsh, completions.zsh)
- .zprofile updated with mise shims
- `chezmoi apply` succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-sync-defer-architecture-split/21-01-SUMMARY.md`
</output>
