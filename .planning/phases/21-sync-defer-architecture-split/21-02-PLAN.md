---
phase: 21-sync-defer-architecture-split
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - private_dot_config/sheldon/plugins.toml
autonomous: true

must_haves:
  truths:
    - "Sheldon loads sync dotfiles with source apply (prompt.zsh, external-sync.zsh, completions-sync.zsh, aliases, functions, variables, keybinds, path)"
    - "Sheldon loads defer dotfiles with defer apply (external-defer.zsh, completions-defer.zsh, atuin.zsh, carapace.zsh, intelli-shell.zsh, ssh-defer.zsh, lens-completion.zsh, wt.zsh, xlaude.zsh)"
    - "Shell starts without errors after chezmoi apply"
    - "Perceived startup is faster (prompt appears before deferred work completes)"
  artifacts:
    - path: "private_dot_config/sheldon/plugins.toml"
      provides: "Sheldon config with dotfiles-sync and dotfiles-defer plugin groups"
      contains: "dotfiles-sync"
  key_links:
    - from: "plugins.toml dotfiles-sync"
      to: "prompt.zsh, external-sync.zsh, completions-sync.zsh"
      via: "apply = [\"source\"]"
      pattern: "dotfiles-sync"
    - from: "plugins.toml dotfiles-defer"
      to: "external-defer.zsh, completions-defer.zsh, atuin.zsh, ssh-defer.zsh"
      via: "apply = [\"defer\"]"
      pattern: "dotfiles-defer"
---

<objective>
Reconfigure Sheldon plugins.toml to split dotfiles into sync and defer groups, then measure perceived startup improvement.

Purpose: Wire the file splits from Plan 01 into Sheldon's loading mechanism so non-critical work defers until after first prompt.
Output: Updated plugins.toml with two dotfile groups; measured startup time showing perceived improvement.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-sync-defer-architecture-split/21-01-SUMMARY.md
@.planning/phases/21-sync-defer-architecture-split/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reconfigure plugins.toml with sync and defer dotfile groups</name>
  <files>
    ~/.local/share/chezmoi/private_dot_config/sheldon/plugins.toml
  </files>
  <action>
    Replace the single `[plugins.dotfiles]` entry (currently `use = ["*.zsh"]`, `apply = ["source"]`) with two entries:

    ```toml
    [plugins.dotfiles-sync]
    local = "~/.zsh.d"
    use = ["prompt.zsh", "external-sync.zsh", "completions-sync.zsh", "aliases.zsh", "functions.zsh", "variables.zsh", "keybinds.zsh", "path.zsh"]
    apply = ["source"]

    [plugins.dotfiles-defer]
    local = "~/.zsh.d"
    use = ["external-defer.zsh", "completions-defer.zsh", "atuin.zsh", "carapace.zsh", "intelli-shell.zsh", "ssh-defer.zsh", "lens-completion.zsh", "wt.zsh", "xlaude.zsh"]
    apply = ["defer"]
    ```

    **Important ordering:** dotfiles-sync MUST appear before the deferred external plugins (fzf-tab, fzf-git, etc.) so FZF exports are available. dotfiles-defer SHOULD appear after external deferred plugins (current position of dotfiles at the end is correct for the defer group).

    Keep dotfiles-private unchanged (it stays sync, after dotfiles-sync).

    Note: path.zsh is actually path.zsh.tmpl in chezmoi source but renders as path.zsh in target. The `use` pattern should reference the target filename (path.zsh), not the template name.

    After editing, run:
    1. `chezmoi apply` to deploy all changes
    2. Open a new shell to verify it starts without errors
    3. Run `sheldon lock --update` to regenerate the lock file with new plugin groups
  </action>
  <verify>
    - `grep -c 'dotfiles-sync\|dotfiles-defer' ~/.local/share/chezmoi/private_dot_config/sheldon/plugins.toml` returns 2
    - `grep -c '\[plugins\.dotfiles\]' ~/.local/share/chezmoi/private_dot_config/sheldon/plugins.toml` returns 0 (old entry removed)
    - `chezmoi apply` exits 0
    - `zsh -i -c 'echo ok'` prints "ok" without errors
  </verify>
  <done>
    plugins.toml has dotfiles-sync (source) and dotfiles-defer (defer) groups replacing the single dotfiles group. Shell starts without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Measure perceived and total startup time improvement</name>
  <files></files>
  <action>
    Run three measurements:

    1. **hyperfine** (total time, includes deferred work):
       `hyperfine --warmup 3 --runs 10 'zsh -i -c exit'`
       Record median. Expected: similar to 131.2ms baseline (deferred work still runs before exit).

    2. **zsh-bench** (perceived time, first prompt lag):
       `zsh-bench`
       Record `first_prompt_lag_ms`. Expected: significantly lower than 131.2ms.

    3. **Functional smoke test** â€” verify in a new interactive shell:
       - `oh-my-posh --version` (prompt works)
       - Ctrl+T triggers FZF file finder
       - `z` command works (zoxide, may need a moment to defer-load)
       - `mise --version` (available via shims immediately)
       - Tab completion works

    Document results comparing to Phase 20 baseline (131.2ms hyperfine).
  </action>
  <verify>
    - hyperfine output captured
    - zsh-bench output captured
    - Functional smoke test passes (all tools accessible)
  </verify>
  <done>
    Startup time measured. First prompt lag (perceived time) is lower than 131.2ms total time. All tools functional.
  </done>
</task>

</tasks>

<verification>
1. plugins.toml has exactly two dotfile groups (sync + defer)
2. Shell starts without errors
3. Prompt renders correctly (oh-my-posh)
4. FZF, zoxide, mise, atuin, completions all functional
5. Perceived startup time measured and documented
</verification>

<success_criteria>
- plugins.toml reconfigured with dotfiles-sync and dotfiles-defer
- Shell startup has no errors
- First prompt lag (zsh-bench) shows improvement over 131.2ms baseline
- All deferred tools become available shortly after prompt
</success_criteria>

<output>
After completion, create `.planning/phases/21-sync-defer-architecture-split/21-02-SUMMARY.md`
</output>
