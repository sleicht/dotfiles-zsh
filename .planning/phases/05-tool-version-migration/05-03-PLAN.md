---
phase: 05-tool-version-migration
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - ~/.local/share/chezmoi/.chezmoidata.yaml
  - ~/.local/share/chezmoi/run_once_after_cleanup-homebrew-runtimes.sh.tmpl
autonomous: true

must_haves:
  truths:
    - "User has no Homebrew-installed node (mise manages it exclusively)"
    - "User has rust removed from Homebrew (mise handles rust via stable channel)"
    - "User sees mise-managed runtimes when running which node, which ruby"
  artifacts:
    - path: "~/.local/share/chezmoi/.chezmoidata.yaml"
      provides: "Package data without runtime conflicts"
      min_lines: 100
    - path: "~/.local/share/chezmoi/run_once_after_cleanup-homebrew-runtimes.sh.tmpl"
      provides: "Cleanup script for conflicting Homebrew packages"
      contains: "brew uninstall"
  key_links:
    - from: "mise"
      to: "PATH"
      via: "mise activate precedes Homebrew in PATH"
      pattern: "mise/installs"
---

<objective>
Remove Homebrew-installed runtimes that conflict with mise management.

Purpose: Ensure mise has exclusive control over runtime versions (node, rust) to prevent PATH conflicts and version confusion. Python via Homebrew is kept as it's a build dependency for other formulae.

Output: Homebrew node and rust removed, .chezmoidata.yaml updated to prevent re-installation, mise-managed versions take precedence.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tool-version-migration/05-CONTEXT.md
@.planning/phases/05-tool-version-migration/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update .chezmoidata.yaml to remove conflicting packages</name>
  <files>~/.local/share/chezmoi/.chezmoidata.yaml</files>
  <action>
Edit .chezmoidata.yaml to remove packages that conflict with mise:

1. In `client_brews:` section, remove:
   - `rust` (line with `- "rust"`) - mise manages rust via stable channel
   - `volta` (line with `- "volta"`) - mise replaces Volta for node management
   - `rbenv` (line with `- "rbenv"`) - mise manages ruby

2. In `fanaka_brews:` section, remove:
   - `rust` (line with `- "rust"`) - mise manages rust via stable channel
   - `rbenv` (line with `- "rbenv"`) - mise manages ruby

3. In `common_brews:` section:
   - Verify `node` is NOT present (should not be, good)
   - Keep `mise` (already there, good)

Note: Keep python@3.12, python@3.13, python@3.14 if they exist as Homebrew dependencies - they use versioned paths and don't conflict with mise's python management.

These packages conflict with mise because:
- node: mise manages node versions, Homebrew node would take PATH precedence
- rust: mise manages rust stable/nightly, Homebrew rust creates conflicts
- volta: Redundant with mise for node version management
- rbenv: mise manages ruby versions directly
  </action>
  <verify>
- `grep -c "volta" ~/.local/share/chezmoi/.chezmoidata.yaml` returns 0
- `grep -c '"rbenv"' ~/.local/share/chezmoi/.chezmoidata.yaml` returns 0
- client_brews and fanaka_brews sections have rust removed
  </verify>
  <done>.chezmoidata.yaml no longer includes packages that conflict with mise</done>
</task>

<task type="auto">
  <name>Task 2: Create cleanup script for existing Homebrew runtimes</name>
  <files>~/.local/share/chezmoi/run_once_after_cleanup-homebrew-runtimes.sh.tmpl</files>
  <action>
Create a run_once script that removes conflicting Homebrew packages:

```bash
{{- if eq .chezmoi.os "darwin" }}
#!/bin/bash
# Remove Homebrew-installed runtimes that conflict with mise
# Runs once after initial chezmoi apply

set -e

echo "=== Cleaning up Homebrew runtimes (mise will manage these) ==="

# Packages to remove (mise handles these)
CONFLICTS=("node" "rust" "volta" "rbenv")

for pkg in "${CONFLICTS[@]}"; do
    if brew list "$pkg" &>/dev/null; then
        echo "Removing $pkg (mise will manage this)..."
        brew uninstall --ignore-dependencies "$pkg" || true
    fi
done

# Note: python@3.x packages are kept as they're build dependencies
# They use versioned paths (/opt/homebrew/opt/python@3.12/bin)
# and don't conflict with mise's python management

echo "=== Homebrew runtime cleanup complete ==="
echo "Mise now exclusively manages: node, python, go, rust, java, ruby, terraform"
{{- end }}
```

Using:
- `run_once_after_` ensures it only runs once
- `--ignore-dependencies` allows removing even if other formulae depend on it
- `|| true` prevents failure if package not installed
  </action>
  <verify>
- File exists at `~/.local/share/chezmoi/run_once_after_cleanup-homebrew-runtimes.sh.tmpl`
- Contains `brew uninstall` commands for node, rust, volta, rbenv
- Has darwin conditional
  </verify>
  <done>Cleanup script created to remove conflicting Homebrew packages</done>
</task>

<task type="auto">
  <name>Task 3: Apply chezmoi and verify no conflicts</name>
  <files>None (verification only)</files>
  <action>
1. Run `chezmoi apply` to execute the cleanup script

2. Verify Homebrew packages removed:
   - `brew list | grep -E '^node$'` should return nothing
   - `brew list | grep -E '^rust$'` should return nothing
   - `brew list | grep -E '^volta$'` should return nothing
   - `brew list | grep -E '^rbenv$'` should return nothing

3. Verify mise manages runtimes:
   - `which node` should show ~/.local/share/mise/installs/node/...
   - `which ruby` should show ~/.local/share/mise/installs/ruby/...

4. Verify mise tools still work:
   - `node --version` shows version
   - `ruby --version` shows version

5. Run `brew bundle check --global` to verify Brewfile still valid (will pass since conflicts removed from both)
  </action>
  <verify>
- `brew list node 2>/dev/null; echo $?` returns non-zero (not installed)
- `which node | grep mise` shows mise path
- `mise current` shows active versions
  </verify>
  <done>Homebrew runtime conflicts removed, mise has exclusive control</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. No Homebrew conflicts:
   - `brew list | grep -E '^(node|rust|volta|rbenv)$'` returns empty
   - `brew bundle check --global` passes

2. Mise in control:
   - `which node` -> ~/.local/share/mise/installs/node/...
   - `which ruby` -> ~/.local/share/mise/installs/ruby/...
   - `node --version` and `ruby --version` work

3. Brewfile consistency:
   - .chezmoidata.yaml doesn't include removed packages
   - Generated Brewfile won't try to reinstall them
</verification>

<success_criteria>
- .chezmoidata.yaml updated (node, rust, volta, rbenv removed from client/fanaka lists)
- Homebrew node, rust, volta, rbenv uninstalled
- `which node` and `which ruby` show mise-managed paths
- `brew bundle check --global` passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-tool-version-migration/05-03-SUMMARY.md`
</output>
