---
phase: 05-tool-version-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.local/share/chezmoi/dot_zsh.d/hooks.zsh
  - ~/.local/share/chezmoi/run_once_after_generate-mise-completions.sh.tmpl
autonomous: true

must_haves:
  truths:
    - "User has mise activated in shell startup"
    - "User can use mise commands with tab completion"
    - "User experiences zero runtime overhead when calling tools (via mise activate, not shims)"
  artifacts:
    - path: "~/.local/share/chezmoi/dot_zsh.d/hooks.zsh"
      provides: "Shell activation for mise"
      contains: "mise activate zsh"
    - path: "~/.local/share/chezmoi/run_once_after_generate-mise-completions.sh.tmpl"
      provides: "Completion generation script"
      contains: "mise completion"
  key_links:
    - from: "~/.zsh.d/hooks.zsh"
      to: "mise"
      via: "eval mise activate"
      pattern: 'eval "\$\(mise activate'
    - from: "~/.local/share/zsh/site-functions/_mise"
      to: "mise completion"
      via: "run script generation"
      pattern: "_mise"
---

<objective>
Enable mise shell integration and completions for optimal interactive experience.

Purpose: Activate mise in the shell to get zero-overhead PATH updates when changing directories, and provide tab completion for mise commands.

Output: hooks.zsh with mise activate enabled, completion file generated at ~/.local/share/zsh/site-functions/_mise.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-tool-version-migration/05-CONTEXT.md
@.planning/phases/05-tool-version-migration/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable mise activate in hooks.zsh</name>
  <files>~/.local/share/chezmoi/dot_zsh.d/hooks.zsh</files>
  <action>
Edit hooks.zsh to:

1. Uncomment the mise activate line (line 12):
   Change: `#if command -v mise > /dev/null; then eval "$(mise activate zsh)"; fi`
   To: `if command -v mise > /dev/null; then eval "$(mise activate zsh)"; fi`

2. Remove or keep commented the asdf line (line 13) since asdf is not installed:
   Keep as: `#if command -v asdf > /dev/null; then . "$HOMEBREW_PREFIX/share/zsh/site-functions/_asdf"; fi`

3. Remove the commented terraform completion block (lines 25-28) - mise handles this:
   Delete these lines:
   ```
   #if command -v mise > /dev/null && [ -f "$(mise which terraform)" ]; then
   #  autoload -U +X bashcompinit && bashcompinit
   #  complete -o nospace -C "$(mise which terraform)" terraform
   #fi
   ```

Note: Using `mise activate` (not shims) for zero runtime overhead in interactive shells.
  </action>
  <verify>
- `grep "mise activate zsh" ~/.local/share/chezmoi/dot_zsh.d/hooks.zsh` shows uncommented line
- Line does NOT start with `#`
  </verify>
  <done>hooks.zsh has mise activate enabled (uncommented)</done>
</task>

<task type="auto">
  <name>Task 2: Create completion generation run script</name>
  <files>~/.local/share/chezmoi/run_once_after_generate-mise-completions.sh.tmpl</files>
  <action>
Create a run_once script that generates mise completions:

```bash
{{- if eq .chezmoi.os "darwin" }}
#!/bin/bash
# Generate mise completions for ZSH
# Runs once after initial chezmoi apply

set -e

# Create completions directory if needed
COMP_DIR="${HOME}/.local/share/zsh/site-functions"
mkdir -p "$COMP_DIR"

# Generate mise completions
if command -v mise > /dev/null; then
    mise completion zsh > "$COMP_DIR/_mise"
    echo "Generated mise completions at $COMP_DIR/_mise"
else
    echo "WARNING: mise not found, skipping completion generation"
fi
{{- end }}
```

Using `run_once_after_` prefix ensures:
- Runs only once (not on every apply)
- Runs after file deployment (mise config is in place)
- Only runs on macOS (darwin)
  </action>
  <verify>
- File exists at `~/.local/share/chezmoi/run_once_after_generate-mise-completions.sh.tmpl`
- Contains `mise completion zsh`
- Has proper bash shebang
  </verify>
  <done>Completion generation script created with proper run_once naming</done>
</task>

<task type="auto">
  <name>Task 3: Apply chezmoi and verify shell integration</name>
  <files>~/.zsh.d/hooks.zsh, ~/.local/share/zsh/site-functions/_mise</files>
  <action>
1. Run `chezmoi apply` to deploy changes

2. Verify hooks.zsh is updated:
   - `grep "mise activate" ~/.zsh.d/hooks.zsh` shows enabled line

3. Verify completions generated:
   - `ls -la ~/.local/share/zsh/site-functions/_mise` shows completion file

4. Test in new shell:
   - Open new terminal
   - Run `mise current` - should show active versions
   - Type `mise <TAB>` - should show completion suggestions

Note: Shell must be restarted or `source ~/.zshrc` run to pick up changes.
  </action>
  <verify>
- `chezmoi verify` passes
- `ls ~/.local/share/zsh/site-functions/_mise` exists
- `grep -c "mise activate zsh" ~/.zsh.d/hooks.zsh` returns 1 (line exists, uncommented)
  </verify>
  <done>Mise shell activation and completions deployed and working</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Shell integration:
   - New shell session has mise active
   - `mise current` shows versions from config
   - `which node` shows mise path (~/.local/share/mise/installs/...)

2. Completions:
   - `mise <TAB>` shows command completions
   - `mise use <TAB>` shows available tools

3. Performance (optional benchmark):
   - `time zsh -i -c exit` should be < 100ms
</verification>

<success_criteria>
- hooks.zsh has `mise activate zsh` enabled (not commented)
- Completion file exists at ~/.local/share/zsh/site-functions/_mise
- New shell session shows mise active (`mise current` works)
- Tab completion works for mise commands
</success_criteria>

<output>
After completion, create `.planning/phases/05-tool-version-migration/05-02-SUMMARY.md`
</output>
