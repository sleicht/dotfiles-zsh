---
phase: 08-basic-configs-cli-tools
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - zsh.d/variables.zsh
  - scripts/verify-checks/08-basic-configs.sh
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "bat syntax highlighting uses the Dracula theme from chezmoi-managed config file"
    - "BAT_THEME environment variable no longer overrides bat config file"
    - "SOBOLE_SYNTAX_THEME variable remains available for other tools"
  artifacts:
    - path: "zsh.d/variables.zsh"
      provides: "Shell variables without BAT_THEME export"
      contains: "SOBOLE_SYNTAX_THEME"
      not_contains: "export BAT_THEME"
    - path: "~/.config/bat/config"
      provides: "bat configuration with Dracula theme"
      contains: '--theme="Dracula"'
  key_links:
    - from: "~/.config/bat/config"
      to: "bat runtime"
      via: "bat reads config file when BAT_THEME env var absent"
      pattern: '--theme="Dracula"'
---

<objective>
Fix bat theme not applying from chezmoi-managed config file.

Purpose: Close the single UAT gap from Phase 8 -- user reported that changing the bat theme to Dracula in the config file has no effect. Root cause: BAT_THEME environment variable exported in zsh.d/variables.zsh (line 95) overrides the config file setting. Environment variables take precedence over bat's config file.

Output: bat uses the Dracula theme specified in ~/.config/bat/config without env var interference.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-basic-configs-cli-tools/08-01-SUMMARY.md
@.planning/phases/08-basic-configs-cli-tools/08-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove BAT_THEME env var override and add verification check</name>
  <files>zsh.d/variables.zsh, scripts/verify-checks/08-basic-configs.sh</files>
  <action>
1. Edit zsh.d/variables.zsh:
   - Remove line 95 (`export BAT_THEME="$SOBOLE_SYNTAX_THEME"`) and the comment lines above it (lines 92-95, the entire "=== bat ===" section including the URL comment on line 93).
   - Keep line 10 (`export SOBOLE_SYNTAX_THEME="gruvbox-dark"`) intact -- other tools may still reference it.

2. Edit scripts/verify-checks/08-basic-configs.sh:
   - Add a new Check 5 section after Check 4 (before the Results section) that verifies BAT_THEME is NOT exported in zsh.d/variables.zsh. This prevents regression.
   - Use grep to confirm zsh.d/variables.zsh does NOT contain `export BAT_THEME`. This is a static check that catches regression without needing to source the file.
   - If grep finds the pattern, fail the check. If grep finds no match, pass.

3. Verify the chezmoi source for bat config already has Dracula theme:
   - Confirm ~/.local/share/chezmoi/private_dot_config/bat/config contains `--theme="Dracula"` (it does based on current state, but verify).
   - If it does NOT contain Dracula, update it to match the deployed config.
  </action>
  <verify>
Run: `grep -c 'export BAT_THEME' zsh.d/variables.zsh` -- should return 0 (no matches).
Run: `grep 'SOBOLE_SYNTAX_THEME' zsh.d/variables.zsh` -- should still show line 10 definition.
Run: `grep 'Dracula' ~/.local/share/chezmoi/private_dot_config/bat/config` -- should show the theme line.
Run: `./scripts/verify-configs.sh --phase 08` -- all checks pass.
  </verify>
  <done>
BAT_THEME export removed from zsh.d/variables.zsh. SOBOLE_SYNTAX_THEME definition preserved. Verification script updated with regression check. All verification checks pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify bat uses Dracula theme</name>
  <files>n/a</files>
  <action>
Human verification checkpoint. Removed BAT_THEME environment variable override from zsh.d/variables.zsh so that bat's config file (~/.config/bat/config) is the sole source of truth for the theme setting. The config file specifies --theme="Dracula".
  </action>
  <verify>
1. Open a NEW terminal window (or run `source ~/.zshrc` to reload shell config)
2. Run `echo $BAT_THEME` -- should output nothing (empty)
3. Run `bat --config-file` -- should show ~/.config/bat/config
4. Run `bat zsh.d/variables.zsh` (or any source file) -- the syntax highlighting theme should now be Dracula (purple/pink/green colour scheme) instead of gruvbox-dark (warm orange/yellow scheme)
  </verify>
  <done>
User confirms bat now renders files using the Dracula colour scheme. UAT gap closed.
  </done>
</task>

</tasks>

<verification>
- `grep -c 'export BAT_THEME' zsh.d/variables.zsh` returns 0
- `grep 'SOBOLE_SYNTAX_THEME' zsh.d/variables.zsh` shows the definition line
- `grep 'Dracula' ~/.local/share/chezmoi/private_dot_config/bat/config` shows theme setting
- `./scripts/verify-configs.sh --phase 08` passes all checks
- In a fresh shell: `echo $BAT_THEME` outputs nothing
- `bat` renders files using Dracula colour scheme
</verification>

<success_criteria>
bat uses the Dracula theme from its chezmoi-managed config file. The BAT_THEME environment variable no longer overrides the config file. The SOBOLE_SYNTAX_THEME variable remains defined for other tools. Verification script includes a regression check preventing re-introduction of BAT_THEME export.
</success_criteria>

<output>
After completion, create `.planning/phases/08-basic-configs-cli-tools/08-03-SUMMARY.md`
</output>
