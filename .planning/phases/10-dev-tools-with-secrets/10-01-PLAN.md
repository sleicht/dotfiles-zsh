---
phase: 10-dev-tools-with-secrets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.local/share/chezmoi/.chezmoiignore
  - ~/.local/share/chezmoi/private_dot_config/lazygit/config.yml
  - ~/.local/share/chezmoi/private_dot_config/atuin/config.toml
  - ~/.local/share/chezmoi/private_dot_config/atuin/atuin-keybindings.zsh
  - ~/.local/share/chezmoi/dot_aider.conf.yml
  - ~/.local/share/chezmoi/dot_finicky.js
  - ~/.local/share/chezmoi/private_dot_gnupg/gpg-agent.conf.tmpl
autonomous: true

must_haves:
  truths:
    - "lazygit loads chezmoi-managed configuration correctly"
    - "atuin uses chezmoi-managed config.toml and keybindings"
    - "aider config file deployed via chezmoi (static, no embedded secrets)"
    - "finicky browser routing config deployed on macOS"
    - "GPG agent config uses OS-specific pinentry path (not obsolete Nix path)"
    - "All 5 dev tool configs are real files (not Dotbot symlinks)"
  artifacts:
    - path: "~/.local/share/chezmoi/private_dot_config/lazygit/config.yml"
      provides: "lazygit static config in chezmoi source"
    - path: "~/.local/share/chezmoi/private_dot_config/atuin/config.toml"
      provides: "atuin config in chezmoi source (static, sync disabled)"
    - path: "~/.local/share/chezmoi/private_dot_config/atuin/atuin-keybindings.zsh"
      provides: "atuin keybindings in chezmoi source"
    - path: "~/.local/share/chezmoi/dot_aider.conf.yml"
      provides: "aider static config in chezmoi source"
    - path: "~/.local/share/chezmoi/dot_finicky.js"
      provides: "finicky browser routing config in chezmoi source"
    - path: "~/.local/share/chezmoi/private_dot_gnupg/gpg-agent.conf.tmpl"
      provides: "gpg-agent config with OS-conditional pinentry path"
  key_links:
    - from: "~/.local/share/chezmoi/.chezmoiignore"
      to: "Phase 10 configs"
      via: "Section 9 removal allows chezmoi to manage Phase 10 files"
      pattern: "lazygit|atuin|aider|gpg-agent"
    - from: "~/.local/share/chezmoi/private_dot_gnupg/gpg-agent.conf.tmpl"
      to: "~/.gnupg/gpg-agent.conf"
      via: "chezmoi template rendering with OS-conditional pinentry path"
      pattern: "chezmoi\\.os.*darwin"
---

<objective>
Migrate all 5 Phase 10 dev tool configurations from Dotbot symlinks to chezmoi-managed files.

Purpose: This is the core migration work for Phase 10 -- moving lazygit, atuin, aider, finicky, and gpg-agent configs into chezmoi source. The gpg-agent config requires OS-conditional templating (pinentry path differs by OS), while the other 4 are static configs with no secret templating needed. Atuin sync is currently disabled (no sync key), so no Bitwarden integration is required at this time.

Output: 6 config files in chezmoi source (1 templated, 5 static), updated .chezmoiignore, all configs deployed as real files.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-dev-tools-with-secrets/10-RESEARCH.md
@.planning/phases/09-terminal-emulators/09-01-SUMMARY.md
@.planning/phases/08-basic-configs-cli-tools/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update .chezmoiignore and add all 6 config files to chezmoi source</name>
  <files>
    ~/.local/share/chezmoi/.chezmoiignore
    ~/.local/share/chezmoi/private_dot_config/lazygit/config.yml
    ~/.local/share/chezmoi/private_dot_config/atuin/config.toml
    ~/.local/share/chezmoi/private_dot_config/atuin/atuin-keybindings.zsh
    ~/.local/share/chezmoi/dot_aider.conf.yml
    ~/.local/share/chezmoi/dot_finicky.js
  </files>
  <action>
    CRITICAL: Update .chezmoiignore FIRST (before adding files) -- Phase 8-9 learned that files are rejected while ignore patterns exist.

    Step 1: Edit ~/.local/share/chezmoi/.chezmoiignore
    - Remove Section 9 (Phase 10 pending block, lines 132-141) which contains:
      .config/lazygit, .config/lazygit/**, .config/atuin, .config/atuin/**, .aider.conf.yml, .gnupg/gpg-agent.conf
    - Note: .finicky.js is NOT in Section 9 -- it is in Section 5 (OS-conditional, macOS-only) and must STAY there
    - Renumber remaining sections: current 10 becomes 9, 11 becomes 10, 12 becomes 11
    - Update the header comment to say "11 sections" instead of "12 sections"

    Step 2: Add static configs to chezmoi source using manual cp -L workaround (Phase 8-9 proven pattern):

    lazygit (symlink to dotfiles repo file .config/lazygit.yml, deployed at .config/lazygit/config.yml):
    - mkdir -p ~/.local/share/chezmoi/private_dot_config/lazygit
    - cp -L ~/.config/lazygit/config.yml ~/.local/share/chezmoi/private_dot_config/lazygit/config.yml

    atuin (real files in ~/.config/atuin/, also exist in dotfiles repo .config/atuin/):
    - mkdir -p ~/.local/share/chezmoi/private_dot_config/atuin
    - cp ~/.config/atuin/config.toml ~/.local/share/chezmoi/private_dot_config/atuin/config.toml
    - cp ~/.config/atuin/atuin-keybindings.zsh ~/.local/share/chezmoi/private_dot_config/atuin/atuin-keybindings.zsh
    Note: atuin files are real files (not symlinks). auto_sync = false in current config, so NO Bitwarden sync key templating needed. If user enables sync later, config.toml can be converted to .tmpl with Bitwarden template for sync_key.

    aider (symlink .aider.conf.yml -> dotfiles repo .config/aider.conf.yml):
    - cp -L ~/.aider.conf.yml ~/.local/share/chezmoi/dot_aider.conf.yml
    Note: Static config only (model selection, UI preferences). No API keys embedded (all commented out). No .aider.env file created -- user has no existing .aider.env and API keys would need Bitwarden items that may not exist. Can be added later if needed.

    finicky (symlink .finicky.js -> dotfiles repo .config/finicky.js, macOS-only):
    - cp -L ~/.finicky.js ~/.local/share/chezmoi/dot_finicky.js
    Note: finicky is already in OS-conditional Section 5 of .chezmoiignore (ignored on non-macOS). The file in chezmoi source will only deploy on macOS.

    Step 3: Verify all 5 static files are in chezmoi source:
    - ls -la ~/.local/share/chezmoi/private_dot_config/lazygit/config.yml
    - ls -la ~/.local/share/chezmoi/private_dot_config/atuin/config.toml
    - ls -la ~/.local/share/chezmoi/private_dot_config/atuin/atuin-keybindings.zsh
    - ls -la ~/.local/share/chezmoi/dot_aider.conf.yml
    - ls -la ~/.local/share/chezmoi/dot_finicky.js

    Step 4: Verify no secrets in any static config:
    - grep -i -E "(password|token|api.key|secret)" on each file (should find only commented examples or non-secret references like keybindings)
  </action>
  <verify>
    ls -la ~/.local/share/chezmoi/private_dot_config/lazygit/config.yml (exists, regular file)
    ls -la ~/.local/share/chezmoi/private_dot_config/atuin/config.toml (exists, regular file)
    ls -la ~/.local/share/chezmoi/private_dot_config/atuin/atuin-keybindings.zsh (exists, regular file)
    ls -la ~/.local/share/chezmoi/dot_aider.conf.yml (exists, regular file)
    ls -la ~/.local/share/chezmoi/dot_finicky.js (exists, regular file)
    chezmoi execute-template < ~/.local/share/chezmoi/.chezmoiignore (no errors)
    grep -c "Phase 10" ~/.local/share/chezmoi/.chezmoiignore returns 0 (Phase 10 block removed)
  </verify>
  <done>
    All 5 static config files exist in chezmoi source. .chezmoiignore Phase 10 pending block is removed. No secrets present in any static config file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gpg-agent.conf template and apply all Phase 10 configs</name>
  <files>
    ~/.local/share/chezmoi/private_dot_gnupg/gpg-agent.conf.tmpl
  </files>
  <action>
    Step 1: Create the gpg-agent.conf template with OS-conditional pinentry path.

    Create ~/.local/share/chezmoi/private_dot_gnupg/gpg-agent.conf.tmpl with this content:

    ```
    default-cache-ttl 14400
    max-cache-ttl 86400

    {{- if eq .chezmoi.os "darwin" }}
    pinentry-program /opt/homebrew/bin/pinentry-mac
    {{- else if eq .chezmoi.os "linux" }}
    pinentry-program /usr/bin/pinentry-curses
    {{- end }}
    ```

    Notes on pinentry path decision:
    - Current config has obsolete Nix path: /run/current-system/sw/bin/pinentry-mac (Nix removed in Phase 1)
    - Research suggested checking for .nix-profile first, but Nix was fully removed -- use Homebrew path directly
    - /opt/homebrew/bin/pinentry-mac is the standard Apple Silicon Homebrew path
    - pinentry-mac is NOT currently installed (which pinentry-mac fails) -- this is fine, config will be ready when user installs it
    - Linux fallback uses /usr/bin/pinentry-curses (universal headless pinentry)

    Step 2: Verify template renders correctly:
    - chezmoi execute-template < ~/.local/share/chezmoi/private_dot_gnupg/gpg-agent.conf.tmpl
    Should output the config with /opt/homebrew/bin/pinentry-mac (on macOS)

    Step 3: Apply all Phase 10 configs using targeted --force to bypass Bitwarden auth gate:
    - chezmoi apply --force ~/.config/lazygit/config.yml ~/.config/atuin/config.toml ~/.config/atuin/atuin-keybindings.zsh ~/.aider.conf.yml ~/.gnupg/gpg-agent.conf
    - On macOS also: chezmoi apply --force ~/.finicky.js

    Step 4: Verify all deployed files are real files (not symlinks):
    - file ~/.config/lazygit/config.yml (should say "ASCII text" not "symbolic link")
    - file ~/.config/atuin/config.toml
    - file ~/.config/atuin/atuin-keybindings.zsh
    - file ~/.aider.conf.yml
    - file ~/.gnupg/gpg-agent.conf
    - file ~/.finicky.js (macOS only)

    Step 5: Verify gpg-agent.conf no longer has Nix path:
    - grep "pinentry" ~/.gnupg/gpg-agent.conf (should show Homebrew path, not Nix path)

    Step 6: Verify chezmoi manages Phase 10 files:
    - chezmoi managed --include=files | grep -E "lazygit|atuin|aider|gpg-agent|finicky"
  </action>
  <verify>
    file ~/.config/lazygit/config.yml (not a symlink)
    file ~/.gnupg/gpg-agent.conf (not a symlink)
    grep "opt/homebrew" ~/.gnupg/gpg-agent.conf (shows Homebrew pinentry path on macOS)
    grep -c "nix" ~/.gnupg/gpg-agent.conf returns 0 (no Nix references)
    chezmoi managed --include=files | grep -c -E "lazygit|atuin|aider|gpg-agent|finicky" returns 6 or 7 (all Phase 10 configs managed)
  </verify>
  <done>
    gpg-agent.conf template created with OS-conditional pinentry path. All 6 Phase 10 configs deployed as real files via chezmoi apply. No Dotbot symlinks remain for Phase 10 configs. gpg-agent.conf uses Homebrew pinentry path (not obsolete Nix path).
  </done>
</task>

</tasks>

<verification>
1. chezmoi managed --include=files shows all Phase 10 configs (lazygit, atuin x2, aider, finicky, gpg-agent)
2. None of the Phase 10 config files are symlinks (file command shows "text" not "symbolic link")
3. .chezmoiignore has no Phase 10 pending block
4. gpg-agent.conf contains OS-appropriate pinentry path (not Nix path)
5. No secrets present in any chezmoi source file for Phase 10
</verification>

<success_criteria>
- All 6 config files exist in chezmoi source directory
- All deployed configs are real files (Dotbot symlinks replaced)
- gpg-agent.conf template renders with correct OS-specific pinentry path
- .chezmoiignore Phase 10 block removed, sections renumbered
- chezmoi managed lists all Phase 10 files
</success_criteria>

<output>
After completion, create `.planning/phases/10-dev-tools-with-secrets/10-01-SUMMARY.md`
</output>
