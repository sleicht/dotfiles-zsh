---
phase: 03-templating-machine-detection
plan: 04
type: execute
wave: 3
depends_on: [03-02, 03-03]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can test templates on Linux without breaking macOS setup"
    - "Shell starts correctly on Linux VM"
    - "chezmoi apply works on Linux"
    - "Git email is correctly set on Linux based on machine type"
  artifacts:
    - path: "~/.zsh.d/path.zsh (on Linux VM)"
      provides: "Linux-appropriate PATH (no macOS paths)"
  key_links:
    - from: "templates"
      to: "Linux VM"
      via: "chezmoi init/apply"
---

<objective>
Verify all templates work correctly on Linux and complete phase verification checkpoint with user.

Purpose: Ensure cross-platform support actually works before declaring phase complete. Catch template errors that only manifest on Linux.

Output: Verified working templates on both macOS and Linux, user approval for phase completion.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-templating-machine-detection/03-RESEARCH.md
@.planning/phases/03-templating-machine-detection/03-01-SUMMARY.md
@.planning/phases/03-templating-machine-detection/03-02-SUMMARY.md
@.planning/phases/03-templating-machine-detection/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test templates on Linux VM</name>
  <files></files>
  <action>
Use the Linux test environment from Phase 1 to verify templates work on Linux.

1. Start the Linux container (if not running):
```bash
# Using OrbStack/Docker from Phase 1
docker start dotfiles-test 2>/dev/null || \
  docker run -d --name dotfiles-test \
    -v ~/.local/share/chezmoi:/root/.local/share/chezmoi:ro \
    ubuntu:24.04 sleep infinity
```

2. Install chezmoi in container and test:
```bash
docker exec -it dotfiles-test bash -c '
  # Install chezmoi
  apt-get update && apt-get install -y curl git
  sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin

  # Test template execution (should show linux-ubuntu osid)
  cd /root/.local/share/chezmoi
  chezmoi execute-template "osid: {{ .chezmoi.os }}{{ if hasKey .chezmoi \"osRelease\" }}-{{ .chezmoi.osRelease.id }}{{ end }}"

  # Test .chezmoi.yaml.tmpl (non-interactive)
  chezmoi execute-template --init < .chezmoi.yaml.tmpl

  # Test path.zsh.tmpl (should NOT have macOS paths)
  chezmoi execute-template < dot_zsh.d/path.zsh.tmpl | head -20
'
```

Expected:
- osid shows "linux-ubuntu"
- .chezmoi.yaml.tmpl generates valid YAML
- path.zsh.tmpl output does NOT contain `/opt/homebrew` paths
  </action>
  <verify>
```bash
docker exec dotfiles-test chezmoi execute-template "{{ .chezmoi.os }}"
# Should output: linux

docker exec dotfiles-test bash -c '
  chezmoi execute-template < /root/.local/share/chezmoi/dot_zsh.d/path.zsh.tmpl | grep -c homebrew || echo "0 homebrew paths (correct)"
'
# Should output: 0 homebrew paths (correct)
```
  </verify>
  <done>
- Templates execute without errors on Linux
- osid correctly detected as linux-ubuntu
- path.zsh does not include macOS-specific paths on Linux
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify template outputs on macOS</name>
  <files></files>
  <action>
Run final verification on macOS to confirm nothing broke:

```bash
# Verify osid
chezmoi data | grep osid
# Should show: osid: darwin

# Verify git config
chezmoi data | grep -E "(machine_type|personal_email|work_email)"
git config user.email

# Verify shell works
zsh -c 'source ~/.zshrc && alias | wc -l'

# Verify chezmoi state
chezmoi verify
chezmoi managed | wc -l
```
  </action>
  <verify>
```bash
# All should pass
chezmoi verify && echo "chezmoi verify: PASS"
zsh -c 'source ~/.zshrc && echo "Shell: PASS"'
```
  </verify>
  <done>
- macOS configuration still works
- chezmoi verify passes
- Shell loads correctly
- Git email configured correctly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 3 complete: Templating infrastructure with machine detection and cross-platform support.

Created:
1. `.chezmoi.yaml.tmpl` - Interactive prompts for machine type and emails
2. `.chezmoidata.yaml` - Static package data structure for Phase 4
3. `private_dot_gitconfig_local.tmpl` - Machine-specific git email
4. `dot_zsh.d/path.zsh.tmpl` - OS-specific PATH configuration

Verified:
- Templates work on both macOS and Linux
- Git email automatically set based on machine type
- Shell PATH adapts to OS
  </what-built>
  <how-to-verify>
1. Open a new terminal and verify shell works:
   ```bash
   alias | head -5  # Should show aliases
   ```

2. Verify git email matches your machine type:
   ```bash
   git config user.email
   chezmoi data | grep machine_type
   ```

3. Verify chezmoi data shows all expected fields:
   ```bash
   chezmoi data | grep -E "(machine_type|personal_email|osid)"
   ```

4. (Optional) If you want to test on Linux VM:
   ```bash
   docker exec -it dotfiles-test zsh
   ```
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 3 complete when:
1. All templates work on macOS
2. All templates work on Linux (verified via Docker)
3. Git email correctly configured per machine type
4. Shell starts correctly on both platforms
5. User approves phase completion
</verification>

<success_criteria>
Phase 3 Success Criteria (from ROADMAP.md):
1. [x] User can run `chezmoi apply` on macOS and Linux and get platform-appropriate configurations
2. [x] User can switch between machines (client/personal) and get machine-specific settings automatically
3. [x] User has working templates for git config, tool configs that adapt to OS and machine
4. [x] User can verify templates with `chezmoi execute-template` before applying
5. [x] User can test configuration on Linux VM without breaking macOS setup
</success_criteria>

<output>
After completion, create `.planning/phases/03-templating-machine-detection/03-04-SUMMARY.md`
</output>
