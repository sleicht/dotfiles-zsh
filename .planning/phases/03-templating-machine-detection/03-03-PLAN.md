---
phase: 03-templating-machine-detection
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - ~/.local/share/chezmoi/dot_zsh.d/path.zsh.tmpl
autonomous: true

must_haves:
  truths:
    - "User can run chezmoi apply on macOS and Linux and get platform-appropriate shell paths"
    - "macOS gets GNU tools paths (/opt/homebrew/opt/*)"
    - "Linux does not get macOS-specific paths that do not exist"
    - "Shell startup does not error on either platform"
  artifacts:
    - path: "~/.local/share/chezmoi/dot_zsh.d/path.zsh.tmpl"
      provides: "OS-specific PATH configuration"
      contains: ".chezmoi.os"
  key_links:
    - from: "dot_zsh.d/path.zsh.tmpl"
      to: "chezmoi data"
      via: "template variables .chezmoi.os"
      pattern: "eq \\.chezmoi\\.os"
---

<objective>
Template shell path configuration for cross-platform support - macOS gets GNU tools paths, Linux gets appropriate paths.

Purpose: Enable dotfiles to work on both macOS and Linux without path errors for tools that only exist on one platform.

Output: Templated `path.zsh` that conditionally includes OS-specific paths.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-templating-machine-detection/03-RESEARCH.md
@.planning/phases/03-templating-machine-detection/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert path.zsh to template with OS conditionals</name>
  <files>~/.local/share/chezmoi/dot_zsh.d/path.zsh.tmpl</files>
  <action>
Convert `dot_zsh.d/path.zsh` to `dot_zsh.d/path.zsh.tmpl` with OS conditionals.

1. First, rename the existing file:
```bash
cd ~/.local/share/chezmoi
mv dot_zsh.d/path.zsh dot_zsh.d/path.zsh.tmpl
```

2. Edit the template to wrap macOS-specific paths:

The file currently has these macOS-specific lines that should be conditional:
- `/opt/homebrew/opt/findutils/libexec/gnubin` (GNU findutils)
- `/opt/homebrew/opt/grep/libexec/gnubin` (GNU grep)
- `/opt/homebrew/opt/gnu-sed/libexec/gnubin` (GNU sed)
- `/opt/homebrew/opt/ruby/bin` (Homebrew Ruby)

Wrap these in `{{ if eq .chezmoi.os "darwin" }}` blocks.

Template structure:
```zsh
# Managed by chezmoi - do not edit directly
#!/usr/bin/env zsh

# Add directories to the PATH and prevent to add the same directory multiple times upon shell reload.
add_to_path() {
  if [[ -d "$1" ]] && [[ ":$PATH:" != *":$1:"* ]]; then
    export PATH="$1:$PATH"
  fi
}

{{- if eq .chezmoi.os "darwin" }}

# macOS: GNU tools from Homebrew (prefer GNU over BSD)
add_to_path "/opt/homebrew/opt/findutils/libexec/gnubin"
add_to_path "/opt/homebrew/opt/grep/libexec/gnubin"
add_to_path "/opt/homebrew/opt/gnu-sed/libexec/gnubin"

# macOS: Homebrew Ruby
add_to_path "/opt/homebrew/opt/ruby/bin"
{{- end }}

# Load nix system (cross-platform)
add_to_path "/run/current-system/sw/bin"

# Load dotfiles binaries
add_to_path "$DOTFILES/bin"

# Ruby (cross-platform rbenv)
add_to_path "$HOME/.rbenv/bin"
add_to_path "$HOME/.gem/ruby/3.4.0/bin"

# npm
add_to_path "$HOME/.npm-global/bin/"

# pnpm
export PNPM_HOME="$HOME/.local/share/pnpm"
add_to_path "$PNPM_HOME"

# bun
export BUN_INSTALL="$HOME/.bun"
add_to_path "$BUN_INSTALL/bin"

# volta
export VOLTA_HOME="$HOME/.volta"
add_to_path "$VOLTA_HOME/bin"

# Load home bins
add_to_path "$HOME/.bin"
add_to_path "$HOME/.local/.bin"
add_to_path "$HOME/.cargo/bin"
add_to_path "$HOME/.rd/bin"
```

IMPORTANT: Use `{{-` (dash before) to strip leading whitespace and prevent blank lines.
  </action>
  <verify>
Test template on current OS:
```bash
chezmoi execute-template < ~/.local/share/chezmoi/dot_zsh.d/path.zsh.tmpl
```

Verify:
- On macOS: Output includes GNU tools paths
- Template parses without errors
- No blank lines at top of file
  </verify>
  <done>
- Template file renamed to .tmpl extension
- macOS-specific paths wrapped in conditionals
- Template renders valid zsh script
- No syntax errors in template
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply template and verify shell startup</name>
  <files>~/.zsh.d/path.zsh</files>
  <action>
Apply the templated path.zsh and verify shell still works:

```bash
# Preview changes
chezmoi diff ~/.zsh.d/path.zsh

# Apply
chezmoi apply

# Test shell startup (should not error)
zsh -c 'source ~/.zshrc && echo "Shell OK"'

# Verify PATH includes expected paths (on macOS)
echo $PATH | tr ':' '\n' | grep homebrew
```
  </action>
  <verify>
```bash
# File should exist
ls -la ~/.zsh.d/path.zsh

# File should have template header
head -2 ~/.zsh.d/path.zsh

# Shell should start without errors
zsh -c 'source ~/.zshrc && echo "PATH test passed"'

# chezmoi verify should pass
chezmoi verify
```
  </verify>
  <done>
- ~/.zsh.d/path.zsh updated with templated content
- Shell starts without errors
- PATH contains expected directories
- chezmoi verify shows no drift
  </done>
</task>

<task type="auto">
  <name>Task 3: Commit templated files to chezmoi source</name>
  <files>~/.local/share/chezmoi/</files>
  <action>
Commit the templated files in chezmoi source repository:

```bash
cd ~/.local/share/chezmoi

# Add all new/modified template files
git add .chezmoi.yaml.tmpl .chezmoidata.yaml
git add private_dot_gitconfig_local.tmpl
git add dot_zsh.d/path.zsh.tmpl

# Remove the old non-template path.zsh if it's tracked
git rm --cached dot_zsh.d/path.zsh 2>/dev/null || true

# Commit
git commit -m "feat(03): add templating for machine detection and cross-platform support

- Add .chezmoi.yaml.tmpl with interactive prompts for machine type and emails
- Add .chezmoidata.yaml with package structure for Phase 4
- Add private_dot_gitconfig_local.tmpl for machine-specific git email
- Convert path.zsh to template with macOS-only GNU tools paths

Phase 3: Templating & Machine Detection"
```
  </action>
  <verify>
```bash
cd ~/.local/share/chezmoi
git log --oneline -1
git status
```
Should show clean working directory with recent commit.
  </verify>
  <done>
- All template files committed
- Commit message follows conventions
- Working directory clean
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. path.zsh converted to template with OS conditionals
2. chezmoi apply generates platform-appropriate path.zsh
3. Shell starts without errors on macOS
4. All changes committed to chezmoi source
</verification>

<success_criteria>
- Shell PATH configuration adapts to OS
- macOS gets GNU tools paths
- Linux would get Linux-appropriate paths (no macOS-only paths)
- Shell startup time not degraded
- All template files committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/03-templating-machine-detection/03-03-SUMMARY.md`
</output>
