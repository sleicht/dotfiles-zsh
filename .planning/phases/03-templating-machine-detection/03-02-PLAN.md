---
phase: 03-templating-machine-detection
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - ~/.local/share/chezmoi/dot_gitconfig.tmpl
  - ~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl
autonomous: true

must_haves:
  truths:
    - "User can run chezmoi apply and git config uses correct email based on machine type"
    - "Client machines get work_email in git config"
    - "Personal/server machines get personal_email in git config"
    - "User can verify git email with git config user.email"
  artifacts:
    - path: "~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl"
      provides: "Machine-specific git user config"
      contains: "machine_type"
    - path: "~/.local/share/chezmoi/dot_gitconfig"
      provides: "Global git config (unchanged, includes local)"
      contains: "path = ~/.gitconfig_local"
  key_links:
    - from: "dot_gitconfig"
      to: "private_dot_gitconfig_local.tmpl"
      via: "[include] path = ~/.gitconfig_local"
      pattern: "include.*gitconfig_local"
    - from: "private_dot_gitconfig_local.tmpl"
      to: ".chezmoi.yaml (data)"
      via: "template variables .machine_type, .personal_email, .work_email"
      pattern: "\\.machine_type|\\.personal_email|\\.work_email"
---

<objective>
Template git configuration to use machine-appropriate email address (work email on client machines, personal email on personal/server machines).

Purpose: Enable seamless git identity switching - work commits use work email, personal commits use personal email, without manual configuration.

Output: Templated `.gitconfig_local` that sets user.name and user.email based on machine type.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-templating-machine-detection/03-RESEARCH.md
@.planning/phases/03-templating-machine-detection/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create templated .gitconfig_local</name>
  <files>~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl</files>
  <action>
Create `private_dot_gitconfig_local.tmpl` in chezmoi source directory.

IMPORTANT: Use `private_` prefix because this file contains email addresses. The existing `.gitconfig` already has `[include] path = ~/.gitconfig_local`, so this file will be included automatically.

Content:
```gitconfig
# Managed by chezmoi - do not edit directly
# Machine type: {{ .machine_type }}
# Generated: {{ now | date "2006-01-02" }}

[user]
{{- if eq .machine_type "client" }}
  name = Stephan Leicht Vogt
  email = {{ .work_email }}
{{- else }}
  name = Stephan Leicht Vogt
  email = {{ .personal_email }}
{{- end }}
```

Notes:
- Use `private_` prefix for 600 permissions (contains email)
- The `private_` prefix creates file with mode 0600
- Main `.gitconfig` already includes this file via `[include]`
- No changes needed to dot_gitconfig - it remains non-templated
  </action>
  <verify>
Test template before applying:
```bash
chezmoi execute-template < ~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl
```
Should output valid gitconfig with [user] section containing correct email based on machine_type.
  </verify>
  <done>
- Template parses without errors
- Output shows [user] section with name and email
- Email matches machine_type (work_email for client, personal_email otherwise)
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply templates and verify git config</name>
  <files>~/.gitconfig_local</files>
  <action>
Apply the templated config and verify git uses correct email:

```bash
# Preview changes
chezmoi diff

# Apply templates
chezmoi apply

# Verify git sees the correct email
git config user.email
git config user.name
```

The applied `.gitconfig_local` should have correct permissions (600) and contain the appropriate email.
  </action>
  <verify>
```bash
# Check file exists with correct permissions
ls -la ~/.gitconfig_local

# Check content
cat ~/.gitconfig_local

# Verify git picks up the email
git config user.email
git config user.name

# Verify chezmoi shows no diff (files match templates)
chezmoi verify
```
  </verify>
  <done>
- ~/.gitconfig_local exists with 600 permissions
- File contains correct email for machine type
- `git config user.email` returns expected email
- `chezmoi verify` exits 0
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove existing .gitconfig_local from home (cleanup)</name>
  <files>~/.gitconfig_local</files>
  <action>
The original `.gitconfig_local` was manually created and is not managed by chezmoi. Now that chezmoi manages it via template, we need to ensure chezmoi is the source of truth.

FIRST: Check if chezmoi already manages this file:
```bash
chezmoi managed | grep gitconfig_local
```

If NOT managed, the file in home directory is the original. chezmoi apply should have replaced it, but verify:
```bash
# Check if file matches what chezmoi expects
chezmoi diff ~/.gitconfig_local
```

If there's a diff (old file exists), chezmoi apply should have already updated it. If not:
```bash
# Force apply to ensure template wins
chezmoi apply --force ~/.gitconfig_local
```

Verify the file is now managed:
```bash
chezmoi managed | grep gitconfig_local
```
  </action>
  <verify>
```bash
# File should be managed
chezmoi managed | grep gitconfig_local

# No diff should exist
chezmoi diff ~/.gitconfig_local

# File should have template header
head -3 ~/.gitconfig_local | grep "Managed by chezmoi"
```
  </verify>
  <done>
- .gitconfig_local is in chezmoi managed list
- No diff between source and target
- File starts with "Managed by chezmoi" header
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `private_dot_gitconfig_local.tmpl` exists in chezmoi source
2. Template renders correct email based on machine_type
3. `chezmoi apply` updates ~/.gitconfig_local
4. `git config user.email` returns machine-appropriate email
5. `chezmoi verify` shows no drift
</verification>

<success_criteria>
- Git email automatically set based on machine type
- Client machines use work_email in git commits
- Personal/server machines use personal_email in git commits
- No manual configuration needed after `chezmoi init`
</success_criteria>

<output>
After completion, create `.planning/phases/03-templating-machine-detection/03-02-SUMMARY.md`
</output>
