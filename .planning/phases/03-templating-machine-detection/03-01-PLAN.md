---
phase: 03-templating-machine-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.local/share/chezmoi/.chezmoi.yaml.tmpl
  - ~/.local/share/chezmoi/.chezmoidata.yaml
autonomous: true

must_haves:
  truths:
    - "chezmoi init prompts for machine type (client/personal/server)"
    - "chezmoi init prompts for personal email address"
    - "chezmoi init prompts for work email only when machine_type is client"
    - "chezmoi data shows machine_type, personal_email, work_email, osid values"
  artifacts:
    - path: "~/.local/share/chezmoi/.chezmoi.yaml.tmpl"
      provides: "Per-machine config generation with prompts"
      contains: "promptString"
    - path: "~/.local/share/chezmoi/.chezmoidata.yaml"
      provides: "Static shared data for templates"
      contains: "packages:"
  key_links:
    - from: ".chezmoi.yaml.tmpl"
      to: "~/.config/chezmoi/chezmoi.yaml"
      via: "chezmoi init generates config"
      pattern: "chezmoi init.*chezmoi\\.yaml"
---

<objective>
Create chezmoi template infrastructure with interactive prompts for machine identity and email addresses.

Purpose: Establish the data layer that all templates will consume - machine type (client/personal/server), email addresses, and computed OS detection variable (osid).

Output: `.chezmoi.yaml.tmpl` that prompts during `chezmoi init` and `.chezmoidata.yaml` for static shared data.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-templating-machine-detection/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .chezmoi.yaml.tmpl with interactive prompts</name>
  <files>~/.local/share/chezmoi/.chezmoi.yaml.tmpl</files>
  <action>
Create `.chezmoi.yaml.tmpl` in chezmoi source directory with:

1. Interactive prompt detection using `stdinIsATTY`
2. Machine type prompt: "Machine type (client/personal/server)" with default "personal"
3. Personal email prompt (always asked)
4. Work email prompt (only when machine_type is "client")
5. Computed `osid` variable combining `.chezmoi.os` and `.chezmoi.osRelease.id` (darwin, linux-ubuntu, linux-fedora, etc.)

Use whitespace control (`{{-` and `-}}`) to prevent blank lines in output.

Example structure from research:
```yaml
{{- $interactive := stdinIsATTY -}}

{{- $machineType := "personal" -}}
{{- if $interactive -}}
{{-   $machineType = promptString "Machine type (client/personal/server)" "personal" -}}
{{- end -}}

{{- $personalEmail := "" -}}
{{- if $interactive -}}
{{-   $personalEmail = promptString "Personal email address" -}}
{{- end -}}

{{- $workEmail := "" -}}
{{- if eq $machineType "client" -}}
{{-   if $interactive -}}
{{-     $workEmail = promptString "Work email address" -}}
{{-   end -}}
{{- end -}}

{{- $osid := .chezmoi.os -}}
{{- if hasKey .chezmoi "osRelease" -}}
{{-   if hasKey .chezmoi.osRelease "id" -}}
{{-     $osid = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
{{-   end -}}
{{- end }}

data:
  machine_type: {{ $machineType | quote }}
  personal_email: {{ $personalEmail | quote }}
{{- if eq $machineType "client" }}
  work_email: {{ $workEmail | quote }}
{{- end }}
  osid: {{ $osid | quote }}
```

Note: Keep existing chezmoi.toml settings (autoCommit, diff.pager, etc.) - this file generates ONLY the data section.
  </action>
  <verify>
Test template execution without applying:
```bash
chezmoi execute-template --init \
  --promptString "Machine type (client/personal/server)=client" \
  --promptString "Personal email address=user@personal.com" \
  --promptString "Work email address=user@work.com" \
  < ~/.local/share/chezmoi/.chezmoi.yaml.tmpl
```
Should output valid YAML with data section containing machine_type, personal_email, work_email, osid.
  </verify>
  <done>
- Template parses without syntax errors
- Output contains all four data fields when machine_type is client
- Output contains three data fields (no work_email) when machine_type is personal
- osid is "darwin" on macOS, "linux-{distro}" on Linux
  </done>
</task>

<task type="auto">
  <name>Task 2: Create .chezmoidata.yaml for static shared data</name>
  <files>~/.local/share/chezmoi/.chezmoidata.yaml</files>
  <action>
Create `.chezmoidata.yaml` in chezmoi source directory with placeholder structure for Phase 4 package management.

Content:
```yaml
# Static data shared across all machines
# For machine-specific values, use .chezmoi.yaml.tmpl prompts

# Package lists (used in Phase 4)
packages:
  # Common packages for all platforms
  common:
    - git
    - gh
    - mise
    - chezmoi

  # macOS-specific (Homebrew)
  darwin:
    brews: []
    casks: []

  # Linux-specific (apt for Ubuntu/Debian)
  linux:
    apt: []
    dnf: []

# Tool configurations (placeholders for future phases)
tools:
  mise:
    # Global mise settings go here when needed
  sheldon:
    # Plugin list goes here when needed
```

This file is committed to git and shared across all machines. Machine-specific values go in .chezmoi.yaml.tmpl.
  </action>
  <verify>
```bash
# Verify file exists and is valid YAML
cat ~/.local/share/chezmoi/.chezmoidata.yaml
chezmoi data | grep -A5 "packages"
```
Should show packages key accessible in chezmoi data.
  </verify>
  <done>
- .chezmoidata.yaml exists in chezmoi source
- chezmoi data shows packages structure
- File is valid YAML (no parse errors)
  </done>
</task>

<task type="auto">
  <name>Task 3: Reinitialize chezmoi with prompts and verify data</name>
  <files>~/.config/chezmoi/chezmoi.yaml</files>
  <action>
Reinitialize chezmoi to trigger the prompts and generate new config:

```bash
# Back up current config
cp ~/.config/chezmoi/chezmoi.yaml ~/.config/chezmoi/chezmoi.yaml.bak 2>/dev/null || true

# Reinitialize - this will trigger prompts
chezmoi init
```

During prompts:
- Machine type: Enter appropriate value (likely "personal" or "client")
- Personal email: Enter actual personal email
- Work email: Enter work email if client machine

After init, verify the generated config and merged data.

IMPORTANT: The init process generates ~/.config/chezmoi/chezmoi.yaml from the template. The existing chezmoi.toml settings (autoCommit, diff.pager) remain separate.
  </action>
  <verify>
```bash
# Check generated config exists and has data section
cat ~/.config/chezmoi/chezmoi.yaml

# Verify all data is accessible
chezmoi data | grep machine_type
chezmoi data | grep personal_email
chezmoi data | grep osid

# If client machine, also verify work_email
chezmoi data | grep work_email
```
  </verify>
  <done>
- chezmoi init completes successfully with prompts
- ~/.config/chezmoi/chezmoi.yaml contains data section
- `chezmoi data` shows machine_type, personal_email, osid
- work_email present only if machine_type is client
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `.chezmoi.yaml.tmpl` exists and parses correctly
2. `.chezmoidata.yaml` exists with package structure
3. `chezmoi init` prompts work and generate config
4. `chezmoi data` shows all expected values
</verification>

<success_criteria>
- Template infrastructure in place for all future templated files
- Machine identity captured (client/personal/server)
- Email addresses captured for git config templating
- osid variable computed for OS-specific conditionals
- Static package data structure ready for Phase 4
</success_criteria>

<output>
After completion, create `.planning/phases/03-templating-machine-detection/03-01-SUMMARY.md`
</output>
