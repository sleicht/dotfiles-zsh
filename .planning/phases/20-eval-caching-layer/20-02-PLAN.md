---
phase: 20-eval-caching-layer
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - dot_zsh.d/hooks.zsh
  - dot_zsh.d/external.zsh
  - dot_zsh.d/atuin.zsh
  - dot_zsh.d/carapace.zsh
  - dot_zsh.d/intelli-shell.zsh
autonomous: true

must_haves:
  truths:
    - "oh-my-posh init is cached via evalcache (sync, prompt-critical)"
    - "zoxide init is cached via evalcache"
    - "atuin init is cached via evalcache"
    - "carapace init is cached via evalcache"
    - "intelli-shell init is cached via evalcache"
    - "Shell startup time improved by 40-80ms from 283.7ms baseline"
  artifacts:
    - path: "dot_zsh.d/hooks.zsh"
      provides: "Cached oh-my-posh init"
      contains: "_evalcache oh-my-posh"
    - path: "dot_zsh.d/external.zsh"
      provides: "Cached zoxide init"
      contains: "_evalcache zoxide"
    - path: "dot_zsh.d/atuin.zsh"
      provides: "Cached atuin init"
      contains: "_evalcache atuin"
    - path: "dot_zsh.d/carapace.zsh"
      provides: "Cached carapace init"
      contains: "_evalcache carapace"
    - path: "dot_zsh.d/intelli-shell.zsh"
      provides: "Cached intelli-shell init"
      contains: "_evalcache intelli-shell"
  key_links:
    - from: "dot_zsh.d/hooks.zsh"
      to: "_evalcache function"
      via: "evalcache plugin loaded by sheldon before dotfiles source group"
      pattern: "_evalcache oh-my-posh"
    - from: "dot_zsh.d/external.zsh"
      to: "_evalcache function"
      via: "evalcache plugin loaded by sheldon before dotfiles source group"
      pattern: "_evalcache zoxide"
---

<objective>
Convert all static eval init calls to evalcache and measure total improvement.

Purpose: Eliminate subprocess spawns for oh-my-posh, zoxide, atuin, carapace, and intelli-shell init (CACHE-02, CACHE-03). Measure final improvement against 283.7ms baseline.
Output: All static init calls cached, performance measured.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-eval-caching-layer/20-RESEARCH.md
@.planning/phases/20-eval-caching-layer/20-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert all eval init calls to evalcache</name>
  <files>dot_zsh.d/hooks.zsh, dot_zsh.d/external.zsh, dot_zsh.d/atuin.zsh, dot_zsh.d/carapace.zsh, dot_zsh.d/intelli-shell.zsh</files>
  <action>
All edits in chezmoi source at `~/.local/share/chezmoi/`. The `_evalcache` function is available because Plan 01 added evalcache as first Sheldon plugin.

**1. dot_zsh.d/hooks.zsh line 11 — oh-my-posh (CACHE-02):**

Replace:
```zsh
if (( $+commands[oh-my-posh] )); then eval "$(oh-my-posh init zsh --config ~/.config/oh-my-posh.omp.json)"; fi
```

With:
```zsh
if (( $+commands[oh-my-posh] )); then
  _evalcache oh-my-posh init zsh --config ~/.config/oh-my-posh.omp.json
fi
```

oh-my-posh init MUST remain synchronous (not deferred) as it sets up prompt functions. evalcache only caches the output, not the execution mode.

**2. dot_zsh.d/external.zsh line 56 — zoxide (CACHE-03):**

Replace:
```zsh
eval "$(zoxide init zsh --no-cmd)"
```

With:
```zsh
if (( $+commands[zoxide] )); then
  _evalcache zoxide init zsh --no-cmd
fi
```

Adding the command guard is good practice — matches other files.

**3. dot_zsh.d/external.zsh line 65 — mise:**

Do NOT cache mise activate. mise generates directory-dependent output that changes based on current working directory. Leave as `eval "$(mise activate zsh)"`.

**4. dot_zsh.d/atuin.zsh line 7 — atuin (CACHE-03):**

Replace:
```zsh
  eval "$(atuin init zsh)"
```

With:
```zsh
  _evalcache atuin init zsh
```

Keep the existing `if (( $+commands[atuin] ))` guard.

**5. dot_zsh.d/carapace.zsh line 9 — carapace (CACHE-03):**

Replace:
```zsh
  source <(carapace _carapace)
```

With:
```zsh
  _evalcache carapace _carapace
```

The `source <()` process substitution is not evalcache-compatible. `_evalcache` handles both eval and source patterns — it caches the output and sources it. Keep the existing `if (( $+commands[carapace] ))` guard.

**6. dot_zsh.d/intelli-shell.zsh line 6 — intelli-shell (CACHE-03):**

Replace:
```zsh
  eval "$(intelli-shell init zsh)"
```

With:
```zsh
  _evalcache intelli-shell init zsh
```

Keep the existing `if (( $+commands[intelli-shell] ))` guard.
  </action>
  <verify>
1. Run `chezmoi apply ~/.zsh.d/hooks.zsh ~/.zsh.d/external.zsh ~/.zsh.d/atuin.zsh ~/.zsh.d/carapace.zsh ~/.zsh.d/intelli-shell.zsh` to deploy
2. Clear any existing evalcache: `_evalcache_clear 2>/dev/null; rm -rf ~/.zsh-evalcache`
3. Open new shell — must start without errors
4. Verify cache files created: `ls ~/.zsh-evalcache/` — should show cached files for oh-my-posh, zoxide, atuin, carapace, intelli-shell
5. Verify oh-my-posh prompt renders correctly (prompt-critical functionality)
6. Verify `z` command works (zoxide): `z /tmp && pwd && cd -`
7. Verify atuin history search: press Ctrl+R, confirm atuin search appears
8. Verify carapace completions: `git <TAB>` shows carapace-bridged completions
9. Verify mise NOT cached: `grep -r 'evalcache.*mise' ~/.zsh.d/` returns nothing
  </verify>
  <done>All five static init calls use _evalcache; mise remains uncached; shell fully functional</done>
</task>

<task type="auto">
  <name>Task 2: Measure improvement against baseline</name>
  <files></files>
  <action>
Measure shell startup time using the same methodology as Phase 19 baseline (hyperfine and zsh-bench).

**Step 1 — Ensure caches are warm:**
Open and close 2-3 shells so evalcache has populated its cache files.

**Step 2 — Measure with hyperfine:**
```bash
hyperfine --warmup 3 --runs 10 'zsh -i -c exit'
```

Record mean, stddev, min, max.

**Step 3 — Measure with zsh-bench (if available):**
```bash
zsh-bench
```

Record first_prompt_lag_ms.

**Step 4 — Calculate improvement:**
- Baseline (Phase 19 post-quick-wins): 283.7ms mean (hyperfine)
- Calculate: improvement_ms = 283.7 - new_mean
- Calculate: improvement_pct = improvement_ms / 283.7 * 100

**Step 5 — Document results:**
Save measurements to `.planning/phases/20-eval-caching-layer/post-caching-results.txt` including:
- hyperfine output (full)
- zsh-bench output (if available)
- Comparison table: baseline vs post-caching
- List of what was cached and estimated per-tool savings

**Step 6 — Verify target:**
If mean < 283.7ms, caching improved startup. If mean < 250ms, strong result. If mean < 200ms, exceptional.
  </action>
  <verify>
1. `.planning/phases/20-eval-caching-layer/post-caching-results.txt` exists with measurements
2. Measurements show improvement from 283.7ms baseline
3. Shell starts without errors after all measurements
  </verify>
  <done>Performance measured; improvement quantified against 283.7ms baseline; results documented</done>
</task>

</tasks>

<verification>
1. `grep -rn '_evalcache' ~/.zsh.d/` shows evalcache used in hooks.zsh, external.zsh, atuin.zsh, carapace.zsh, intelli-shell.zsh
2. `grep -rn 'eval "$(mise' ~/.zsh.d/` confirms mise is NOT cached
3. `ls ~/.zsh-evalcache/` shows cache files for all five tools
4. oh-my-posh prompt renders, zoxide works, atuin search works, completions work
5. `hyperfine 'zsh -i -c exit'` shows improvement from 283.7ms baseline
</verification>

<success_criteria>
- All five static eval init calls converted to _evalcache
- mise remains uncached (directory-dependent)
- Shell startup improved by measurable amount from 283.7ms baseline
- All tools functional: oh-my-posh prompt, zoxide navigation, atuin history, carapace completions, intelli-shell
- Results documented with before/after comparison
</success_criteria>

<output>
After completion, create `.planning/phases/20-eval-caching-layer/20-02-SUMMARY.md`
</output>
