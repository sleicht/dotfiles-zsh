---
phase: 20-eval-caching-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - private_dot_config/sheldon/plugins.toml
  - dot_zshrc.tmpl
  - dot_zlogin
autonomous: true

must_haves:
  truths:
    - "evalcache function (_evalcache) is available to all zsh.d source files"
    - "compinit uses -C flag when .zcompdump exists (no date subprocess spawns)"
    - ".zlogin compiles .zcompdump in background without blocking shell"
    - "sheldon source output is cached to file with mtime-based invalidation"
  artifacts:
    - path: "private_dot_config/sheldon/plugins.toml"
      provides: "evalcache plugin loaded before zsh-defer, simplified compinit"
      contains: "evalcache"
    - path: "dot_zshrc.tmpl"
      provides: "sheldon source caching with lock file invalidation"
      contains: "_sheldon_cache"
    - path: "dot_zlogin"
      provides: "background zcompdump compilation"
      contains: "zcompile"
  key_links:
    - from: "private_dot_config/sheldon/plugins.toml"
      to: "dot_zsh.d/*.zsh"
      via: "evalcache loaded first, available when dotfiles source group runs"
      pattern: "plugins\\.evalcache"
---

<objective>
Add evalcache plugin, simplify compinit, create background zcompile in .zlogin, and cache sheldon source output.

Purpose: Lay the caching foundation (CACHE-01, CACHE-04, CACHE-05, CACHE-06) so Plan 02 can convert eval calls to _evalcache.
Output: evalcache available as function, compinit simplified, .zlogin created, sheldon source cached.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-eval-caching-layer/20-RESEARCH.md
@.planning/phases/19-baseline-quick-wins/19-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add evalcache plugin and simplify compinit in plugins.toml</name>
  <files>private_dot_config/sheldon/plugins.toml</files>
  <action>
In the chezmoi source at `~/.local/share/chezmoi/private_dot_config/sheldon/plugins.toml`:

1. Add evalcache plugin BEFORE `[plugins.zsh-defer]` (must be first plugin to load so `_evalcache` function exists before any zsh.d files use it):

```toml
[plugins.evalcache]
github = "mroth/evalcache"
```

2. Replace the existing `[plugins.compinit]` inline block (lines 10-25) with simplified version that eliminates `date` subprocess spawns:

```toml
[plugins.compinit]
inline = '''
autoload -Uz compinit
if [[ -f "${ZDOTDIR:-$HOME}/.zcompdump" ]]; then
  compinit -C
else
  compinit
fi
'''
```

The `-C` flag skips security checks and new function detection — safe in single-user dotfiles. This eliminates two `date` subprocess spawns per shell startup.

Do NOT change any other plugins or their order.
  </action>
  <verify>
1. Run `chezmoi diff ~/.config/sheldon/plugins.toml` to confirm evalcache added before zsh-defer and compinit simplified
2. Run `chezmoi apply ~/.config/sheldon/plugins.toml` to deploy
3. Run `sheldon lock --update` to fetch evalcache plugin
4. Open new shell, run `(( $+functions[_evalcache] )) && echo "evalcache loaded" || echo "FAIL"` — must print "evalcache loaded"
5. Verify completions still work: type `git <TAB>` and confirm completion menu appears
  </verify>
  <done>evalcache loads before all other plugins; compinit uses -C when dump exists; no date subprocess spawns in compinit</done>
</task>

<task type="auto">
  <name>Task 2: Cache sheldon source and add background zcompile in .zlogin</name>
  <files>dot_zshrc.tmpl, dot_zlogin</files>
  <action>
**Part A — Cache sheldon source in dot_zshrc.tmpl:**

In `~/.local/share/chezmoi/dot_zshrc.tmpl`, replace the final line:
```zsh
eval "$(sheldon source)"
```

With mtime-based sheldon source caching using an anonymous function to avoid variable pollution:
```zsh
# === Plugin management (sheldon) ===
() {
  local cache_dir="${XDG_CACHE_HOME:-$HOME/.cache}/sheldon"
  local cache_file="$cache_dir/source.zsh"
  local lock_file="${XDG_CONFIG_HOME:-$HOME/.config}/sheldon/plugins.lock"

  if [[ ! -f "$cache_file" || "$lock_file" -nt "$cache_file" ]]; then
    mkdir -p "$cache_dir"
    sheldon source > "$cache_file"
  fi

  source "$cache_file"
}
```

This caches sheldon source output and only regenerates when plugins.lock changes (i.e., after `sheldon lock --update`). Saves ~8ms per startup (11ms eval → ~3ms file source).

**Part B — Create dot_zlogin for background zcompile:**

Create new file `~/.local/share/chezmoi/dot_zlogin` with:
```zsh
# .zlogin - managed by chezmoi
# Runs once per login session (not per shell)

# Compile zsh completion dump in background for faster loading
{
  local zcompdump="${ZDOTDIR:-$HOME}/.zcompdump"

  if [[ -s "$zcompdump" && (! -s "${zcompdump}.zwc" || "$zcompdump" -nt "${zcompdump}.zwc") ]]; then
    zcompile "$zcompdump"
  fi
} &!
```

The `&!` runs the block asynchronously and disowns it, so it never blocks shell startup. Only compiles when .zcompdump is newer than .zcompdump.zwc.

Adapted from zimfw PR #218 pattern.
  </action>
  <verify>
1. Run `chezmoi diff ~/.zshrc` and `chezmoi diff ~/.zlogin` to confirm changes
2. Run `chezmoi apply ~/.zshrc ~/.zlogin` to deploy
3. Open new shell — must start without errors
4. Verify sheldon cache exists: `ls -la ~/.cache/sheldon/source.zsh` — file must exist
5. Verify cache invalidation: `sheldon lock --update && zsh -ic 'exit'` — cache file mtime must be newer than before
6. Verify .zlogin deployed: `ls -la ~/.zlogin` — file must exist
7. Verify zcompdump compilation: after login shell, check `ls -la ~/.zcompdump.zwc` — file should exist
  </verify>
  <done>sheldon source cached to file with mtime invalidation; .zlogin compiles .zcompdump in background; shell starts without errors</done>
</task>

</tasks>

<verification>
1. New shell starts without errors
2. `(( $+functions[_evalcache] )) && echo OK` prints OK
3. `ls ~/.cache/sheldon/source.zsh` shows cached file
4. `grep -c 'date' ~/.config/sheldon/plugins.toml` returns 0 (no date subprocess in compinit)
5. `ls ~/.zlogin` shows file exists
6. Completions work: `git <TAB>` shows completion menu
</verification>

<success_criteria>
- evalcache function available in shell (loaded before dotfiles source group)
- compinit simplified to always use -C when dump exists
- sheldon source cached with mtime invalidation
- .zlogin performs background zcompile
- Shell fully functional with no startup errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-eval-caching-layer/20-01-SUMMARY.md`
</output>
