---
phase: 06-security-secrets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .chezmoidata.yaml
  - .gitleaks.toml
  - .pre-commit-config.yaml
autonomous: true

must_haves:
  truths:
    - "Gitleaks scans every commit in the dotfiles repo for secrets"
    - "Pre-push hook blocks pushes containing detected secrets"
    - "Chezmoi template syntax in .tmpl files does not trigger false positives"
    - "Security tools (gitleaks, pre-commit, bitwarden-cli, age) are declared in package list"
  artifacts:
    - path: "~/.local/share/chezmoi/.gitleaks.toml"
      provides: "Gitleaks configuration with chezmoi template allowlists"
      contains: "useDefault = true"
    - path: "~/.local/share/chezmoi/.pre-commit-config.yaml"
      provides: "Pre-commit hook configuration with gitleaks"
      contains: "gitleaks"
    - path: "~/.local/share/chezmoi/.chezmoidata.yaml"
      provides: "Updated package list including security tools"
      contains: "bitwarden-cli"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: ".gitleaks.toml"
      via: "gitleaks hook references config file"
      pattern: "--config.*\\.gitleaks\\.toml"
---

<objective>
Install security tooling and configure leak prevention for the dotfiles repository.

Purpose: Establish the foundation for all security work — install gitleaks, pre-commit, bitwarden-cli, and age via Homebrew, then configure gitleaks with chezmoi-aware allowlists and pre-commit hooks for the dotfiles repo. This addresses SECU-03 (dotfiles-repo leak prevention).

Output: Security tools installable via `chezmoi apply`, gitleaks scanning active on every commit, pre-push blocking enabled, existing repo scanned for secrets.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-secrets/06-RESEARCH.md
@.planning/phases/06-security-secrets/06-CONTEXT.md
@~/.local/share/chezmoi/.chezmoidata.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add security tools to package list and install</name>
  <files>~/.local/share/chezmoi/.chezmoidata.yaml</files>
  <action>
Add the following packages to the `common_brews` section in `.chezmoidata.yaml` (maintain alphabetical order):
- `age`
- `bitwarden-cli`
- `gitleaks`
- `pre-commit`

Note: `gnupg` and `git-credential-manager` (cask) are already in the package list.

After updating the data file, run `chezmoi apply` to regenerate the Brewfile, then `brew bundle install --global` to install the new packages.

Verify all four tools are accessible: `age --version`, `bw --version`, `gitleaks version`, `pre-commit --version`.
  </action>
  <verify>
Run: `age --version && bw --version && gitleaks version && pre-commit --version`
All four commands return version numbers without error.
  </verify>
  <done>Security tools (age, bitwarden-cli, gitleaks, pre-commit) are declared in .chezmoidata.yaml and installed via Homebrew.</done>
</task>

<task type="auto">
  <name>Task 2: Configure gitleaks and pre-commit hooks for dotfiles repo</name>
  <files>~/.local/share/chezmoi/.gitleaks.toml, ~/.local/share/chezmoi/.pre-commit-config.yaml</files>
  <action>
Create `.gitleaks.toml` in the chezmoi source directory with:
- `[extend]` section with `useDefault = true` to inherit all built-in detection rules
- Allowlist for `.tmpl` files: regex patterns for `{{.*bitwarden.*}}`, `{{.*bitwardenFields.*}}`, `{{.*chezmoi\..*}}`, `{{.*onepassword.*}}`, `{{.*keepass.*}}`
- Stopwords: `bitwarden`, `bitwardenFields`, `bitwardenAttachment`
- Allowlist for age public keys (pattern `age1[a-z0-9]{58}`) since these are safe to commit
- Global allowlist paths: `.gitleaks.toml`, `.pre-commit-config.yaml`, `.*\.md$` (docs may contain example secrets)

Create `.pre-commit-config.yaml` in the chezmoi source directory with:
- `pre-commit/pre-commit-hooks` repo (rev v4.4.0): `check-yaml`, `end-of-file-fixer`, `trailing-whitespace`, `check-merge-conflict`
- `gitleaks/gitleaks` repo (rev v8.24.2): `gitleaks` hook with stages `[pre-commit, pre-push]` and args `['--verbose', '--config', '.gitleaks.toml']`
- `default_install_hook_types: [pre-commit, pre-push]`

Install the hooks in the chezmoi source directory:
```bash
cd ~/.local/share/chezmoi && pre-commit install --hook-type pre-commit --hook-type pre-push
```

Scan the existing repo history for any pre-existing secrets:
```bash
cd ~/.local/share/chezmoi && gitleaks detect --verbose --config .gitleaks.toml
```

If secrets are found in history, document them in the SUMMARY but do NOT attempt to rewrite history automatically. Flag for user attention.

Per user decision: warn-then-block strictness. The pre-commit stage warns (shows findings), the pre-push stage blocks (prevents push if secrets detected). Both use the same gitleaks hook — the blocking behaviour comes from the pre-push stage being a hard gate.
  </action>
  <verify>
Run from chezmoi source dir:
1. `ls ~/.local/share/chezmoi/.gitleaks.toml ~/.local/share/chezmoi/.pre-commit-config.yaml` — both files exist
2. `cd ~/.local/share/chezmoi && pre-commit run --all-files` — runs without errors (may have warnings for existing formatting)
3. `cd ~/.local/share/chezmoi && gitleaks detect --verbose --config .gitleaks.toml` — reports results (ideally 0 secrets)
  </verify>
  <done>Gitleaks config with chezmoi-aware allowlists is active. Pre-commit hooks scan every commit, pre-push hooks block secret leaks. Existing repo scanned for pre-existing secrets.</done>
</task>

</tasks>

<verification>
1. `age --version` returns version
2. `bw --version` returns version
3. `gitleaks version` returns version
4. `pre-commit --version` returns version
5. `ls ~/.local/share/chezmoi/.gitleaks.toml` exists
6. `ls ~/.local/share/chezmoi/.pre-commit-config.yaml` exists
7. `cd ~/.local/share/chezmoi && pre-commit run --all-files` completes
8. `cd ~/.local/share/chezmoi && gitleaks detect --config .gitleaks.toml` completes
</verification>

<success_criteria>
- All four security tools installed and accessible
- Gitleaks configured with chezmoi template allowlists (no false positives on .tmpl files)
- Pre-commit hooks installed in chezmoi source directory (pre-commit + pre-push stages)
- Existing repo scanned; any pre-existing secrets documented
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-secrets/06-01-SUMMARY.md`
</output>
