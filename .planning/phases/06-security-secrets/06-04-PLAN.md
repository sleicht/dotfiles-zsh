---
phase: 06-security-secrets
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - .chezmoi.yaml.tmpl
  - .chezmoidata.yaml
  - private_dot_gitconfig_local.tmpl
autonomous: false
user_setup:
  - service: bitwarden
    why: "Secret sourcing for chezmoi templates"
    env_vars: []
    dashboard_config:
      - task: "Create Bitwarden items for dotfile secrets"
        location: "Bitwarden vault -> dotfiles/ folders"

must_haves:
  truths:
    - "Git config email is sourced from Bitwarden instead of chezmoi prompt data"
    - "chezmoi apply retrieves secrets from Bitwarden transparently"
    - "Bitwarden auto-unlock is configured so user is not prompted repeatedly"
    - "No secrets are hardcoded in chezmoi source files"
    - "User can rotate secrets in Bitwarden and re-run chezmoi apply to propagate"
  artifacts:
    - path: "~/.local/share/chezmoi/.chezmoi.yaml.tmpl"
      provides: "Bitwarden auto-unlock configuration"
      contains: "bitwarden"
    - path: "~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl"
      provides: "Git config templated from Bitwarden"
      contains: "bitwarden"
    - path: "~/.local/share/chezmoi/.chezmoidata.yaml"
      provides: "Bitwarden naming convention reference"
      contains: "bitwarden"
  key_links:
    - from: "private_dot_gitconfig_local.tmpl"
      to: "Bitwarden vault"
      via: "bitwarden template function"
      pattern: "bitwarden.*item"
    - from: ".chezmoi.yaml.tmpl"
      to: "bw CLI"
      via: "bitwarden.command and unlock config"
      pattern: "bitwarden.*unlock"
---

<objective>
Integrate Bitwarden as the secret source for chezmoi templates, replacing hardcoded values.

Purpose: Addresses SECU-01 — secrets (git credentials, API tokens, emails) are sourced from Bitwarden at `chezmoi apply` time instead of being committed to git. This enables secret rotation via Bitwarden with automatic propagation to all machines.

Output: Bitwarden configured in chezmoi, git config email templated from Bitwarden, naming convention documented, ready for additional secret templates as needed.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-secrets/06-RESEARCH.md
@.planning/phases/06-security-secrets/06-CONTEXT.md
@~/.local/share/chezmoi/.chezmoi.yaml.tmpl
@~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl
@~/.local/share/chezmoi/.chezmoidata.yaml
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Bitwarden items for dotfile secrets</name>
  <what-built>The Bitwarden folder structure was created in Plan 03 (dotfiles/personal, dotfiles/client, dotfiles/shared). Now the user needs to create the actual secret items that chezmoi templates will reference.</what-built>
  <instructions>
Create the following Bitwarden items. For each, the item type and fields are specified:

**1. Git config (shared across machine types):**
- **Name:** `dotfiles/shared/git-config`
- **Folder:** `dotfiles/shared`
- **Type:** Login
- **Username:** `Stephan Leicht Vogt` (git user.name)
- **Custom Fields:**
  - `personal_email` (text): your personal email address
  - `work_email` (text): your work email address

**2. GitHub token (per machine type — create for current machine):**
- **Name:** `dotfiles/{machine_type}/github-token` (e.g., `dotfiles/personal/github-token`)
- **Folder:** `dotfiles/{machine_type}`
- **Type:** Login
- **Username:** your GitHub username
- **Password:** your GitHub personal access token (if you use one)
- If you don't use a PAT (relying on GCM/SSH instead), you can skip this item.

**3. Any API tokens in shell env vars:**
- Check `~/.zsh.d.private/` for any files containing API keys (Anthropic, OpenAI, etc.)
- For each, create a Bitwarden item:
  - **Name:** `dotfiles/{machine_type}/{service}-api-key`
  - **Folder:** `dotfiles/{machine_type}`
  - **Type:** Login
  - **Password:** the API key value

After creating items, verify Bitwarden CLI access:
```bash
bw login   # first time
export BW_SESSION="$(bw unlock --raw)"
bw list items --search "dotfiles/" | jq '.[].name'
```

This should list all the items you just created.

Note: At minimum, only the `dotfiles/shared/git-config` item is REQUIRED for this plan to proceed. Other items are optional depending on what secrets you want to manage via Bitwarden.
  </instructions>
  <resume-signal>Type "created" with a list of which Bitwarden items you created, or describe any issues. At minimum: "created dotfiles/shared/git-config".</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Configure Bitwarden in chezmoi and template git config from Bitwarden</name>
  <files>~/.local/share/chezmoi/.chezmoi.yaml.tmpl, ~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl, ~/.local/share/chezmoi/.chezmoidata.yaml</files>
  <action>
Step 1 — Add Bitwarden configuration to `.chezmoi.yaml.tmpl`:

Add the following AFTER the `age:` section and BEFORE `data:`:

```yaml
[bitwarden]
  command = "bw"
  unlock = "auto"
```

The `unlock = "auto"` setting means chezmoi will automatically prompt for Bitwarden unlock if no session exists, and reuse existing sessions if available. Per user decision: Claude's discretion on auth flow, and auto-unlock is the recommended approach from research.

Step 2 — Add Bitwarden naming convention to `.chezmoidata.yaml`:

Add a `bitwarden` section at the top level (after `tools:` section):

```yaml
# Bitwarden naming convention for dotfile secrets
bitwarden:
  folders:
    shared: "dotfiles/shared"
    client: "dotfiles/client"
    personal: "dotfiles/personal"
```

This documents the naming convention but is NOT used in templates directly (Bitwarden template functions take literal item names, not data variables).

Step 3 — Update `private_dot_gitconfig_local.tmpl` to source email from Bitwarden:

Replace the current template content with Bitwarden-sourced values:

```
# Managed by chezmoi - do not edit directly
# Machine type: {{ .machine_type }}
# Generated: {{ now | date "2006-01-02" }}

[user]
  name = {{ (bitwarden "item" "dotfiles/shared/git-config").login.username }}
{{- if eq .machine_type "client" }}
  email = {{ (bitwardenFields "item" "dotfiles/shared/git-config").work_email.value }}
{{- else }}
  email = {{ (bitwardenFields "item" "dotfiles/shared/git-config").personal_email.value }}
{{- end }}
```

This replaces the current approach that uses `{{ .work_email }}` / `{{ .personal_email }}` from chezmoi prompt data with Bitwarden-sourced values. The emails are now in Bitwarden, not in `~/.config/chezmoi/chezmoi.yaml`.

IMPORTANT: Keep the prompt variables in `.chezmoi.yaml.tmpl` for now — they may still be used by other templates or for fallback. They can be removed in a future cleanup if all secrets are migrated.

Step 4 — Add `# gitleaks:allow` comments to template lines:

Any line in `.tmpl` files that calls `bitwarden` or `bitwardenFields` should have an inline `# gitleaks:allow` comment to prevent false positives (even though `.gitleaks.toml` has allowlists, belt-and-suspenders is good practice for security).

Step 5 — Test the integration:

```bash
# Ensure Bitwarden is unlocked
export BW_SESSION="$(bw unlock --raw)"

# Test template rendering
chezmoi execute-template < ~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl

# Apply and verify
chezmoi apply ~/.gitconfig_local
cat ~/.gitconfig_local
```

The output should show the correct name and email sourced from Bitwarden.

Step 6 — Verify secret rotation workflow:

Document (in SUMMARY) the rotation workflow:
1. Update secret in Bitwarden (e.g., change email)
2. Run `chezmoi apply` (Bitwarden cache refreshes automatically on new session)
3. Verify updated value in target file
  </action>
  <verify>
1. `chezmoi cat-config | grep -A2 bitwarden` — shows bitwarden command and unlock config
2. `chezmoi execute-template '{{ (bitwarden "item" "dotfiles/shared/git-config").login.username }}'` — returns git username
3. `chezmoi apply ~/.gitconfig_local && cat ~/.gitconfig_local` — shows correct name and email from Bitwarden
4. `grep bitwarden ~/.local/share/chezmoi/.chezmoidata.yaml` — naming convention documented
  </verify>
  <done>Bitwarden integrated into chezmoi. Git config email sourced from Bitwarden. Auto-unlock configured. Naming convention documented. Secret rotation workflow verified.</done>
</task>

</tasks>

<verification>
1. Bitwarden configured in `.chezmoi.yaml.tmpl` with auto-unlock
2. Git config email templated from Bitwarden (not hardcoded)
3. `chezmoi apply` retrieves secrets from Bitwarden transparently
4. Bitwarden naming convention documented in `.chezmoidata.yaml`
5. No secrets committed to git in chezmoi source
</verification>

<success_criteria>
- Bitwarden auto-unlock configured in chezmoi
- At least one config file (gitconfig_local) templates secrets from Bitwarden
- Naming convention established for Bitwarden items (dotfiles/{type}/{name})
- Secret rotation workflow documented and tested
- gitleaks:allow annotations on Bitwarden template lines
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-secrets/06-04-SUMMARY.md`
</output>
