---
phase: 06-security-secrets
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .chezmoi.yaml.tmpl
autonomous: false
user_setup:
  - service: age
    why: "Offline-accessible SSH/GPG key encryption"
    env_vars: []
    dashboard_config:
      - task: "Store age private key in Bitwarden"
        location: "Bitwarden vault -> Create item named 'dotfiles/personal/age-private-key' (or dotfiles/client/age-private-key for client machine)"

must_haves:
  truths:
    - "Age encryption is configured in chezmoi with per-machine key pairs"
    - "SSH private keys are encrypted with age and stored in chezmoi source"
    - "Age private key is stored in Bitwarden for disaster recovery"
    - "chezmoi apply decrypts SSH keys transparently on machines with the age key"
  artifacts:
    - path: "~/.local/share/chezmoi/.chezmoi.yaml.tmpl"
      provides: "Age encryption configuration with per-machine key identity"
      contains: "encryption"
    - path: "~/.config/age/key-personal.txt"
      provides: "Age private key file (or key-client.txt for client machines)"
  key_links:
    - from: ".chezmoi.yaml.tmpl"
      to: "~/.config/age/key-{{ .machine_type }}.txt"
      via: "age identity path configuration"
      pattern: "age.*identity"
    - from: "encrypted_* files in chezmoi source"
      to: "age key"
      via: "chezmoi decrypt at apply time"
      pattern: "encrypted_"
---

<objective>
Configure age encryption in chezmoi and encrypt SSH keys for secure git storage.

Purpose: Addresses SECU-02 — SSH keys need to be available before Bitwarden is accessible (to clone private repos), so they are encrypted with age and stored in the chezmoi git repo. The age private key itself is stored in Bitwarden, creating the bootstrap chain: unlock Bitwarden -> get age key -> decrypt SSH keys -> full access.

Output: Age encryption configured in chezmoi, SSH private keys encrypted in source, age key generated and ready for Bitwarden storage.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-secrets/06-RESEARCH.md
@.planning/phases/06-security-secrets/06-CONTEXT.md
@~/.local/share/chezmoi/.chezmoi.yaml.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate age key pair and configure chezmoi encryption</name>
  <files>~/.local/share/chezmoi/.chezmoi.yaml.tmpl, ~/.config/age/key-*.txt</files>
  <action>
Step 1 — Generate age key pair:

Determine the current machine_type from chezmoi data:
```bash
chezmoi data | grep machine_type
```

Create the age key directory and generate a key pair:
```bash
mkdir -p ~/.config/age
age-keygen -o ~/.config/age/key-<machine_type>.txt
```

The output will show the public key (starts with `age1...`). Record this — it is the recipient for encryption.

Set correct permissions on the key file:
```bash
chmod 600 ~/.config/age/key-<machine_type>.txt
```

Step 2 — Update `.chezmoi.yaml.tmpl` to add age encryption configuration:

Add the following AFTER the existing `diff:` section and BEFORE `data:`:

```yaml
encryption: "age"
age:
  identity: "{{ "{{" }} .chezmoi.homeDir {{ "}}" }}/.config/age/key-{{ "{{" }} .machine_type {{ "}}" }}.txt"
  recipient: "<the age1... public key from step 1>"
```

IMPORTANT: Since this is a Go template file, the actual template syntax uses `{{ }}` delimiters. The identity path must use chezmoi template variables to resolve the home directory and machine type at init time.

Per user decision: per-machine age key pairs for better isolation between client and personal machines. When setting up the other machine type, a new key pair will be generated with a different recipient. For now, configure only the current machine's recipient.

Step 3 — Verify configuration:

```bash
chezmoi init --apply=false
chezmoi cat-config | grep -A3 encryption
```

This should show the age encryption settings with the correct identity path.

Step 4 — Encrypt SSH private keys:

Add each SSH private key to chezmoi with encryption:
```bash
chezmoi add --encrypt ~/.ssh/id_rsa
chezmoi add --encrypt ~/.ssh/id_rsa_digiocean
chezmoi add --encrypt ~/.ssh/id_rsa_infomaniak
chezmoi add --encrypt ~/.ssh/google_compute_engine
```

Also add the SSH public keys (without encryption — public keys are safe):
```bash
chezmoi add ~/.ssh/id_rsa.pub
chezmoi add ~/.ssh/id_rsa_digiocean.pub
chezmoi add ~/.ssh/google_compute_engine.pub
```

Add SSH config (without encryption — it contains hostnames, not secrets):
```bash
chezmoi add ~/.ssh/config
```

Verify encrypted files in source:
```bash
ls ~/.local/share/chezmoi/private_dot_ssh/
```

Should show `encrypted_private_*` files for private keys and regular files for public keys.

Do NOT add `known_hosts` or `known_hosts.old` — these are machine-specific and auto-generated.

Step 5 — Verify decryption works:

```bash
chezmoi diff ~/.ssh/id_rsa
```

Should show no diff (encrypted source decrypts to match current file).
  </action>
  <verify>
1. `ls ~/.config/age/key-*.txt` — age key file exists
2. `stat -f "%Lp" ~/.config/age/key-*.txt` — permissions are 600
3. `chezmoi cat-config | grep encryption` — shows "age"
4. `ls ~/.local/share/chezmoi/private_dot_ssh/` — shows encrypted_private_* files
5. `chezmoi diff ~/.ssh/id_rsa` — no diff (decryption works correctly)
  </verify>
  <done>Age encryption configured in chezmoi. SSH private keys encrypted in source. Age key pair generated for current machine type.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Store age private key in Bitwarden</name>
  <what-built>Age key pair generated and SSH keys encrypted. The age private key at ~/.config/age/key-{machine_type}.txt is the single most important file — it decrypts all encrypted files in the chezmoi source.</what-built>
  <instructions>
The age private key must be stored in Bitwarden for disaster recovery.

1. Open Bitwarden (web vault or desktop app)
2. Create a new folder structure (if not already existing):
   - `dotfiles/personal` (for personal machine secrets)
   - `dotfiles/client` (for client machine secrets)
   - `dotfiles/shared` (for secrets shared across machine types)
3. Create a new Secure Note item:
   - **Name:** `dotfiles/{machine_type}/age-private-key`
     (e.g., `dotfiles/personal/age-private-key` for personal machine)
   - **Folder:** `dotfiles/{machine_type}`
   - **Notes:** Paste the FULL contents of `~/.config/age/key-{machine_type}.txt`
     (includes the `# created:` comment line AND the `AGE-SECRET-KEY-1...` line)
   - **Custom field (optional):** Add a field called `public_key` with the `age1...` public key value for reference

4. Verify you can retrieve it:
   ```bash
   bw login   # if not already logged in
   export BW_SESSION="$(bw unlock --raw)"
   bw get notes "dotfiles/personal/age-private-key"   # should print the key contents
   ```

This is the ONLY step that requires manual Bitwarden interaction. After this, the bootstrap chain is complete: Bitwarden -> age key -> SSH keys -> full access.
  </instructions>
  <resume-signal>Type "stored" when the age private key is saved in Bitwarden, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. Age encryption configured in `.chezmoi.yaml.tmpl`
2. SSH private keys encrypted in chezmoi source (encrypted_private_* files)
3. SSH public keys stored unencrypted in chezmoi source
4. Age private key stored in Bitwarden for disaster recovery
5. `chezmoi apply` successfully decrypts and applies SSH keys
</verification>

<success_criteria>
- Age key pair generated for current machine type
- chezmoi encryption configured with correct identity and recipient
- All SSH private keys encrypted with age in chezmoi source
- Age private key backed up in Bitwarden
- `chezmoi diff` shows no differences for SSH keys (round-trip verified)
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-secrets/06-03-SUMMARY.md`
</output>
