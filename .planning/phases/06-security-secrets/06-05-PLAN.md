---
phase: 06-security-secrets
plan: 05
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03", "06-04"]
files_modified:
  - private_dot_config/git/hooks/pre-commit
  - private_dot_config/git/hooks/pre-push
  - dot_gitconfig
autonomous: false

must_haves:
  truths:
    - "Global git hooks scan staged changes for secrets in all repositories"
    - "Dotfiles repo has strict scanning (pre-commit + pre-push)"
    - "Global hooks use lighter rules to avoid friction in work repos"
    - "User can verify all 5 ROADMAP success criteria pass"
    - "Permission verification runs and passes"
    - "SSH keys are encrypted in chezmoi source and decrypt correctly"
    - "Git config email is sourced from Bitwarden"
  artifacts:
    - path: "~/.local/share/chezmoi/private_dot_config/git/hooks/pre-commit"
      provides: "Global git pre-commit hook with gitleaks"
    - path: "~/.local/share/chezmoi/private_dot_config/git/hooks/pre-push"
      provides: "Global git pre-push hook with gitleaks blocking"
  key_links:
    - from: "global git hooks"
      to: "gitleaks binary"
      via: "which gitleaks check before scanning"
      pattern: "gitleaks protect"
    - from: "git config core.hooksPath"
      to: "~/.config/git/hooks"
      via: "global git hook directory"
      pattern: "hooksPath"
---

<objective>
Deploy global git hooks via chezmoi and verify all Phase 6 security measures work correctly.

Purpose: Completes SECU-03 (global leak prevention) and verifies all ROADMAP success criteria for Phase 6. Global hooks provide a lighter security net across ALL git repositories, complementing the strict scanning in the dotfiles repo.

Output: Global git hooks deployed, all 5 success criteria verified, phase complete.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-secrets/06-RESEARCH.md
@.planning/phases/06-security-secrets/06-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy global git hooks via chezmoi with core.hooksPath delegation</name>
  <files>~/.local/share/chezmoi/private_dot_config/git/hooks/pre-commit, ~/.local/share/chezmoi/private_dot_config/git/hooks/pre-push, ~/.local/share/chezmoi/dot_gitconfig</files>
  <action>
**Approach:** Set `core.hooksPath = ~/.config/git/hooks` in dot_gitconfig. Each global hook delegates to repo-local `.git/hooks/{name}` if it exists (so repos using the pre-commit framework still work). Otherwise, run gitleaks scanning. Per user decision: warn on commit, block on push.

**Step 1 — Create hooks directory in chezmoi source:**

```bash
mkdir -p ~/.local/share/chezmoi/private_dot_config/git/hooks
```

**Step 2 — Create `pre-commit` hook:**

Write to `~/.local/share/chezmoi/private_dot_config/git/hooks/pre-commit`:

```bash
#!/bin/bash
# Global pre-commit hook — light secret scanning for all repos
# Deployed by chezmoi to ~/.config/git/hooks/pre-commit

# Delegate to repo-local hook if it exists (e.g., pre-commit framework)
if [[ -x .git/hooks/pre-commit ]]; then
  exec .git/hooks/pre-commit "$@"
fi

# Skip if gitleaks is not installed
if ! command -v gitleaks &> /dev/null; then
  exit 0
fi

# Scan staged changes
gitleaks protect --staged --verbose 2>&1
exit_code=$?

if [[ $exit_code -ne 0 ]]; then
  echo ""
  echo "WARNING: Potential secrets detected in staged changes."
  echo "Review the findings above. If these are false positives:"
  echo "  - Add '# gitleaks:allow' inline comment"
  echo "  - Or use SKIP=gitleaks git commit (use sparingly)"
  echo ""
fi

# Warn only on commit (exit 0 regardless) — per user decision
exit 0
```

**Step 3 — Create `pre-push` hook:**

Write to `~/.local/share/chezmoi/private_dot_config/git/hooks/pre-push`:

```bash
#!/bin/bash
# Global pre-push hook — blocks pushes containing detected secrets
# Deployed by chezmoi to ~/.config/git/hooks/pre-push

# Delegate to repo-local hook if it exists
if [[ -x .git/hooks/pre-push ]]; then
  exec .git/hooks/pre-push "$@"
fi

# Skip if gitleaks is not installed
if ! command -v gitleaks &> /dev/null; then
  exit 0
fi

# Scan changes about to be pushed
gitleaks protect --staged --verbose 2>&1
exit_code=$?

if [[ $exit_code -ne 0 ]]; then
  echo ""
  echo "BLOCKED: Potential secrets detected. Push aborted."
  echo "Review the findings above. If these are false positives:"
  echo "  - Add '# gitleaks:allow' inline comment to the source file"
  echo "  - Or use SKIP=gitleaks git push (use sparingly)"
  echo ""
  exit 1
fi

exit 0
```

**Step 4 — Make hooks executable in chezmoi:**

```bash
chezmoi chattr +x private_dot_config/git/hooks/pre-commit
chezmoi chattr +x private_dot_config/git/hooks/pre-push
```

If `chezmoi chattr` does not work on files not yet applied, rename the files in the source directory to use the `executable_` prefix instead:
- `executable_pre-commit`
- `executable_pre-push`

**Step 5 — Add `core.hooksPath` to dot_gitconfig:**

Edit `~/.local/share/chezmoi/dot_gitconfig` and add under the `[core]` section:

```ini
[core]
	hooksPath = ~/.config/git/hooks
```

If no `[core]` section exists, create one. This tells git to use global hooks from `~/.config/git/hooks/` for all repos. The delegation logic in each hook ensures repos with local `.git/hooks/` hooks (like the dotfiles repo with pre-commit framework) still work correctly.

**Step 6 — Apply and verify:**

```bash
chezmoi apply
ls -la ~/.config/git/hooks/
git config --global core.hooksPath
```

**Step 7 — Test in a temporary repo:**

```bash
cd /tmp && mkdir test-hooks-repo && cd test-hooks-repo && git init
echo "AKIAIOSFODNN7EXAMPLE" > test.txt
git add test.txt
git commit -m "test"  # should warn about potential secret but allow commit
cd - && rm -rf /tmp/test-hooks-repo
```
  </action>
  <verify>
1. `ls -la ~/.config/git/hooks/pre-commit ~/.config/git/hooks/pre-push` — both exist and are executable
2. `git config --global core.hooksPath` — shows `~/.config/git/hooks`
3. Test in a temp repo: creating a commit with a fake AWS key triggers a warning but allows the commit
4. In the dotfiles repo: `cd ~/.local/share/chezmoi && git commit --allow-empty -m "test"` — runs pre-commit framework (delegated from global hook), not the gitleaks-only global logic
  </verify>
  <done>Global git hooks deployed via chezmoi. core.hooksPath set in gitconfig. Warn-on-commit, block-on-push behaviour active for all repos. Repos with pre-commit framework delegate correctly via .git/hooks/ check.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all Phase 6 success criteria</name>
  <what-built>Complete Phase 6 security implementation: Bitwarden integration, age encryption, gitleaks pre-commit hooks, permission verification, and global git hooks.</what-built>
  <how-to-verify>
Verify all 5 ROADMAP success criteria:

**1. Secret templating from Bitwarden (SECU-01):**
```bash
cat ~/.gitconfig_local
# Should show name and email sourced from Bitwarden (not hardcoded in git)
grep -r "bitwarden" ~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl
# Should show bitwarden template function calls
```

**2. Age encryption for sensitive files (SECU-02):**
```bash
ls ~/.local/share/chezmoi/private_dot_ssh/
# Should show encrypted_private_* files (age-encrypted SSH keys)
chezmoi diff ~/.ssh/id_rsa
# Should show no diff (decryption works)
```

**3. Secret leak prevention (SECU-03):**
```bash
cd ~/.local/share/chezmoi && pre-commit run --all-files
# Pre-commit hooks should run without blocking
git config --global core.hooksPath
# Should show ~/.config/git/hooks
ls ~/.config/git/hooks/
# Should show pre-commit and pre-push hooks
```

**4. Permission verification (SECU-04):**
```bash
chezmoi apply 2>&1 | grep -i "permission"
# Should show permission verification output
stat -f "%Lp" ~/.ssh/id_rsa
# Should return 600
cat ~/.local/state/chezmoi/permission-fixes.log
# Log file should exist
```

**5. Secret rotation workflow:**
```bash
# This is a process check, not a command:
# 1. Could you change email in Bitwarden > dotfiles/shared/git-config?
# 2. Run: chezmoi apply
# 3. Check: cat ~/.gitconfig_local (email should update)
# (Don't actually change it unless you want to test)
```

Open a new terminal and verify:
- Shell works correctly
- `chezmoi verify` passes
- `git commit` in a test repo triggers global hook
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Global git hooks exist and are executable at `~/.config/git/hooks/`
2. `core.hooksPath` configured in gitconfig
3. Global hooks delegate to repo-local hooks when present
4. All 5 ROADMAP success criteria verified
5. Shell works correctly in new terminal
</verification>

<success_criteria>
- Global git hooks deployed via chezmoi for all repos
- Warn-on-commit, block-on-push behaviour working
- All 5 Phase 6 ROADMAP success criteria pass
- User confirms security measures are working
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-secrets/06-05-SUMMARY.md`
</output>
