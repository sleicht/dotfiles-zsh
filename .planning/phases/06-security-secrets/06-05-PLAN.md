---
phase: 06-security-secrets
plan: 05
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03", "06-04"]
files_modified:
  - dot_config/git/hooks
  - run_once_after_install-global-git-hooks.sh.tmpl
autonomous: false

must_haves:
  truths:
    - "Global git hooks scan staged changes for secrets in all repositories"
    - "Dotfiles repo has strict scanning (pre-commit + pre-push)"
    - "Global hooks use lighter rules to avoid friction in work repos"
    - "User can verify all 5 ROADMAP success criteria pass"
    - "Permission verification runs and passes"
    - "SSH keys are encrypted in chezmoi source and decrypt correctly"
    - "Git config email is sourced from Bitwarden"
  artifacts:
    - path: "~/.local/share/chezmoi/private_dot_config/git/hooks/pre-commit"
      provides: "Global git pre-commit hook with gitleaks"
    - path: "~/.local/share/chezmoi/private_dot_config/git/hooks/pre-push"
      provides: "Global git pre-push hook with gitleaks blocking"
  key_links:
    - from: "global git hooks"
      to: "gitleaks binary"
      via: "which gitleaks check before scanning"
      pattern: "gitleaks protect"
    - from: "git config core.hooksPath"
      to: "~/.config/git/hooks"
      via: "global git hook directory"
      pattern: "hooksPath"
---

<objective>
Deploy global git hooks via chezmoi and verify all Phase 6 security measures work correctly.

Purpose: Completes SECU-03 (global leak prevention) and verifies all ROADMAP success criteria for Phase 6. Global hooks provide a lighter security net across ALL git repositories, complementing the strict scanning in the dotfiles repo.

Output: Global git hooks deployed, all 5 success criteria verified, phase complete.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-secrets/06-RESEARCH.md
@.planning/phases/06-security-secrets/06-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy global git hooks via chezmoi</name>
  <files>~/.local/share/chezmoi/private_dot_config/git/hooks/pre-commit, ~/.local/share/chezmoi/private_dot_config/git/hooks/pre-push</files>
  <action>
Create global git hooks that are deployed by chezmoi to `~/.config/git/hooks/`. Git automatically uses hooks from `core.hooksPath` (defaults to `~/.config/git/hooks/` when using XDG directories), or you can set it explicitly.

Step 1 — Create the hooks directory in chezmoi source:

The path should be `private_dot_config/git/hooks/` (using private_ for the config directory, which already exists as `private_dot_config/`).

Create the directories:
```bash
mkdir -p ~/.local/share/chezmoi/private_dot_config/git/executable_hooks
```

Wait — chezmoi needs hooks to be executable. Use the `executable_` prefix on individual hook files, or ensure the directory structure uses the right chezmoi attributes.

Actually, the correct approach: create hook files with `executable_` prefix so chezmoi sets the execute bit, or use `.chezmoiattrs` in the directory. The simplest approach: place the files directly with `executable_` prefix.

Path in chezmoi source: `private_dot_config/git/hooks/`
For the files within to be executable, use: `run_` prefix won't work here (that's for scripts). Instead, create a `.chezmoiattrs` file in the hooks directory OR use `chezmoi add --template=false` after creating the files.

Simplest approach: create the files manually in the source directory, then use `chezmoi chattr +x` to mark them executable.

Step 2 — Create `pre-commit` hook (lighter rules for global use):

```bash
#!/bin/bash
# Global pre-commit hook - light secret scanning for all repos
# Deployed by chezmoi to ~/.config/git/hooks/
# For repo-specific overrides, add a .pre-commit-config.yaml to the repo

# Skip if gitleaks is not installed
if ! command -v gitleaks &> /dev/null; then
  exit 0
fi

# Skip if repo has its own pre-commit config (pre-commit framework handles it)
if [[ -f .pre-commit-config.yaml ]]; then
  exit 0
fi

# Scan only staged changes (fast, minimal friction)
gitleaks protect --staged --verbose 2>&1
exit_code=$?

if [[ $exit_code -ne 0 ]]; then
  echo ""
  echo "WARNING: Potential secrets detected in staged changes."
  echo "Review the findings above. If these are false positives:"
  echo "  - Add '# gitleaks:allow' inline comment"
  echo "  - Or use SKIP=gitleaks git commit (use sparingly)"
  echo ""
fi

# Pre-commit: warn only (exit 0 regardless)
# Per user decision: warn on commit, block on push
exit 0
```

Step 3 — Create `pre-push` hook (blocking for global use):

```bash
#!/bin/bash
# Global pre-push hook - blocks pushes containing detected secrets
# Deployed by chezmoi to ~/.config/git/hooks/

# Skip if gitleaks is not installed
if ! command -v gitleaks &> /dev/null; then
  exit 0
fi

# Skip if repo has its own pre-commit config (pre-commit framework handles it)
if [[ -f .pre-commit-config.yaml ]]; then
  exit 0
fi

# Scan staged/committed changes about to be pushed
gitleaks protect --staged --verbose 2>&1
exit_code=$?

if [[ $exit_code -ne 0 ]]; then
  echo ""
  echo "BLOCKED: Potential secrets detected. Push aborted."
  echo "Review the findings above. If these are false positives:"
  echo "  - Add '# gitleaks:allow' inline comment to the source file"
  echo "  - Or use SKIP=gitleaks git push (use sparingly)"
  echo ""
  exit 1
fi

exit 0
```

Step 4 — Add the hooks to chezmoi and make executable:

```bash
chezmoi add ~/.config/git/hooks/pre-commit
chezmoi add ~/.config/git/hooks/pre-push
```

Wait — the hooks don't exist at the target yet. Instead, create them in the chezmoi source directory directly, then apply.

Create files at:
- `~/.local/share/chezmoi/private_dot_config/git/hooks/pre-commit`
- `~/.local/share/chezmoi/private_dot_config/git/hooks/pre-push`

Note: git may use the directory from `init.hooksPath` or `core.hooksPath`. Check if git is configured to use `~/.config/git/hooks/`:

```bash
git config --global core.hooksPath
```

If not set, configure it via the dot_gitconfig file or set it globally:
```bash
git config --global core.hooksPath "~/.config/git/hooks"
```

Actually, do NOT set core.hooksPath globally — this would OVERRIDE repo-local hooks (including the pre-commit framework in the dotfiles repo). Instead, use the XDG default. Git looks for hooks in `$XDG_CONFIG_HOME/git/hooks/` automatically when `core.hooksPath` is not set AND no `.git/hooks/` exist in the repo.

CORRECTION: Actually, Git does NOT automatically use XDG hooks. The `core.hooksPath` must be set, OR hooks must be in `.git/hooks/`. For global hooks, the recommended approach is `core.hooksPath`.

BUT: setting `core.hooksPath` globally would break repos that use `pre-commit install` (which puts hooks in `.git/hooks/`). The dotfiles repo uses pre-commit.

SOLUTION: The global hooks should check if the repo has a `.git/hooks/pre-commit` file (installed by pre-commit framework) and skip if so. Set `core.hooksPath` to `~/.config/git/hooks`, and in each hook, check for and delegate to `.git/hooks/{hook}` if it exists:

Updated pre-commit hook:
```bash
#!/bin/bash
# Global pre-commit hook
# If repo has local hooks (e.g., from pre-commit framework), delegate to them
if [[ -x .git/hooks/pre-commit ]]; then
  exec .git/hooks/pre-commit "$@"
fi

# ... rest of global hook logic
```

Updated pre-push hook:
```bash
#!/bin/bash
# Global pre-push hook
if [[ -x .git/hooks/pre-push ]]; then
  exec .git/hooks/pre-push "$@"
fi

# ... rest of global hook logic
```

Wait, this creates a chicken-and-egg: if core.hooksPath points to global dir, Git won't look in .git/hooks/ at all. The delegation must be explicit.

FINAL APPROACH: Do NOT set core.hooksPath. Instead, use `init.templateDir` to copy hooks into new repos. For existing repos, the user can manually install. OR: use a simpler approach — create a chezmoi run_once script that sets up templateDir for new repos.

Actually, the SIMPLEST correct approach:

1. Set `core.hooksPath = ~/.config/git/hooks` in dot_gitconfig
2. In each global hook, check for `.git/hooks/{name}` and exec it if present (delegation)
3. In the dotfiles repo, `pre-commit install` puts hooks in `.git/hooks/` which the global hook delegates to

This works because:
- New repos: global hooks run (gitleaks scanning)
- Repos with pre-commit: global hook delegates to local .git/hooks/pre-commit
- Dotfiles repo: global hook delegates to pre-commit framework's hooks

Add `core.hooksPath = ~/.config/git/hooks` to `dot_gitconfig` under the `[core]` section.

Step 5 — Apply and verify:

```bash
chezmoi apply
ls -la ~/.config/git/hooks/
```

Test in a non-dotfiles repo:
```bash
cd /tmp && mkdir test-repo && cd test-repo && git init
echo "AKIAIOSFODNN7EXAMPLE" > test.txt  # fake AWS key
git add test.txt
git commit -m "test"  # should warn about potential secret
rm -rf /tmp/test-repo
```
  </action>
  <verify>
1. `ls -la ~/.config/git/hooks/pre-commit ~/.config/git/hooks/pre-push` — both exist and are executable
2. `git config --global core.hooksPath` — shows `~/.config/git/hooks`
3. Test in a temp repo: creating a commit with a fake secret triggers a warning
4. In the dotfiles repo: `cd ~/.local/share/chezmoi && git commit --allow-empty -m "test"` — runs pre-commit framework (not global hook)
  </verify>
  <done>Global git hooks deployed via chezmoi. Warn-on-commit, block-on-push behaviour active for all repos. Repos with pre-commit framework delegate correctly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all Phase 6 success criteria</name>
  <what-built>Complete Phase 6 security implementation: Bitwarden integration, age encryption, gitleaks pre-commit hooks, permission verification, and global git hooks.</what-built>
  <how-to-verify>
Verify all 5 ROADMAP success criteria:

**1. Secret templating from Bitwarden (SECU-01):**
```bash
cat ~/.gitconfig_local
# Should show name and email sourced from Bitwarden (not hardcoded in git)
grep -r "bitwarden" ~/.local/share/chezmoi/private_dot_gitconfig_local.tmpl
# Should show bitwarden template function calls
```

**2. Age encryption for sensitive files (SECU-02):**
```bash
ls ~/.local/share/chezmoi/private_dot_ssh/
# Should show encrypted_private_* files (age-encrypted SSH keys)
chezmoi diff ~/.ssh/id_rsa
# Should show no diff (decryption works)
```

**3. Secret leak prevention (SECU-03):**
```bash
cd ~/.local/share/chezmoi && pre-commit run --all-files
# Pre-commit hooks should run without blocking
git config --global core.hooksPath
# Should show ~/.config/git/hooks
ls ~/.config/git/hooks/
# Should show pre-commit and pre-push hooks
```

**4. Permission verification (SECU-04):**
```bash
chezmoi apply 2>&1 | grep -i "permission"
# Should show permission verification output
stat -f "%Lp" ~/.ssh/id_rsa
# Should return 600
cat ~/.local/state/chezmoi/permission-fixes.log
# Log file should exist
```

**5. Secret rotation workflow:**
```bash
# This is a process check, not a command:
# 1. Could you change email in Bitwarden > dotfiles/shared/git-config?
# 2. Run: chezmoi apply
# 3. Check: cat ~/.gitconfig_local (email should update)
# (Don't actually change it unless you want to test)
```

Open a new terminal and verify:
- Shell works correctly
- `chezmoi verify` passes
- `git commit` in a test repo triggers global hook
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Global git hooks exist and are executable at `~/.config/git/hooks/`
2. `core.hooksPath` configured in gitconfig
3. Global hooks delegate to repo-local hooks when present
4. All 5 ROADMAP success criteria verified
5. Shell works correctly in new terminal
</verification>

<success_criteria>
- Global git hooks deployed via chezmoi for all repos
- Warn-on-commit, block-on-push behaviour working
- All 5 Phase 6 ROADMAP success criteria pass
- User confirms security measures are working
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-secrets/06-05-SUMMARY.md`
</output>
