---
phase: 06-security-secrets
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - run_after_10-verify-permissions.sh.tmpl
autonomous: true

must_haves:
  truths:
    - "Every chezmoi apply automatically verifies and fixes sensitive file permissions"
    - "SSH private keys are 600, SSH config is 644, GnuPG private dir is 700"
    - "Cloud credential files (kube, gcloud, docker) are 600"
    - "Permission fixes are logged with timestamps to a persistent log file"
    - "Script works on both macOS (stat -f) and Linux (stat -c)"
  artifacts:
    - path: "~/.local/share/chezmoi/run_after_10-verify-permissions.sh.tmpl"
      provides: "Post-apply permission verification and auto-fix hook"
      min_lines: 40
      contains: "chmod"
  key_links:
    - from: "run_after_10-verify-permissions.sh.tmpl"
      to: "~/.ssh/*, ~/.gnupg/*, ~/.kube/config, ~/.config/age/*"
      via: "glob pattern matching for sensitive files"
      pattern: "SENSITIVE_FILES"
---

<objective>
Create a chezmoi post-apply hook that automatically verifies and fixes file permissions on sensitive files.

Purpose: Addresses SECU-04 — ensures SSH keys, git credentials, cloud provider configs, and other sensitive files always have correct permissions (600/700) after every `chezmoi apply`. Auto-fixes incorrect permissions and logs all changes.

Output: A `run_after_` script that runs on every `chezmoi apply`, checking and correcting permissions for all known sensitive file patterns.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-secrets/06-RESEARCH.md
@.planning/phases/06-security-secrets/06-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permission verification post-apply hook</name>
  <files>~/.local/share/chezmoi/run_after_10-verify-permissions.sh.tmpl</files>
  <action>
Create `run_after_10-verify-permissions.sh.tmpl` in the chezmoi source directory root (NOT in .chezmoiscripts/ — use the existing pattern of run scripts in the root like `run_once_after_cleanup-homebrew-runtimes.sh.tmpl`).

The script must:

1. Use `#!/bin/bash` with `set -euo pipefail`
2. Define SENSITIVE_FILES array with "path_pattern:permission" entries:
   - `$HOME/.ssh/id_*:600` (SSH private keys — glob catches id_rsa, id_ed25519, etc.)
   - `$HOME/.ssh/config:600` (SSH config — 600 not 644, macOS ssh requires this)
   - `$HOME/.ssh/authorized_keys:600`
   - `$HOME/.gnupg/private-keys-v1.d:700` (GPG private key directory)
   - `$HOME/.config/age/key-*.txt:600` (age private keys)
   - `$HOME/.kube/config:600` (Kubernetes config)
   - `$HOME/.aws/credentials:600` (AWS credentials)
   - `$HOME/.aws/config:644` (AWS config — not sensitive)
   - `$HOME/.docker/config.json:600` (Docker config with auth tokens)
   - `$HOME/.config/gcloud/application_default_credentials.json:600` (GCP credentials)
   - `$HOME/.netrc:600` (network credentials)
   - `$HOME/.git-credentials:600` (git credential store)
   - `$HOME/.gitconfig_local:600` (local git config with email — already private_ in chezmoi)

3. Create log directory and file: `$HOME/.local/state/chezmoi/permission-fixes.log`

4. Platform-specific stat function:
   - macOS: `stat -f "%Lp" "$file"`
   - Linux: `stat -c "%a" "$file"`
   - Use `$OSTYPE` detection (`darwin*` vs default)

5. For each entry, expand glob, skip non-existent files, skip directories when expecting file permissions (and vice versa), get current permissions, compare, and if different: log with ISO timestamp and fix with chmod. Print a message for each fix.

6. At the end, print "Permission verification complete" with log file path.

7. Wrap the template with `{{- if ne .chezmoi.os "windows" }}` / `{{- end }}` (skip on Windows, not relevant but defensive).

8. Use the `run_after_` prefix (not `run_once_after_`) so it runs on EVERY `chezmoi apply`, not just once. The "10-" prefix sets execution order after other scripts.

After creating the file, run `chezmoi apply` to verify the script executes without errors. Then check that SSH keys have correct permissions.
  </action>
  <verify>
1. `ls ~/.local/share/chezmoi/run_after_10-verify-permissions.sh.tmpl` — file exists
2. `chezmoi apply --verbose 2>&1 | grep -i permission` — shows permission verification output
3. `ls ~/.ssh/id_* 2>/dev/null | head -1 | xargs stat -f "%Lp" 2>/dev/null` — returns 600 for whichever SSH key exists (id_rsa, id_ed25519, etc.)
4. `stat -f "%Lp" ~/.kube/config 2>/dev/null` — returns 600 (if file exists)
5. `cat ~/.local/state/chezmoi/permission-fixes.log 2>/dev/null` — log file exists (may be empty if all permissions were already correct)
  </verify>
  <done>Permission verification script runs on every `chezmoi apply`, automatically correcting any incorrect permissions on sensitive files with full audit logging.</done>
</task>

<task type="auto">
  <name>Task 2: Audit chezmoi source for missing private_ prefixes</name>
  <files>~/.local/share/chezmoi (audit only, modify if needed)</files>
  <action>
Audit the chezmoi source directory to ensure all sensitive files use the `private_` prefix for proper 600 permissions at apply time.

Check the following:
1. `private_dot_gitconfig_local.tmpl` — already has `private_` prefix (confirmed from prior phases). Good.
2. `private_dot_config/` — already has `private_` prefix. Good.
3. Check if any files that SHOULD be private are missing the prefix. Look for:
   - Any `.tmpl` files that will contain secrets from Bitwarden (these will be created in Plan 04, but note any existing candidates)
   - SSH config files if they are managed by chezmoi

Review the existing `dot_zsh.d/ssh.zsh` — it contains `ssh-add --apple-load-keychain` which is fine (not a secret, just a command).

Review `dot_zsh.d/variables.zsh` — check for any hardcoded API keys or tokens. If found, document them as candidates for Bitwarden migration in Plan 04.

Review `dot_gitconfig` — check for any credentials. The credential helper line `helper = /usr/local/share/gcm-core/git-credential-manager` is a path reference, not a secret — fine.

Document findings: list any files that need Bitwarden migration (for Plan 04) and any files that need `private_` prefix added.

If any files need the `private_` prefix added NOW (not depending on future plans), rename them using `chezmoi source-path` and `mv` in the source directory.
  </action>
  <verify>
1. No files in chezmoi source contain hardcoded secrets (API keys, tokens, passwords)
2. All files managing sensitive data use `private_` prefix
3. Findings documented for downstream plans
  </verify>
  <done>Chezmoi source audited for security. All sensitive files use private_ prefix. Any secrets needing Bitwarden migration are identified and documented for Plan 04.</done>
</task>

</tasks>

<verification>
1. `chezmoi apply` runs without errors and includes permission verification output
2. SSH keys have 600 permissions
3. Log file exists at `~/.local/state/chezmoi/permission-fixes.log`
4. No hardcoded secrets found in chezmoi source files
</verification>

<success_criteria>
- Permission verification script runs automatically on every `chezmoi apply`
- All defined sensitive file patterns are checked and auto-fixed
- Fixes are logged with timestamps
- Script works cross-platform (macOS stat vs Linux stat)
- Chezmoi source files audited; sensitive files use private_ prefix
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-secrets/06-02-SUMMARY.md`
</output>
