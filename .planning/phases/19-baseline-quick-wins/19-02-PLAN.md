---
phase: 19-baseline-quick-wins
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - dot_zsh.d/hooks.zsh
  - dot_zsh.d/completions.zsh
  - dot_zsh.d/intelli-shell.zsh
  - dot_zsh.d/carapace.zsh
  - dot_zsh.d/atuin.zsh
  - dot_zsh.d/keybinds.zsh
  - dot_zsh.d/functions.zsh
  - dot_zshenv
autonomous: true

must_haves:
  truths:
    - "No duplicate plugin loads exist in hooks.zsh"
    - "SSH config parsing uses pure-zsh, not Ruby"
    - "All startup-time command existence checks use (( $+commands[tool] ))"
    - "PATH and FPATH are automatically deduplicated"
    - "Post-change measurements show improvement over baseline"
  artifacts:
    - path: "dot_zsh.d/hooks.zsh"
      provides: "Shell hooks without duplicate plugin loads"
    - path: "dot_zsh.d/completions.zsh"
      provides: "Completions with pure-zsh SSH parsing and idiomatic command checks"
    - path: "dot_zshenv"
      provides: "PATH/FPATH deduplication via typeset -U"
  key_links:
    - from: "dot_zsh.d/completions.zsh"
      to: "$HOME/.ssh/config"
      via: "pure-zsh parameter expansion"
      pattern: "\\$\\{\\(M\\).*:#Host"
---

<objective>
Apply four zero-risk quick wins to reduce shell startup time, then re-measure to validate savings.

Purpose: These changes eliminate known waste (duplicate loads, external interpreter calls, subshell spawns) with no architectural risk, targeting ~100-150ms improvement.
Output: Modified chezmoi source files with optimisations applied, post-change measurements confirming improvement.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-baseline-quick-wins/19-RESEARCH.md
@.planning/phases/19-baseline-quick-wins/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply quick wins QUICK-01 through QUICK-04</name>
  <files>
    dot_zsh.d/hooks.zsh
    dot_zsh.d/completions.zsh
    dot_zsh.d/intelli-shell.zsh
    dot_zsh.d/carapace.zsh
    dot_zsh.d/atuin.zsh
    dot_zsh.d/keybinds.zsh
    dot_zsh.d/functions.zsh
    dot_zshenv
  </files>
  <action>
All edits are in chezmoi source at `~/.local/share/chezmoi/`. After editing, run `chezmoi apply` to deploy.

**QUICK-01: Remove duplicate plugin loads from hooks.zsh**

Delete lines 19-20 from `dot_zsh.d/hooks.zsh`:
```zsh
if [ -r "$HOMEBREW_PREFIX/opt/zsh-autosuggestions/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then source "$HOMEBREW_PREFIX/opt/zsh-autosuggestions/share/zsh-autosuggestions/zsh-autosuggestions.zsh"; fi
if [ -r "$HOMEBREW_PREFIX/opt/zsh-syntax-highlighting/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]; then source "$HOMEBREW_PREFIX/opt/zsh-syntax-highlighting/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"; fi
```

These are already loaded via Sheldon with `apply = ["defer"]`. The synchronous loads are pure waste.

Also replace `command -v oh-my-posh > /dev/null` on line 11 with `(( $+commands[oh-my-posh] ))`:
```zsh
if (( $+commands[oh-my-posh] )); then eval "$(oh-my-posh init zsh --config ~/.config/oh-my-posh.omp.json)"; fi
```

**QUICK-02: Replace Ruby SSH config parsing in completions.zsh**

Replace line 16:
```zsh
_cache_hosts=(`ruby -ne 'if /^Host\s+(.+)$/; print $1.strip, "\n"; end' $HOME/.ssh/config`)
```

With pure-zsh:
```zsh
_cache_hosts=()
if [[ -r $HOME/.ssh/config ]]; then
  _cache_hosts=(${${${(M)${(f)"$(<$HOME/.ssh/config)"}:#Host *}#Host }:#*[*?]*})
fi
```

Also replace `command -v phantom > /dev/null 2>&1` on line 49 with `(( $+commands[phantom] ))`.

**QUICK-03: Replace command -v with (( $+commands[tool] )) across files**

Files and specific replacements (startup-time guards only, NOT runtime checks in aliases.zsh):

1. `dot_zsh.d/intelli-shell.zsh` line 5:
   `if command -v intelli-shell > /dev/null; then` -> `if (( $+commands[intelli-shell] )); then`

2. `dot_zsh.d/carapace.zsh` line 5:
   `if command -v carapace > /dev/null; then` -> `if (( $+commands[carapace] )); then`

3. `dot_zsh.d/atuin.zsh` line 5:
   `if command -v atuin > /dev/null; then` -> `if (( $+commands[atuin] )); then`

4. `dot_zsh.d/keybinds.zsh` line 16:
   `if command -v abbr >/dev/null; then` -> `if (( $+commands[abbr] )); then`

5. `dot_zsh.d/functions.zsh` line 287:
   `if command -v fd >/dev/null 2>&1; then` -> `if (( $+commands[fd] )); then`

Do NOT change `dot_zsh.d/aliases.zsh` lines 105, 108, 111 -- these are run-time alias definitions using `command -v` as a conditional, and the pattern is different (`command -v X || alias`). Leave them as-is per research guidance.

**QUICK-04: Add PATH deduplication to .zshenv**

Add `typeset -U PATH path FPATH fpath` near the top of `dot_zshenv`, right after the header comments (before any functions or PATH modifications):
```zsh
# Ensure PATH and FPATH entries are unique
typeset -U PATH path FPATH fpath
```

After all edits, run `chezmoi apply` to deploy changes to the home directory.
  </action>
  <verify>
- `grep -n 'zsh-autosuggestions\|zsh-syntax-highlighting' ~/.zsh.d/hooks.zsh` returns only the deleted/commented lines (none)
- `grep -n 'ruby' ~/.zsh.d/completions.zsh` returns nothing
- `grep -rn 'command -v' ~/.zsh.d/` returns only aliases.zsh lines (105, 108, 111) and the commented direnv line
- `grep -n 'typeset -U' ~/.zshenv` shows the deduplication line
- Open a new terminal -- shell starts without errors, autosuggestions and syntax highlighting still work (via Sheldon defer)
  </verify>
  <done>All four quick wins applied and deployed via chezmoi. No startup errors. Plugins still functional via Sheldon.</done>
</task>

<task type="auto">
  <name>Task 2: Re-measure with three-stage methodology and document improvement</name>
  <files></files>
  <action>
Run the same three-stage measurement as Plan 01:

1. Stage 1 -- hyperfine: `hyperfine --warmup 3 --runs 10 'zsh -i -c exit'`
2. Stage 2 -- EPOCHREALTIME profiling (same approach as baseline)
3. Stage 3 -- zsh-bench: `~/zsh-bench/zsh-bench`

Compare results with baseline from 19-01-SUMMARY.md:
- Calculate absolute and percentage improvement for hyperfine mean
- Note which bottlenecks changed in EPOCHREALTIME top-20
- Compare zsh-bench first_prompt_lag_ms, command_lag_ms, input_lag_ms

Document the delta clearly in the SUMMARY: "Before: Xms -> After: Yms (Z% improvement)".

Expected improvement: ~100-150ms (primarily from removing duplicate plugin loads and Ruby SSH parsing).
  </action>
  <verify>
- hyperfine produces a mean lower than the baseline
- zsh-bench first_prompt_lag_ms is lower than baseline
- Shell is fully functional (test: autosuggestions appear, syntax highlighting works, SSH tab completion works, oh-my-posh prompt renders)
  </verify>
  <done>Post-change measurements documented showing improvement over baseline. Delta calculated and recorded in SUMMARY for comparison in later phases.</done>
</task>

</tasks>

<verification>
- All quick wins applied to chezmoi source files
- `chezmoi apply` succeeds without errors
- New shell starts without errors
- Autosuggestions, syntax highlighting, SSH completions all functional
- Post-change measurements show improvement over Plan 01 baseline
- No `command -v` in startup-time guards (only aliases.zsh runtime checks remain)
</verification>

<success_criteria>
Four quick wins applied and validated. Post-change hyperfine mean is at least 50ms lower than baseline. Shell functionality fully preserved. Results documented for Phase 20 comparison.
</success_criteria>

<output>
After completion, create `.planning/phases/19-baseline-quick-wins/19-02-SUMMARY.md`
</output>
