---
phase: 11-claude-code
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.local/share/chezmoi/.chezmoiignore
  - ~/.local/share/chezmoi/private_dot_claude/settings.json
  - ~/.local/share/chezmoi/private_dot_claude/CLAUDE.md
  - ~/.local/share/chezmoi/private_dot_claude/agents/
  - ~/.local/share/chezmoi/private_dot_claude/commands/
  - ~/.local/share/chezmoi/private_dot_claude/skills/
autonomous: true

must_haves:
  truths:
    - "Claude Code commands and skills sync across machines via chezmoi apply"
    - "Local settings (settings.local.json) never appear in chezmoi managed output"
    - "Cache and temporary files (cache/, debug/, downloads/, history.jsonl, etc.) excluded from chezmoi tracking"
    - "chezmoi managed shows only synced .claude files (settings.json, CLAUDE.md, agents/, commands/, skills/)"
  artifacts:
    - path: "~/.local/share/chezmoi/.chezmoiignore"
      provides: "Phase 11 Claude Code exclusion block replacing Phase 11 pending block"
      contains: ".claude/cache"
    - path: "~/.local/share/chezmoi/private_dot_claude/settings.json"
      provides: "Claude Code global settings (synced)"
    - path: "~/.local/share/chezmoi/private_dot_claude/CLAUDE.md"
      provides: "Claude Code global instructions (synced)"
    - path: "~/.local/share/chezmoi/private_dot_claude/agents/"
      provides: "Claude Code agent definitions (12 files)"
    - path: "~/.local/share/chezmoi/private_dot_claude/commands/"
      provides: "Claude Code custom commands (32 files including gsd/ subdir)"
    - path: "~/.local/share/chezmoi/private_dot_claude/skills/"
      provides: "Claude Code skills (commit-message/SKILL.md)"
  key_links:
    - from: "~/.local/share/chezmoi/.chezmoiignore"
      to: "chezmoi managed output"
      via: "exclusion patterns filtering .claude local state"
      pattern: "\\.claude/(cache|debug|downloads|session-env)"
    - from: "~/.local/share/chezmoi/private_dot_claude/"
      to: "~/.claude/"
      via: "chezmoi apply deploys synced files"
      pattern: "private_dot_claude"
---

<objective>
Migrate Claude Code synced configs to chezmoi with local state exclusion

Purpose: Add .claude/ directory selective sync to chezmoi -- sync agents, commands, skills, settings.json, and CLAUDE.md across machines while excluding ~85MB of cache/state/runtime files via .chezmoiignore patterns. This is a REVERSED migration order: exclusions MUST be in .chezmoiignore BEFORE adding any files to chezmoi source.

Output: All 48 synced Claude Code files in chezmoi source, .chezmoiignore updated with ~20 exclusion patterns for local state directories.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-claude-code/11-RESEARCH.md
@.planning/phases/09-terminal-emulators/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update .chezmoiignore with Claude Code exclusions and remove pending block</name>
  <files>~/.local/share/chezmoi/.chezmoiignore</files>
  <action>
CRITICAL: This task MUST complete BEFORE Task 2. The exclusion-first order prevents 85MB+ of cache/state from being tracked.

Edit `~/.local/share/chezmoi/.chezmoiignore`:

1. **Remove the Phase 11 pending block** (Section 9, lines ~132-136). Delete these lines:
```
# -----------------------------------------------------------------------------
# 9. Pending Migration — Phase 11 (Claude Code)
# Remove these entries when Phase 11 migrates them to chezmoi.
# -----------------------------------------------------------------------------
.claude
.claude/**
```

2. **Add new Phase 11 exclusion block** in the same location (Section 9). This replaces the pending block with specific exclusions that allow synced files through while blocking local state:

```
# -----------------------------------------------------------------------------
# 9. Claude Code Local State (NEVER sync)
# Only sync: settings.json, CLAUDE.md, agents/, commands/, skills/
# All else is machine-local state (history, cache, session data, plugins)
# -----------------------------------------------------------------------------

# Local settings override (machine-specific, never sync)
.claude/settings.local.json

# Cache and temporary files
.claude/cache
.claude/cache/**
.claude/debug
.claude/debug/**
.claude/downloads
.claude/downloads/**
.claude/paste-cache
.claude/paste-cache/**

# Session and runtime state
.claude/session-env
.claude/session-env/**
.claude/shell-snapshots
.claude/shell-snapshots/**
.claude/file-history
.claude/file-history/**

# Local data files
.claude/history.jsonl
.claude/__store.db
.claude/stats-cache.json
.claude/gsd-file-manifest.json

# User-generated content (local)
.claude/plans
.claude/plans/**
.claude/todos
.claude/todos/**
.claude/transcripts
.claude/transcripts/**
.claude/tasks
.claude/tasks/**

# Plugins and extensions (managed by Claude Code)
.claude/plugins
.claude/plugins/**

# System directories
.claude/statsig
.claude/statsig/**
.claude/telemetry
.claude/telemetry/**
.claude/hooks
.claude/hooks/**
.claude/ide
.claude/ide/**
.claude/local
.claude/local/**

# GSD framework (managed outside dotfiles)
.claude/get-shit-done
.claude/get-shit-done/**

# Projects directory (project-specific state)
.claude/projects
.claude/projects/**
```

3. Keep Section 10 (Deprecated) and Section 11 (Development/Temporary) unchanged. Renumber if necessary so sections flow: 9 (Claude Code Local State) -> 10 (Deprecated) -> 11 (Development/Temporary).
  </action>
  <verify>
Run these checks:
1. `grep -c "^.claude" ~/.local/share/chezmoi/.chezmoiignore` — should show ~30+ exclusion lines (not 2 like the old pending block)
2. `grep "Pending Migration" ~/.local/share/chezmoi/.chezmoiignore` — should return nothing (pending block removed)
3. `grep "Claude Code Local State" ~/.local/share/chezmoi/.chezmoiignore` — should match the new section header
4. Verify .chezmoiignore has no syntax errors: `chezmoi managed --include=files > /dev/null 2>&1` — should succeed without errors
  </verify>
  <done>Phase 11 pending block removed and replaced with specific .claude local state exclusions. chezmoi managed runs without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add Claude Code synced files to chezmoi source and deploy</name>
  <files>
~/.local/share/chezmoi/private_dot_claude/settings.json
~/.local/share/chezmoi/private_dot_claude/CLAUDE.md
~/.local/share/chezmoi/private_dot_claude/agents/
~/.local/share/chezmoi/private_dot_claude/commands/
~/.local/share/chezmoi/private_dot_claude/skills/
  </files>
  <action>
PREREQUISITE: Task 1 must be complete (exclusions in .chezmoiignore before adding files).

Add all synced Claude Code files to chezmoi source. The current files at `~/.claude/` are symlinks pointing to `~/Projects/dotfiles-zsh/.config/claude/`. Use `chezmoi add --follow` to resolve symlinks and copy real content.

**Step 1: Add individual files (symlinks to real files)**
```bash
chezmoi add --follow ~/.claude/settings.json
chezmoi add --follow ~/.claude/CLAUDE.md
```

**Step 2: Add directories**
For directories, `chezmoi add --follow` may fail with "follow and recursive are mutually exclusive" error (known Phase 8-10 limitation). Use the proven manual cp -L workaround:

```bash
# Create target directories in chezmoi source
mkdir -p ~/.local/share/chezmoi/private_dot_claude/agents
mkdir -p ~/.local/share/chezmoi/private_dot_claude/commands/gsd
mkdir -p ~/.local/share/chezmoi/private_dot_claude/skills/commit-message

# Copy with symlink resolution
cp -L ~/Projects/dotfiles-zsh/.config/claude/agents/*.md ~/.local/share/chezmoi/private_dot_claude/agents/
cp -L ~/Projects/dotfiles-zsh/.config/claude/commands/*.md ~/.local/share/chezmoi/private_dot_claude/commands/
cp -L ~/Projects/dotfiles-zsh/.config/claude/commands/gsd/*.md ~/.local/share/chezmoi/private_dot_claude/commands/gsd/
cp -L ~/Projects/dotfiles-zsh/.config/claude/skills/commit-message/SKILL.md ~/.local/share/chezmoi/private_dot_claude/skills/commit-message/
```

Note: Do NOT add `statusline-command.sh` from `.config/claude/` -- it is not currently symlinked to `~/.claude/` by Dotbot (check terminal.yml confirms only CLAUDE.md, settings.json, agents, commands, skills are symlinked). Only migrate what Dotbot currently manages.

**Step 3: Deploy with targeted --force flag**
Apply only the Phase 11 files to bypass Bitwarden auth gate (proven Phase 8-10 pattern):
```bash
chezmoi apply --force ~/.claude/settings.json ~/.claude/CLAUDE.md ~/.claude/agents ~/.claude/commands ~/.claude/skills
```

**Step 4: Verify chezmoi source and managed state**
```bash
# Verify files in chezmoi source
ls ~/.local/share/chezmoi/private_dot_claude/

# Verify managed files (should show ONLY synced files, not cache/state)
chezmoi managed --include=files | grep "\.claude"

# Verify exclusions working (cache, debug, etc. should NOT appear)
chezmoi managed --include=files | grep -E "\.claude/(cache|debug|downloads|history|session)" && echo "FAIL: local state files in managed output" || echo "PASS: local state excluded"

# Count managed .claude files (should be ~48 files: 12 agents + 32 commands + 1 skill + settings.json + CLAUDE.md = ~48)
chezmoi managed --include=files | grep "\.claude" | wc -l
```
  </action>
  <verify>
Run these checks:
1. `chezmoi managed --include=files | grep "\.claude/settings.json"` — should match
2. `chezmoi managed --include=files | grep "\.claude/CLAUDE.md"` — should match
3. `chezmoi managed --include=files | grep "\.claude/agents/"` — should show 12 agent files
4. `chezmoi managed --include=files | grep "\.claude/commands/"` — should show command files including gsd/ subdir
5. `chezmoi managed --include=files | grep "\.claude/skills/"` — should show commit-message/SKILL.md
6. `chezmoi managed --include=files | grep -E "\.claude/(cache|debug|downloads|history\.jsonl|__store\.db|session-env)" | wc -l` — should be 0 (none tracked)
7. `chezmoi diff` — should complete quickly (verify no unexpected diffs)
  </verify>
  <done>All 48 Claude Code synced files added to chezmoi source and deployed. chezmoi managed shows only synced files (settings.json, CLAUDE.md, agents/, commands/, skills/). No cache/state files tracked.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Synced files in chezmoi source:** `ls ~/.local/share/chezmoi/private_dot_claude/` shows settings.json, CLAUDE.md, agents/, commands/, skills/
2. **Managed count:** `chezmoi managed --include=files | grep "\.claude" | wc -l` shows ~48 files (not hundreds)
3. **Exclusions working:** `chezmoi managed --include=files | grep -E "\.claude/(cache|debug|downloads|session-env|history)" | wc -l` shows 0
4. **settings.local.json excluded:** `chezmoi managed --include=files | grep "settings.local.json" | wc -l` shows 0
5. **No .chezmoiignore errors:** `chezmoi managed > /dev/null 2>&1` succeeds
6. **Deploy works:** `chezmoi apply --force ~/.claude/settings.json` succeeds without error
</verification>

<success_criteria>
- All 48 Claude Code synced files (agents, commands, skills, settings.json, CLAUDE.md) in chezmoi source
- .chezmoiignore Phase 11 pending block removed and replaced with ~30 specific exclusion lines
- No cache/state/runtime files tracked by chezmoi
- chezmoi managed shows only synced .claude files
- chezmoi diff completes without unexpected changes
</success_criteria>

<output>
After completion, create `.planning/phases/11-claude-code/11-01-SUMMARY.md`
</output>
