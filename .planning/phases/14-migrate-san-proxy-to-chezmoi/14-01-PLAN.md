---
phase: 14-migrate-san-proxy-to-chezmoi
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dot_zshrc.tmpl
  - .config/profile
autonomous: true

must_haves:
  truths:
    - "Client machines source san-proxy.sh on shell startup"
    - "Personal machines do NOT source san-proxy.sh on shell startup"
    - "san-proxy sourcing is removed from legacy .config/profile"
  artifacts:
    - path: "dot_zshrc.tmpl"
      provides: "Templated zshrc with client-only san-proxy conditional"
      contains: 'eq .machine_type "client"'
  key_links:
    - from: "dot_zshrc.tmpl"
      to: ".chezmoi.yaml.tmpl"
      via: "machine_type template variable"
      pattern: '\\.machine_type'
---

<objective>
Migrate san-proxy sourcing to chezmoi with client-only template conditional.

Purpose: san-proxy is a work-only network proxy script. It should only be sourced on client machines, not personal ones. Currently it's sourced unconditionally in both chezmoi's dot_zshrc and legacy .config/profile.

Output: Templated dot_zshrc.tmpl with client-only san-proxy block; legacy .config/profile cleaned up.
</objective>

<execution_context>
@/Users/stephanlv_fanaka/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stephanlv_fanaka/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Template zshrc with client-only san-proxy and clean up legacy profile</name>
  <files>
    ~/.local/share/chezmoi/dot_zshrc -> ~/.local/share/chezmoi/dot_zshrc.tmpl
    .config/profile
  </files>
  <action>
1. In the chezmoi source directory (~/.local/share/chezmoi), rename `dot_zshrc` to `dot_zshrc.tmpl` to enable templating.

2. In the new `dot_zshrc.tmpl`, wrap the san-proxy block (lines 23-26) with a chezmoi template conditional for client machines only:

```
{{- if eq .machine_type "client" }}
# === san-proxy (work network proxy) ===
if [ -f "$HOME/.bin/san-proxy.sh" ]; then
    . "$HOME/.bin/san-proxy.sh"
fi
{{- end }}
```

Keep the rest of the file unchanged. The header comment should stay as-is (no template syntax needed in the comment).

3. In the dotfiles repo `.config/profile`, remove the san-proxy sourcing block (lines 2-4):
```
if [ -f "$HOME/.bin/san-proxy.sh" ]; then
    . "$HOME/.bin/san-proxy.sh"
fi
```

4. Run `chezmoi apply --dry-run --verbose ~/.zshrc` to verify the template renders correctly.

5. Run `chezmoi apply ~/.zshrc` to apply the change.
  </action>
  <verify>
- `chezmoi cat ~/.zshrc` shows san-proxy block present (if machine_type=client) or absent (if machine_type=personal)
- `grep san-proxy .config/profile` returns no matches
- `chezmoi verify` exits 0
  </verify>
  <done>
- dot_zshrc.tmpl exists with client-only san-proxy template conditional using .machine_type
- Legacy .config/profile no longer contains san-proxy sourcing
- chezmoi apply succeeds without errors
  </done>
</task>

</tasks>

<verification>
1. `chezmoi cat ~/.zshrc | grep -A3 san-proxy` — shows block on client, empty on personal
2. `grep san-proxy .config/profile` — no matches
3. `chezmoi doctor` — no errors
</verification>

<success_criteria>
- san-proxy sourcing managed exclusively by chezmoi with client-only conditional
- Legacy .config/profile no longer references san-proxy
- Template uses existing .machine_type data variable from .chezmoi.yaml.tmpl
</success_criteria>

<output>
After completion, create `.planning/phases/14-migrate-san-proxy-to-chezmoi/14-01-SUMMARY.md`
</output>
